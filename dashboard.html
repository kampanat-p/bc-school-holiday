<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BC Dashboard</title>
  
  <!-- CSS & Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Vis Timeline (Load from unpkg) -->
  <script type="text/javascript" src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script>
  <link href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
    body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
    
    .tab-btn { flex:1; py:3; text-align:center; font-size:14px; color:#64748b; border-bottom:3px solid transparent; }
    .tab-active { border-bottom-color:#16a34a; color:#16a34a; font-weight:bold; }
    
    /* Timeline Styles */
    .vis-item { border-radius: 4px; font-size: 11px; }
    .vis-item.item-normal { background-color: #dcfce7; border-color: #86efac; color: #166534; }
    .vis-item.item-cover { background-color: #fef9c3; border-color: #fde047; color: #854d0e; }
    .vis-item.item-absent { background-color: #fee2e2; border-color: #fca5a5; opacity: 0.5; } /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏ô‡∏•‡∏≤ */
    .vis-label { font-size: 12px; }
  </style>
</head>
<body class="pb-20">

  <!-- Header -->
  <div class="bg-slate-800 text-white p-4 sticky top-0 z-50 shadow-md">
    <div class="flex justify-between items-center">
      <h1 class="text-lg font-bold"><i class="fas fa-chart-pie mr-2"></i>BC Dashboard</h1>
      <span class="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300" id="dateDisplay">Loading...</span>
    </div>
  </div>

  <!-- Loading Box -->
  <div id="statusBox" class="p-4 hidden"></div>

  <!-- Tabs Navigation -->
  <div id="mainContent" class="hidden">
    <div class="flex bg-white shadow-sm sticky top-14 z-40">
      <button onclick="switchTab('schedule')" id="tab-schedule" class="tab-btn tab-active">
        <i class="fas fa-list mr-1"></i> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á
      </button>
      <button onclick="switchTab('timeline')" id="tab-timeline" class="tab-btn">
        <i class="fas fa-stream mr-1"></i> Timeline
      </button>
      <button onclick="switchTab('absence')" id="tab-absence" class="tab-btn">
        <i class="fas fa-user-slash mr-1"></i> ‡∏Ñ‡∏ô‡∏•‡∏≤
      </button>
      <button onclick="switchTab('cancel')" id="tab-cancel" class="tab-btn">
        <i class="fas fa-history mr-1"></i> Log
      </button>
    </div>

    <!-- 1. Schedule View -->
    <div id="view-schedule" class="p-4">
      <!-- Filter -->
      <div class="bg-white p-3 rounded-lg shadow-sm mb-3">
        <label class="text-xs font-bold text-gray-500">FILTER:</label>
        <div class="flex gap-2 mt-2">
           <button onclick="setFilterMode('teacher')" id="btn-f-teacher" class="flex-1 border rounded text-xs py-1 bg-green-100 border-green-500 text-green-800">Teacher</button>
           <button onclick="setFilterMode('school')" id="btn-f-school" class="flex-1 border rounded text-xs py-1">School</button>
           <button onclick="setFilterMode('coord')" id="btn-f-coord" class="flex-1 border rounded text-xs py-1">Coord.</button>
        </div>
        <select id="filterSelect" class="w-full mt-3 p-2 border rounded text-sm" onchange="applyFilter()">
          <option value="all">-- All --</option>
        </select>
      </div>
      <div id="scheduleList" class="space-y-2"></div>
    </div>

    <!-- 2. Timeline View -->
    <div id="view-timeline" class="hidden p-2 bg-white h-screen">
      <div id="timeline-container" style="width: 100%; height: 500px;"></div>
      <p class="text-xs text-center text-gray-400 mt-2">*‡πÉ‡∏ä‡πâ‡∏ô‡∏¥‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ / ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ</p>
    </div>

    <!-- 3. Absence View -->
    <div id="view-absence" class="hidden p-4">
      <h2 class="text-sm font-bold text-slate-700 mb-3">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
      <div id="absenceList" class="space-y-3"></div>
    </div>

    <!-- 4. Cancel Log View -->
    <div id="view-cancel" class="hidden p-4">
      <h2 class="text-sm font-bold text-slate-700 mb-3">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</h2>
      <div id="cancelList" class="space-y-3"></div>
    </div>
  </div>

  <script>
    // ‚öôÔ∏è ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Apps Script
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycby1XtF08bcbNqD98iwOWtDCOwDRz-6xP1b5l4VoJXIo85FcCg9nJvXZXrUkUlh4rxndgQ/exec"; 

    let rawData = {};
    let currentFilterMode = 'teacher';
    let timelineInstance = null;

    window.onload = async () => {
      const today = new Date();
      document.getElementById('dateDisplay').innerText = today.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
      
      showStatus("loading", "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà");

      try {
        // Fetch Dashboard Data
        const resDash = await fetch(`${GAS_API_URL}?action=getDashboardData`);
        const jsonDash = await resDash.json();
        if (jsonDash.error) throw new Error(jsonDash.message);
        rawData = jsonDash;

        // Init Views
        document.getElementById('statusBox').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
        setFilterMode('teacher');
        renderCancellations();
        
        // Lazy Load other tabs data
        fetchAbsenceData();

      } catch (err) {
        showStatus("error", "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err.message);
      }
    };

    function showStatus(type, msg) {
       const box = document.getElementById('statusBox');
       box.classList.remove('hidden');
       box.className = type === 'error' ? 'p-4 m-4 bg-red-100 text-red-700 rounded-lg border border-red-300 text-sm' : 'p-4 m-4 bg-blue-50 text-blue-700 rounded-lg text-center text-sm';
       box.innerHTML = msg;
    }

    // --- TAB SWITCHER ---
    function switchTab(tab) {
      // Hide all
      ['schedule', 'timeline', 'absence', 'cancel'].forEach(t => {
        document.getElementById('view-' + t).classList.add('hidden');
        document.getElementById('tab-' + t).classList.remove('tab-active');
      });
      
      // Show selected
      document.getElementById('view-' + tab).classList.remove('hidden');
      document.getElementById('tab-' + tab).classList.add('tab-active');

      // Specific Logic
      if (tab === 'timeline' && !timelineInstance) {
         fetchTimelineData();
      }
    }

    // --- TIMELINE LOGIC ---
    async function fetchTimelineData() {
        document.getElementById('timeline-container').innerHTML = '<div class="text-center pt-20 text-gray-400">Loading Timeline...</div>';
        try {
            const res = await fetch(`${GAS_API_URL}?action=getTimelineData`);
            const data = await res.json();
            renderTimeline(data);
        } catch(e) {
            document.getElementById('timeline-container').innerHTML = 'Error loading timeline';
        }
    }

    function renderTimeline(data) {
        document.getElementById('timeline-container').innerHTML = '';
        const container = document.getElementById('timeline-container');
        
        const groups = new vis.DataSet(data.groups);
        const items = new vis.DataSet(data.items);
        
        const options = {
            stack: false,
            start: new Date(data.date + 'T07:00:00'),
            end: new Date(data.date + 'T17:00:00'),
            editable: false,
            orientation: 'top',
            zoomMin: 1000 * 60 * 60, // 1 hour
            zoomMax: 1000 * 60 * 60 * 12, // 12 hours
            verticalScroll: true,
            height: '100%',
            groupHeightMode: 'fixed'
        };

        timelineInstance = new vis.Timeline(container, items, groups, options);
    }

    // --- ABSENCE LOGIC ---
    async function fetchAbsenceData() {
        try {
            const res = await fetch(`${GAS_API_URL}?action=getAbsenceData`);
            const data = await res.json();
            const list = document.getElementById('absenceList');
            list.innerHTML = "";
            
            if(data.length === 0) {
                list.innerHTML = `<div class="text-center py-10 text-gray-400">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏£‡∏π‡∏•‡∏≤</div>`;
                return;
            }

            data.forEach(a => {
                list.innerHTML += `
                  <div class="bg-white border-l-4 border-red-400 p-3 rounded shadow-sm flex justify-between items-center">
                    <div>
                        <div class="font-bold text-gray-800">${a.name} <span class="text-xs text-gray-500 font-normal">(${a.type})</span></div>
                        <div class="text-xs text-red-500 mt-1">${a.reason}</div>
                    </div>
                    <div class="text-xs font-mono bg-gray-100 px-2 py-1 rounded text-gray-600">${a.period}</div>
                  </div>`;
            });
        } catch(e) { console.error(e); }
    }

    // --- SCHEDULE & FILTER LOGIC ---
    function setFilterMode(mode) {
      currentFilterMode = mode;
      ['teacher', 'school', 'coord'].forEach(m => {
        document.getElementById('btn-f-' + m).className = (m === mode) 
          ? "flex-1 border rounded text-xs py-1 bg-green-100 border-green-500 text-green-800 font-bold"
          : "flex-1 border rounded text-xs py-1 text-gray-600";
      });

      const select = document.getElementById('filterSelect');
      select.innerHTML = '<option value="all">-- Show All --</option>';
      
      let items = [];
      if(mode === 'teacher') items = rawData.filters.teachers;
      if(mode === 'school') items = rawData.filters.schools;
      if(mode === 'coord') items = rawData.filters.coordinators;

      items.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item;
        opt.text = item;
        select.appendChild(opt);
      });
      applyFilter();
    }

    function applyFilter() {
      const val = document.getElementById('filterSelect').value;
      const list = document.getElementById('scheduleList');
      list.innerHTML = "";

      const filtered = rawData.sessions.filter(s => {
        if (val === 'all') return true;
        if (currentFilterMode === 'teacher') return s.teacher === val;
        if (currentFilterMode === 'school') return s.school === val;
        if (currentFilterMode === 'coord') return s.coordinator === val;
      });

      if (filtered.length === 0) {
        list.innerHTML = `<div class="text-center py-10 text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
        return;
      }

      filtered.forEach(s => {
        const isCover = s.status === 'Cover';
        const isCancel = s.status.includes('Cancel');
        
        let statusBadge = "";
        if(isCover) statusBadge = `<span class="bg-yellow-100 text-yellow-800 text-[10px] px-1 rounded ml-1">Sub</span>`;
        if(isCancel) statusBadge = `<span class="bg-red-100 text-red-800 text-[10px] px-1 rounded ml-1">Cancel</span>`;

        // Teacher Type Badge
        let typeBadge = "";
        if(s.teacherType === "Full-time") typeBadge = `<span class="text-[9px] bg-blue-100 text-blue-700 px-1 rounded ml-1 font-bold">FT</span>`;
        else if(s.teacherType === "Part-time") typeBadge = `<span class="text-[9px] bg-orange-100 text-orange-700 px-1 rounded ml-1 font-bold">PT</span>`;

        const html = `
          <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-100 mb-2 ${isCancel ? 'opacity-60 bg-gray-50' : ''}">
            <div class="flex justify-between items-start">
              <div>
                <div class="flex items-center">
                  <span class="font-bold text-gray-800">${s.school}</span>
                  <span class="text-xs bg-gray-100 text-gray-500 px-1 rounded ml-2">${s.class}</span>
                  ${statusBadge}
                </div>
                <div class="text-xs text-gray-500 mt-1">üïí ${s.time}</div>
                <div class="text-xs text-gray-700 mt-1 flex items-center">
                   üë§ ${s.teacher} ${typeBadge}
                </div>
              </div>
              <div class="text-[10px] text-gray-400 text-right">
                ${s.coordinator}<br>(Coord)
              </div>
            </div>
          </div>`;
        list.innerHTML += html;
      });
    }

    function renderCancellations() {
      const list = document.getElementById('cancelList');
      const cancels = rawData.cancellations;
      list.innerHTML = "";
      
      if(cancels.length === 0) {
        list.innerHTML = `<div class="text-center py-10 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤</div>`;
        return;
      }

      cancels.forEach(c => {
        list.innerHTML += `
          <div class="bg-white border-l-4 border-red-500 p-3 rounded shadow-sm">
            <div class="flex justify-between">
              <span class="font-bold text-red-600">${c.school}</span>
              <span class="text-[10px] text-gray-400">${new Date(c.time).toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'})}</span>
            </div>
            <div class="text-sm font-bold mt-1 text-gray-800">${c.type}</div>
            <div class="text-xs text-gray-600 bg-gray-50 p-2 rounded mt-1">${c.reason}</div>
            <div class="text-[10px] text-gray-400 mt-1 text-right">‡πÇ‡∏î‡∏¢: ${c.user}</div>
          </div>`;
      });
    }
  </script>
</body>
</html>

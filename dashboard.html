<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BC Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
    body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
    .tab-active { border-bottom: 3px solid #16a34a; color: #16a34a; font-weight: bold; }
    .tab-inactive { color: #64748b; }
    .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    
    /* Live Class Animation */
    @keyframes pulse-green {
      0% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.7); }
      70% { box-shadow: 0 0 0 6px rgba(22, 163, 74, 0); }
      100% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); }
    }
    @keyframes fade-live {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    .card-live {
      border: 2px solid #16a34a !important; /* Green-600 */
      animation: pulse-green 2s infinite;
    }
    .badge-live {
      background-color: #16a34a;
      color: white;
      font-size: 9px;
      padding: 1px 4px;
      border-radius: 4px;
      font-weight: bold;
      margin-left: 5px;
      vertical-align: middle;
      display: inline-block;
      animation: fade-live 1s infinite;
    }
  </style>
</head>
<body class="pb-20">

  <!-- Header -->
  <div class="bg-slate-800 text-white p-5 sticky top-0 z-50 shadow-md">
    <div class="flex justify-between items-center">
      <h1 class="text-lg font-bold">BC Dashboard <span class="text-[9px] font-normal text-slate-400 ml-1">v3.5 (Live Now)</span></h1>
      <div class="flex items-center gap-2">
         <button onclick="document.getElementById('debugPanel').classList.toggle('hidden')" class="text-xs bg-slate-600 px-2 py-1 rounded text-slate-300">üêû</button>
         <a href="timeline.html" target="_blank" class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 rounded transition no-underline flex items-center gap-1">
           <i class="fas fa-stream"></i> Timeline
         </a>
         <input type="date" id="datePicker" onchange="reloadDashboard()" class="text-xs bg-slate-700 border border-slate-500 text-white px-2 py-1 rounded focus:outline-none focus:border-green-400 font-sans">
      </div>
    </div>
    <!-- Absent Summary -->
    <div class="mt-3 text-xs text-red-200">
      <div class="flex items-center cursor-pointer bg-slate-700 p-2 rounded-lg hover:bg-slate-600 transition" onclick="openAbsentModal()">
        <i class="fas fa-user-slash mr-2 text-red-400"></i>
        <span class="flex-1">Absent Today: <b id="absentTotal" class="text-white">0</b></span>
        <div class="flex gap-2">
           <span class="bg-blue-900 text-blue-200 px-2 py-0.5 rounded text-[10px]">FT: <b id="countFT">0</b></span>
           <span class="bg-orange-900 text-orange-200 px-2 py-0.5 rounded text-[10px]">PT: <b id="countPT">0</b></span>
        </div>
        <i class="fas fa-chevron-right ml-2 text-[10px]"></i>
      </div>
    </div>
    
    <!-- Metrics Summary -->
    <div class="grid grid-cols-5 gap-2 mt-2 text-[10px] text-center">
      <div onclick="filterSessionBy('Live')" class="bg-indigo-900/40 p-1 rounded cursor-pointer hover:bg-indigo-800 border border-transparent hover:border-indigo-400 animate-pulse">
         <div class="text-indigo-200 font-bold">LIVE NOW</div>
         <div class="font-bold text-white text-xs" id="met-live">0</div>
      </div>
      <div onclick="filterSessionBy('Total')" class="bg-slate-700 p-1 rounded cursor-pointer hover:bg-slate-600 border border-transparent hover:border-slate-500">
         <div class="text-slate-400">Total</div>
         <div class="font-bold text-white text-xs" id="met-total">0</div>
      </div>
      <div onclick="filterSessionBy('Cover')" class="bg-slate-700 p-1 rounded cursor-pointer hover:bg-slate-600 border border-transparent hover:border-green-500">
         <div class="text-green-400">Covered</div>
         <div class="font-bold text-white text-xs" id="met-cover">0</div>
      </div>
      <div onclick="filterSessionBy('Cancelled (BC)')" class="bg-slate-700 p-1 rounded cursor-pointer hover:bg-slate-600 border border-transparent hover:border-red-500">
         <div class="text-red-400">Cancelled (BC)</div>
         <div class="font-bold text-white text-xs" id="met-bc">0</div>
      </div>
      <div onclick="filterSessionBy('Cancelled (School)')" class="bg-slate-700 p-1 rounded cursor-pointer hover:bg-slate-600 border border-transparent hover:border-orange-500">
         <div class="text-orange-400">Cancelled (School)</div>
         <div class="font-bold text-white text-xs" id="met-sch">0</div>
      </div>
    </div>
  </div>

  <!-- Absent Modal (Full Screen) -->
  <div id="absentModal" class="fixed inset-0 z-[100] hidden">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black bg-opacity-80 backdrop-blur-sm" onclick="closeAbsentModal()"></div>
    
    <!-- Modal Content -->
    <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl h-[80vh] flex flex-col shadow-2xl animate-slide-up">
      
      <!-- Modal Header -->
      <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl">
        <div>
          <h2 class="font-bold text-lg text-gray-800"><i class="fas fa-user-slash text-red-500 mr-2"></i>Absent Teachers</h2>
          <p class="text-xs text-gray-500">List of teachers absent today</p>
        </div>
        <button onclick="closeAbsentModal()" class="w-8 h-8 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center hover:bg-gray-300">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Scrollable List -->
      <div class="flex-1 overflow-y-auto p-4 bg-gray-100" id="absentModalBody">
        <ul id="absentUl" class="space-y-3"></ul>
      </div>
    </div>
  </div>

  <style>
    @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .animate-slide-up { animation: slide-up 0.3s ease-out; }
  </style>

  <!-- Debug Panel -->
  <div id="debugPanel" class="p-4 bg-black text-green-400 text-xs font-mono hidden border-b border-green-900">
      <h3 class="font-bold underline mb-1">Debug Log</h3>
      <div id="debugLogContent" class="whitespace-pre-wrap"></div>
  </div>

  <!-- Loading / Error Box -->
  <div id="statusBox" class="p-4 hidden"></div>

  <!-- ERROR TRAPPING & DEBUGGING API -->
  <script>
    // Define Global Logger First
    window.BC_DEBUG = {
        log: function(msg) {
            console.log(msg);
            const box = document.getElementById('debugLogContent');
            if(box) {
                const time = new Date().toLocaleTimeString();
                box.innerText += `[${time}] ${msg}\n`;
            }
        },
        error: function(msg) {
           this.log(`[ERROR] ${msg}`);
           const box = document.getElementById('debugPanel');
           if(box) box.classList.remove('hidden');
        }
    };
    
    window.onerror = function(msg, url, line, col, error) {
       window.BC_DEBUG.error(`CRITICAL: ${msg}\nAt: ${url}:${line}:${col}`);
       return false;
    };

    window.BC_DEBUG.log("DOM loaded. Waiting for scripts...");
  </script>

  <!-- Tabs -->
  <div id="mainContent" class="hidden">
    <div class="flex bg-white shadow-sm sticky top-16 z-40">
      <button onclick="switchTab('schedule')" id="tab-schedule" class="flex-1 py-3 text-sm text-center tab-active">
        Today's Schedule
      </button>
      <button onclick="switchTab('group')" id="tab-group" class="flex-1 py-3 text-sm text-center tab-inactive">
        Group Summary
      </button>
      <button onclick="switchTab('cancel')" id="tab-cancel" class="flex-1 py-3 text-sm text-center tab-inactive">
        Cancellations
      </button>
    </div>

    <!-- View: Schedule -->
    <div id="view-schedule" class="p-4">
      <div class="bg-white p-3 rounded-lg shadow-sm mb-3">
        <label class="text-xs font-bold text-gray-500">FILTER:</label>
        <div class="flex gap-2 mt-2">
           <button onclick="setFilterMode('teacher')" id="btn-f-teacher" class="flex-1 border rounded text-xs py-1 bg-green-100 border-green-500 text-green-800">Teacher</button>
           <button onclick="setFilterMode('school')" id="btn-f-school" class="flex-1 border rounded text-xs py-1">School</button>
           <button onclick="setFilterMode('group')" id="btn-f-group" class="flex-1 border rounded text-xs py-1">Group</button>
           <button onclick="setFilterMode('coord')" id="btn-f-coord" class="flex-1 border rounded text-xs py-1">Coord.</button>
        </div>
        <select id="filterSelect" class="w-full mt-3 p-2 border rounded text-sm" onchange="applyFilter()">
          <option value="all">-- All --</option>
        </select>
      </div>
      <div id="scheduleList" class="space-y-2"></div>
    </div>
    
    <!-- View: Group (New) -->
    <div id="view-group" class="p-4 hidden">
        <div id="groupList" class="space-y-3"></div>
    </div>

    <!-- View: Cancel -->
    <div id="view-cancel" class="p-4 hidden">
      <div id="cancelList" class="space-y-2"></div>
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script>
    // --- MAIN SCRIPT ---
    const logDebug = window.BC_DEBUG.log; // Alias
    logDebug("Main Script Block Started");

    // --- CONFIGURATION ---
    const SUPABASE_URL = "https://cgznmxcecljfybcgujjb.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnem5teGNlY2xqZnliY2d1ampiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2Nzc2NTI1MywiZXhwIjoyMDgzMzQxMjUzfQ.kTov9RFS-FVDNZokkslR0jFH2zaKTUYSBH9NQ8aItlQ";
    
    // --- STATE ---
    let rawData = {};
    let currentFilterMode = 'teacher';
    let sbClient = null;

    // --- COORD MAPPING (Fallback) ---
    // Removed hardcoded fallback per user request (depend on ref_assignment)
    
    window.onload = async () => {
      // 1. Set Date Picker to Today (BKK)
      const today = new Date().toLocaleDateString('en-CA', { timeZone: "Asia/Bangkok" });
      const picker = document.getElementById('datePicker');
      if (picker) {
          picker.value = today;
      }
      
      // 2. Load Data
      await reloadDashboard();
    };

    async function reloadDashboard() {
      const picker = document.getElementById('datePicker');
      const targetDate = picker ? picker.value : new Date().toLocaleDateString('en-CA', { timeZone: "Asia/Bangkok" });
      
      showStatus("loading", `üöÄ Connecting to Real-time Database (${targetDate})...`);
      
      // Clear current view
      document.getElementById('scheduleList').innerHTML = "";
      document.getElementById('cancelList').innerHTML = "";
      
      // Debug Reset
      logDebug(`Starting Load for ${targetDate}`);

      try {
        // Initialize Supabase
        if(window.supabase) {
             sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } else {
             throw new Error("Supabase SDK failed to load.");
        }

        // Parallel Fetch
        const [usersRes, schoolsRes, sessionsRes, leavesRes, assignRes] = await Promise.all([
             // Fetch ALL users (removed .eq('status', 'Active')) to ensure Coordinators/Admin are found even if not "Active" teachers
             sbClient.from('dim_user').select('user_id, firstname_en, lastname_en, user_type, position, braincloud_id'),
             sbClient.from('dim_school').select('school_id, school_code, school_name_en, school_group'),
             sbClient.from('fact_daily_session').select('*').eq('date', targetDate),
             sbClient.from('fact_teacher_unavailability').select('*').lte('start_date', targetDate).gte('end_date', targetDate),
             sbClient.from('ref_assignment').select('*')
        ]);

        if (usersRes.error) throw usersRes.error;
        if (schoolsRes.error) throw schoolsRes.error;
        if (sessionsRes.error) throw sessionsRes.error;
        
        logDebug(`Fetched: ${sessionsRes.data.length} sessions, ${usersRes.data.length} users, ${schoolsRes.data.length} schools, ${assignRes.data ? assignRes.data.length : 0} assignments`);

        // TRANSFORM DATA
        rawData = transformToDashboardFormat(
            sessionsRes.data, 
            usersRes.data, 
            schoolsRes.data, 
            leavesRes.data || [],
            assignRes.data || []
        );

        // Success
        document.getElementById('statusBox').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
        
        // Update UI
        updateMetrics(rawData);
        renderAbsentList(rawData.absentees);
        
        setFilterMode('teacher'); // Re-init filters
        renderCancellations();

        // Update Tab Label
        document.getElementById('tab-schedule').innerHTML = `Schedule (${rawData.metrics.total})`;
        applyFilter(); 

      } catch (err) {
        showStatus("error", "‚ùå Connection Failed: " + err.message);
        console.error(err);
        logDebug("ERROR: " + err.message);
      }
    }

    // --- ADAPTER: Supabase -> Dashboard Format ---
    // Verified v3.4.1
    function transformToDashboardFormat(sessions, users, schools, leaves, assignments) { // Fixed: Accept assignments
        // 1. Create Maps
        const userMap = {};
        users.forEach(u => {
            // Logic: user_type or position 210 = Full Time. 
            const isFT = (String(u.user_type) === '210' || String(u.position) === '210');
            // Strict key mapping
            userMap[String(u.user_id).trim()] = {
                name: (u.firstname_en || "Unknown") + " " + (u.lastname_en ? u.lastname_en.charAt(0)+"." : ""),
                type: isFT ? 'Full-time' : 'Part-time' 
            };
        });
        
        // 1.1 Assignments Map (Source of Truth for Coordinators)
        const assignmentMap = {}; 
        if (assignments) {
            assignments.forEach(a => {
                const sId = String(a.school_id).trim();
                // Priority: Explicit Name in DB -> User Table Lookup -> Raw ID
                // User Request: Map all names, do not default to Central
                let cName = a.coordinator_name;
                
                if (!cName && (a.user_id || a.coordinator_id)) {
                    const uId = String(a.user_id || a.coordinator_id).trim();
                    if (userMap[uId]) {
                        cName = userMap[uId].name;
                    } else {
                        // Fallback: If user not found (even after removing filter), show ID so we can debug
                        cName = "ID: " + uId; 
                    }
                }
                
                if (cName) assignmentMap[sId] = cName;
            });
        }

        const schoolMap = {};
        schools.forEach(s => {
            let grp = s.school_group || "Other";
            const sId = String(s.school_id).trim();
            
            // Priority: Explicit Assignment -> Unassigned
            // We removed the hardcoded fallback map to ensure data comes from DB only.
            let coordName = assignmentMap[sId] || 'Unassigned';
            
            // Strict key mapping
            schoolMap[sId] = {
                // Modified: Prefer Full Name (school_name_en) over Code
                name: s.school_name_en || s.school_code, 
                group: grp,
                coordinator: coordName
            };
        });

        // 2. Process Sessions
        const dashSessions = [];
        const cancellations = [];
        const filters = { teachers: new Set(), schools: new Set(), coordinators: new Set(), groups: new Set() };
        const metrics = { total: 0, covered: 0, cancelBC: 0, cancelSchool: 0, live: 0 };
        
        // Time Calculation for Metrics (Snapshot)
        const now = new Date();
        const bkkTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Bangkok"}));
        const currentH = bkkTime.getHours();
        const currentM = bkkTime.getMinutes();
        const currentTotalMins = currentH * 60 + currentM;
        // Check date logic handled by caller (only passes today's sessions usually, or we check date)
        // Note: 'sessions' passed here are filtered by date in reloadDashboard
        // We assume `reloadDashboard` is called with Today if user is looking for "Live" accuracy
        
        sessions.forEach(s => {
            const sId = String(s.school_id).trim();
            const sc = schoolMap[sId] || { name: 'Unknown', coordinator: 'Unassigned' };
            
            const actTId = String(s.actual_teacher_id).trim();
            const actT = userMap[actTId] || { name: actTId, type: 'Part-time' };
            
            const orgTId = String(s.original_teacher_id).trim();
            const orgT = userMap[orgTId] || { name: orgTId, type: 'Part-time' };
            
            const startStr = (s.start_time || "").substring(0, 5);
            const endStr = (s.end_time || "").substring(0, 5);
            
            let status = "Normal";
            let rawStatus = String(s.status || "");

            if (rawStatus.startsWith("Cancelled")) {
                status = rawStatus; // "Cancelled (BC)" etc
            } else if (rawStatus === "Substituted" || (s.actual_teacher_id && s.original_teacher_id && s.actual_teacher_id !== s.original_teacher_id)) {
                status = "Cover";
            }

            // Calc Live Metric
            let isLive = false;
            if (!status.includes("Cancelled")) {
                const [h1, m1] = startStr.split(':').map(Number);
                const [h2, m2] = endStr.split(':').map(Number);
                const startMins = h1 * 60 + m1;
                const endMins = h2 * 60 + m2;
                if (currentTotalMins >= startMins && currentTotalMins < endMins) {
                     isLive = true;
                     metrics.live++;
                }
            }

            // Update Metrics
            metrics.total++;
            if (status === 'Cover') metrics.covered++;
            if (status.includes('Cancelled (BC)')) metrics.cancelBC++;
            if (status.includes('Cancelled (School)')) metrics.cancelSchool++;

            // For List
            const item = {
                school: sc.name,
                class: s.class_name || "Class",
                time: `${startStr}-${endStr}`,
                teacher: actT.name,
                teacherType: actT.type,
                coordinator: sc.coordinator,
                status: status,
                originalTeacher: orgT.name,
                group: sc.group // <--- Added Group
            };
            dashSessions.push(item);
            
            // Filters
            filters.teachers.add(actT.name);
            filters.schools.add(sc.name);
            filters.coordinators.add(sc.coordinator);
            filters.groups.add(sc.group); // <--- Added Group Filter logic

            // Cancellations List (Simplified for now)
            if (status.includes("Cancelled")) {
                cancellations.push({
                    school: sc.name,
                    date: s.date,
                    time: `${startStr}-${endStr}`,
                    class: s.class_name,
                    by: status.includes("School") ? "School" : "Braincloud",
                    reason: "Cancelled by " + (status.includes("School") ? "School" : "Braincloud")
                });
            }
        });

        // 3. Process Absentees & Impact (Deduplicated)
        const uniqueAbsentees = new Map();

        (leaves || []).forEach(l => {
            // Simplify: 1 record per teacher ID
            const tid = String(l.teacher_id).trim();
            
            if (!uniqueAbsentees.has(tid)) {
                 const u = userMap[tid] || { name: tid, type: "?" };
                 uniqueAbsentees.set(tid, {
                     id: tid,
                     name: u.name,
                     type: u.type,
                     period: l.leave_type || "Leave", 
                     reason: l.remark || "N/A", // Fixed: Use 'remark' column
                     impacts: [] 
                 });
            }
        });

        // Calculate impacts strictly for the unique set
        const absentees = Array.from(uniqueAbsentees.values()).map(teacherObj => {
            const tid = teacherObj.id;
            const impactList = [];
            
            sessions.forEach(s => {
                // Check if this teacher (tid) is the ORIGINAL teacher of a session
                const sOrgId = String(s.original_teacher_id).trim();
                
                if (sOrgId === tid) {
                     const sc = schoolMap[String(s.school_id).trim()] || { name: 'Unknown' };
                     const sActId = String(s.actual_teacher_id).trim();
                     const actT = userMap[sActId] || { name: 'Unknown' };
                     
                     let st = "Normal";
                     let rs = String(s.status || "");
                     if (rs.startsWith("Cancelled")) st = rs;
                     else if (sActId !== sOrgId) st = "Cover";

                     impactList.push({
                         time: (s.start_time||"").substring(0,5),
                         school: sc.name,
                         className: s.class_name,
                         status: st,
                         actualTeacher: actT.name
                     });
                }
            });

            // Sort impacts by time ascending
            teacherObj.impacts = impactList.sort((a,b) => a.time.localeCompare(b.time));

            return teacherObj;
        });

        // 4. Sort & Return
        // Sort Absentees by first class time if they have one, else by Period string
        absentees.sort((a,b) => {
             // 1. Primary: Has impacts vs No impacts
             const hasA = a.impacts.length > 0;
             const hasB = b.impacts.length > 0;
             if (hasA && !hasB) return -1;
             if (!hasA && hasB) return 1;

             // 2. Secondary: If both have impacts, sort by time of FIRST class
             if (hasA && hasB) {
                 return a.impacts[0].time.localeCompare(b.impacts[0].time);
             }

             // 3. Fallback: Name
             return a.name.localeCompare(b.name);
        });

        return {
            sessions: dashSessions.sort((a,b) => a.time.localeCompare(b.time)),
            cancellations: cancellations,
            absentees: absentees,
            metrics: metrics,
            filters: {
                teachers: Array.from(filters.teachers).sort(),
                schools: Array.from(filters.schools).sort(),
                coordinators: Array.from(filters.coordinators).sort(),
                groups: Array.from(filters.groups).sort()
            }
        };
    }

    function updateMetrics(data) {
        document.getElementById('absentTotal').innerText = data.absentees.length;
        document.getElementById('countFT').innerText = data.absentees.filter(a => a.type === 'Full-time').length;
        document.getElementById('countPT').innerText = data.absentees.filter(a => a.type !== 'Full-time').length;
        
        document.getElementById('met-total').innerText = data.metrics.total;
        document.getElementById('met-cover').innerText = data.metrics.covered;
        document.getElementById('met-bc').innerText = data.metrics.cancelBC;
        document.getElementById('met-sch').innerText = data.metrics.cancelSchool;
        document.getElementById('met-live').innerText = data.metrics.live;
    }

    function showStatus(type, msg) {
       const box = document.getElementById('statusBox');
       box.classList.remove('hidden');
       box.className = type === 'error' ? 'p-4 m-4 bg-red-100 text-red-700 rounded-lg border border-red-300 text-sm' : 'p-4 m-4 bg-blue-50 text-blue-700 rounded-lg text-center text-sm';
       box.innerHTML = msg;
    }

    // --- Metric Filtering ---
    function filterSessionBy(mode) {
        // Switch to Schedule Tab
        switchTab('schedule');
        
        // Visual feedback on active filter
        window.currentStatusFilter = mode;
        applyFilter();
    }

    // --- Filter & Render Logic (Existing UI Cleaned) ---
    function switchTab(tab) {
      ['schedule', 'group', 'cancel'].forEach(t => {
          document.getElementById('view-' + t).classList.add('hidden');
          document.getElementById('tab-' + t).className = "flex-1 py-3 text-sm text-center tab-inactive text-gray-400";
      });

      document.getElementById('view-' + tab).classList.remove('hidden');
      document.getElementById('tab-' + tab).className = "flex-1 py-3 text-sm text-center tab-active border-b-2 border-green-600 text-green-700 font-bold";
      
      if (tab === 'group') {
          renderGroupSummary();
      }
    }

    function filterByGroup(groupName) {
        logDebug("Filtering by group: " + groupName);
        switchTab('schedule');
        setFilterMode('group');
        const sel = document.getElementById('filterSelect');
        sel.value = groupName;
        applyFilter();
    }

    function renderGroupSummary() {
        const list = document.getElementById('groupList');
        list.innerHTML = "";
        
        // Group Logic
        const groups = {};
        rawData.sessions.forEach(s => {
            if(!groups[s.group]) groups[s.group] = { total: 0, schools: new Set() };
            groups[s.group].total++;
            groups[s.group].schools.add(s.school);
        });
        
        // Render
        const styleMap = {
            "Thesaban": { bg: "#F8E1EC", text: "#880E4F" },
            "OBEC 3": { bg: "#FAE3D9", text: "#BF360C" },
            "Private School": { bg: "#E8E1F5", text: "#4527A0" },
            "OBEC South": { bg: "#FFF9C4", text: "#795548" },
            "Other": { bg: "#F1F5F9", text: "#475569" }
        };

        const keys = Object.keys(groups).sort();
        if(keys.length === 0) {
            list.innerHTML = "<div class='text-center text-gray-400 py-10'>No data</div>";
            return;
        }

        keys.forEach(k => {
            const data = groups[k];
            const st = styleMap[k] || styleMap["Other"];
            
            list.innerHTML += `
               <div onclick="filterByGroup('${k}')" class="cursor-pointer p-4 rounded-lg shadow-sm border border-gray-100 flex justify-between items-center transition hover:shadow-md hover:scale-[1.02]" style="background-color:${st.bg}">
                  <div>
                      <div class="font-bold text-lg" style="color:${st.text}">${k}</div>
                      <div class="text-xs opacity-70 mt-1" style="color:${st.text}">
                        ${data.schools.size} Schools Active
                      </div>
                  </div>
                  <div class="text-3xl font-bold" style="color:${st.text}">
                      ${data.total}
                      <span class="text-xs font-normal block text-right opacity-60">Classes</span>
                  </div>
               </div>
            `;
        });
    }

    function setFilterMode(mode) {
      window.currentStatusFilter = 'Total'; // Reset Status Filter
      currentFilterMode = mode;
      ['teacher', 'school', 'coord', 'group'].forEach(m => {
        document.getElementById('btn-f-' + m).className = (m === mode) 
          ? "flex-1 border rounded text-xs py-1 bg-green-100 border-green-500 text-green-800 font-bold"
          : "flex-1 border rounded text-xs py-1 text-gray-600";
      });

      const select = document.getElementById('filterSelect');
      select.innerHTML = '<option value="all">-- Show All --</option>';
      
      let items = [];
      if(mode === 'teacher') items = rawData.filters.teachers;
      if(mode === 'school') items = rawData.filters.schools;
      if(mode === 'coord') items = rawData.filters.coordinators;
      if(mode === 'group') items = rawData.filters.groups;

      items.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item;
        opt.text = item;
        select.appendChild(opt);
      });
      applyFilter();
    }

    function applyFilter() {
      const val = document.getElementById('filterSelect').value;
      const list = document.getElementById('scheduleList');
      list.innerHTML = "";
      
      const statusMode = window.currentStatusFilter || 'Total';

      // --- TIME CHECK for "LIVE" status ---
      const now = new Date();
      // Bangkok Time
      const bkkTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Bangkok"}));
      const currentH = bkkTime.getHours();
      const currentM = bkkTime.getMinutes();
      const currentTotalMins = currentH * 60 + currentM;

      // Check if selected date is Today (YYYY-MM-DD compare)
      const picker = document.getElementById('datePicker');
      // note: picker.value is 'YYYY-MM-DD' from en-CA format
      const todayStr = bkkTime.toLocaleDateString('en-CA', { timeZone: "Asia/Bangkok" });
      const isToday = (picker && picker.value === todayStr);

      const filtered = rawData.sessions.filter(s => {
        // 1. Check Status Filter
        if (statusMode === 'Cover' && s.status !== 'Cover') return false;
        if (statusMode === 'Cancelled (BC)' && !s.status.includes('Cancelled (BC)')) return false;
        if (statusMode === 'Cancelled (School)' && !s.status.includes('Cancelled (School)')) return false;

        // NEW: Live Check
        if (statusMode === 'Live') {
             if (s.status.includes('Cancelled')) return false;
             
             // Recalculate live status here to be sure (s.start_time is stored only as string 00:00-00:00 in 's.time')
             const [t1, t2] = s.time.split('-');
             if (!t1 || !t2) return false;
             const [h1, m1] = t1.split(':').map(Number);
             const [h2, m2] = t2.split(':').map(Number);
             const startMins = h1 * 60 + m1;
             const endMins = h2 * 60 + m2;
             
             // Must be on Today & Time range
             if (!isToday) return false;
             if (currentTotalMins < startMins || currentTotalMins >= endMins) return false; 
        }

        // 2. Check Dropdown Filter
        if (val === 'all') return true;
        if (currentFilterMode === 'teacher') return s.teacher === val;
        if (currentFilterMode === 'school') return s.school === val;
        if (currentFilterMode === 'coord') return s.coordinator === val;
        if (currentFilterMode === 'group') return s.group === val;
      });

      // Update Filter Count Log
      // console.log(`Filtered: ${filtered.length} / ${rawData.sessions.length}`);

      if (filtered.length === 0) {
        list.innerHTML = `<div class="text-center py-10 text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
        return;
      }

      filtered.forEach(s => {
        const isCover = s.status === 'Cover';
        const isCancel = s.status.includes('Cancel');
        
        // --- School Group Style ---
        const getStyle = (grp) => {
            const map = {
                "Thesaban": { bg: "#F8E1EC", border: "#FDB2D7", text: "#880E4F" }, // Lighter Pink
                "OBEC 3": { bg: "#FAE3D9", border: "#FDA07D", text: "#BF360C" }, // Lighter Orange
                "Private School": { bg: "#E8E1F5", border: "#D1C4E9", text: "#4527A0" }, // Lighter Purple
                "OBEC South": { bg: "#FFF9C4", border: "#FFDF7F", text: "#795548" }, // Lighter Yellow
                "Other": { bg: "#F1F5F9", border: "#CBD5E1", text: "#475569" }
            };
            return map[grp] || map["Other"];
        };
        const style = getStyle(s.group);

        // --- Live Status ---
        let isLive = false;
        if (isToday && !isCancel) { 
            const [t1, t2] = s.time.split('-');
            if (t1 && t2) {
                const [h1, m1] = t1.split(':').map(Number);
                const [h2, m2] = t2.split(':').map(Number);
                const startMins = h1 * 60 + m1;
                const endMins = h2 * 60 + m2;
                if (currentTotalMins >= startMins && currentTotalMins < endMins) isLive = true;
            }
        }

        // --- Card Styling ---
        let cardCss = `background-color: ${style.bg}; border: 1px solid ${style.border};`;
        let titleColor = style.text;
        
        if (isCancel) {
            cardCss = "background: white; border: 2px dashed #d32f2f; opacity: 0.6;";
            titleColor = "#d32f2f";
        } else if (isCover) {
            // Keep bg but add top border
            cardCss += " border-top: 4px solid #00E676;";
        }

        const html = `
          <div class="card p-3 rounded-lg shadow-sm mb-2 ${isLive ? 'card-live' : ''}" style="${cardCss}">
            <div class="flex justify-between items-start">
              <div>
                <div class="flex items-center">
                  <span class="font-bold text-lg" style="color:${titleColor}">${s.class}</span> <!-- Primary: Class Name -->
                </div>
                <div class="text-[11px] opacity-70 mb-1" style="color:${titleColor}">${s.school}</div> <!-- Secondary: School Name -->
                
                <div class="text-xs text-gray-800 mt-1 flex items-center">
                    <span class="opacity-80">üïí ${s.time}</span>
                    ${isLive ? '<span class="badge-live shadow-sm">LIVE</span>' : ''}
                </div>
                <div class="text-xs text-gray-900 mt-1">
                   <div class="flex items-center">
                     <span class="font-medium">üë§ ${s.teacher}</span>
                     <!-- Teacher Type Badge -->
                     <span class="ml-1 text-[9px] px-1 rounded border bg-white/60 border-black/10 text-gray-600">
                       ${s.teacherType === 'Full-time' ? 'FT' : 'PT'}
                     </span>
                   </div>
                   ${isCover ? `<div class="text-[11px] text-green-800 mt-1 font-bold bg-green-100/50 px-1 rounded inline-block"><i class="fas fa-sync-alt text-[10px]"></i> Cover for: ${s.originalTeacher || '?'}</div>` : ''}
                </div>
              </div>
              <div class="text-[10px] text-gray-600 text-right opacity-70">
                ${s.coordinator}<br>(Coord)
              </div>
            </div>
          </div>`;
        list.innerHTML += html;
      });
    }

    function renderCancellations() {
      const list = document.getElementById('cancelList');
      const cancels = rawData.cancellations;
      list.innerHTML = "";
      
      if(cancels.length === 0) {
        list.innerHTML = `<div class="text-center py-10 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤</div>`;
        return;
      }

      // Simple Group by School
      const groups = {};
      cancels.forEach(c => {
         if(!groups[c.school]) groups[c.school] = [];
         groups[c.school].push(c);
      });

      Object.keys(groups).sort().forEach(school => {
          const items = groups[school];
          let rows = items.map(x => `
             <div class="flex justify-between items-center text-xs py-2 border-b last:border-0 border-gray-100">
                <div>
                   <span class="font-mono text-gray-500 mr-2">${x.time}</span>
                   <span class="font-bold text-gray-700">${x.class}</span>
                </div>
                <div class="text-[10px] text-gray-400 italic">${x.by}</div>
             </div>
          `).join("");

          list.innerHTML += `
             <div class="bg-white p-3 rounded-lg shadow-sm mb-3 border-l-4 border-red-400">
                <div class="font-bold text-gray-800 mb-2 flex justify-between">
                   <span>${school}</span>
                   <span class="text-xs font-normal text-gray-500 bg-gray-100 px-2 rounded-full">${items.length} classes</span>
                </div>
                ${rows}
             </div>
          `;
      });
    }

    function formatDateShort(dateStr) {
       // yyyy-MM-dd -> d MMM
       if(!dateStr) return "";
       const d = new Date(dateStr);
       return d.toLocaleDateString("th-TH", { day: 'numeric', month: 'short' });
    }

    function renderAbsentList(list) {
      const ul = document.getElementById('absentUl');
      ul.innerHTML = "";
      if (list.length === 0) {
        ul.innerHTML = "<div class='text-center text-gray-400 py-10'>- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏£‡∏π‡∏•‡∏≤ -</div>";
        return;
      }

      // Sort: FT ‡∏Å‡πà‡∏≠‡∏ô PT
      list.sort((a, b) => (a.type === 'Full-time' ? -1 : 1));

      list.forEach((p, index) => {
        const isFT = p.type === 'Full-time';
        const badgeColor = isFT ? 'bg-blue-100 text-blue-700 border-blue-200' : 'bg-orange-100 text-orange-700 border-orange-200';
        
        const impactHtml = p.impacts.length > 0 
          ? `<div class="mt-2 bg-gray-50 rounded p-2 border border-gray-200">
               <p class="text-[10px] font-bold text-gray-500 mb-1">Impacted Schedule (${p.impacts.length}):</p>
               ${p.impacts.map(i => {
                  let statusClass = i.status === 'Cover' ? 'text-green-600' : (i.status.includes('Cancel') ? 'text-red-600' : 'text-gray-600');
                  let icon = i.status === 'Cover' ? '<i class="fas fa-sync-alt"></i>' : (i.status.includes('Cancel') ? '<i class="fas fa-times-circle"></i>' : '<i class="fas fa-question-circle"></i>');
                  let detail = i.status === 'Cover' ? `Cover by <b>${i.actualTeacher}</b>` : i.status;
                  
                  return `
                  <div class="flex justify-between items-center text-[11px] py-1 border-b border-gray-100 last:border-0">
                    <div>
                      <span class="font-mono text-gray-500 w-8 inline-block">${i.time}</span> 
                      <span class="font-bold text-gray-800 ml-1 text-xs">${i.className || 'Class'}</span>
                      <span class="text-[10px] text-gray-400 ml-1">(${i.school})</span>
                    </div>
                    <div class="${statusClass} flex items-center gap-1">
                      ${icon} ${detail}
                    </div>
                  </div>`;
               }).join('')}
             </div>`
          : `<div class="mt-2 text-[10px] text-gray-400 italic text-center bg-gray-50 p-1 rounded">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ -</div>`;

        ul.innerHTML += `
          <li class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
            <div class="flex justify-between items-start">
               <div>
                 <div class="flex items-center gap-2">
                   <span class="font-bold text-gray-800 text-lg">${p.name}</span>
                   <span class="text-[10px] px-2 py-0.5 rounded border font-bold ${badgeColor}">${isFT ? 'FT' : 'PT'}</span>
                 </div>
                 <div class="text-xs text-gray-500 mt-1">
                   <i class="far fa-clock mr-1"></i> ${p.period}
                 </div>
               </div>
               <div class="text-right">
                 <span class="text-xs font-bold text-orange-600 bg-orange-50 px-2 py-1 rounded-lg border border-orange-100">
                   ${p.reason}
                 </span>
               </div>
            </div>
            
            <!-- Impact Section -->
            ${impactHtml}
          </li>`;
      });
    }

    function openAbsentModal() {
      document.getElementById('absentModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }

    function closeAbsentModal() {
      document.getElementById('absentModal').classList.add('hidden');
      document.body.style.overflow = ''; // Restore scrolling
    }

    function toggleImpact(id) {
       // Deprecated in new UI
    }

    function toggleAbsentList() {
       // Deprecated
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BC Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
    body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
    .tab-active { border-bottom: 3px solid #16a34a; color: #16a34a; font-weight: bold; }
    .tab-inactive { color: #64748b; }
    .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  </style>
</head>
<body class="pb-20">

  <!-- Header -->
  <div class="bg-slate-800 text-white p-5 sticky top-0 z-50 shadow-md">
    <div class="flex justify-between items-center">
      <h1 class="text-lg font-bold">BC Dashboard</h1>
      <span class="text-xs bg-slate-700 px-2 py-1 rounded" id="dateDisplay">...</span>
    </div>
    <!-- Absent Summary -->
    <div class="mt-3 text-xs text-red-200">
      <div class="flex items-center cursor-pointer bg-slate-700 p-2 rounded-lg hover:bg-slate-600 transition" onclick="openAbsentModal()">
        <i class="fas fa-user-slash mr-2 text-red-400"></i>
        <span class="flex-1">Absent Today: <b id="absentTotal" class="text-white">0</b></span>
        <div class="flex gap-2">
           <span class="bg-blue-900 text-blue-200 px-2 py-0.5 rounded text-[10px]">FT: <b id="countFT">0</b></span>
           <span class="bg-orange-900 text-orange-200 px-2 py-0.5 rounded text-[10px]">PT: <b id="countPT">0</b></span>
        </div>
        <i class="fas fa-chevron-right ml-2 text-[10px]"></i>
      </div>
    </div>
  </div>

  <!-- Absent Modal (Full Screen) -->
  <div id="absentModal" class="fixed inset-0 z-[100] hidden">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black bg-opacity-80 backdrop-blur-sm" onclick="closeAbsentModal()"></div>
    
    <!-- Modal Content -->
    <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl h-[80vh] flex flex-col shadow-2xl animate-slide-up">
      
      <!-- Modal Header -->
      <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl">
        <div>
          <h2 class="font-bold text-lg text-gray-800"><i class="fas fa-user-slash text-red-500 mr-2"></i>Absent Teachers</h2>
          <p class="text-xs text-gray-500">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
        </div>
        <button onclick="closeAbsentModal()" class="w-8 h-8 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center hover:bg-gray-300">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Scrollable List -->
      <div class="flex-1 overflow-y-auto p-4 bg-gray-100" id="absentModalBody">
        <ul id="absentUl" class="space-y-3"></ul>
      </div>
    </div>
  </div>

  <style>
    @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .animate-slide-up { animation: slide-up 0.3s ease-out; }
  </style>

  <!-- Loading / Error Box -->
  <div id="statusBox" class="p-4 hidden"></div>

  <!-- Tabs -->
  <div id="mainContent" class="hidden">
    <div class="flex bg-white shadow-sm sticky top-16 z-40">
      <button onclick="switchTab('schedule')" id="tab-schedule" class="flex-1 py-3 text-sm text-center tab-active">
        ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
      </button>
      <button onclick="switchTab('cancel')" id="tab-cancel" class="flex-1 py-3 text-sm text-center tab-inactive">
        ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
      </button>
    </div>

    <!-- View: Schedule -->
    <div id="view-schedule" class="p-4">
      <div class="bg-white p-3 rounded-lg shadow-sm mb-3">
        <label class="text-xs font-bold text-gray-500">FILTER:</label>
        <div class="flex gap-2 mt-2">
           <button onclick="setFilterMode('teacher')" id="btn-f-teacher" class="flex-1 border rounded text-xs py-1 bg-green-100 border-green-500 text-green-800">Teacher</button>
           <button onclick="setFilterMode('school')" id="btn-f-school" class="flex-1 border rounded text-xs py-1">School</button>
           <button onclick="setFilterMode('coord')" id="btn-f-coord" class="flex-1 border rounded text-xs py-1">Coord.</button>
        </div>
        <select id="filterSelect" class="w-full mt-3 p-2 border rounded text-sm" onchange="applyFilter()">
          <option value="all">-- All --</option>
        </select>
      </div>
      <div id="scheduleList" class="space-y-2"></div>
    </div>

    <!-- View: Cancel -->
    <div id="view-cancel" class="p-4 hidden">
      <div id="cancelList" class="space-y-2"></div>
    </div>
  </div>

  <script>
    // ‚öôÔ∏è ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Apps Script ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà Deploy
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzSmyE6wkdDWZDVagxM7oeE_8rDmuWOOCBFzkcUzBw7eM08kYrfUqNETBfvm5zlX4J8oQ/exec"; 

    let rawData = {};
    let currentFilterMode = 'teacher';

    window.onload = async () => {
      const today = new Date();
      document.getElementById('dateDisplay').innerText = today.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
      
      showStatus("loading", "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà");

      try {
        const response = await fetch(`${GAS_API_URL}?action=getDashboardData`, {
          method: 'GET',
          mode: 'cors',
          redirect: 'follow'
        });
        const text = await response.text(); // ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô Text ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ú‡∏∑‡πà‡∏≠ Error HTML
        
        let json;
        try {
           json = JSON.parse(text);
        } catch (e) {
           // ‡∏ñ‡πâ‡∏≤ Parse ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤ Server ‡∏™‡πà‡∏á HTML Error ‡∏°‡∏≤
           console.error("Server Response:", text);
           throw new Error("Server Error (HTML): " + extractError(text));
        }

        if (json.error) {
           throw new Error(json.message);
        }

        rawData = json;
        
        // Success
        document.getElementById('statusBox').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
        
        // Update Absent Count & List
        const absentees = rawData.absentees || [];
        const ftCount = absentees.filter(a => a.type === 'Full-time').length;
        const ptCount = absentees.filter(a => a.type !== 'Full-time').length;

        document.getElementById('absentTotal').innerText = absentees.length;
        document.getElementById('countFT').innerText = ftCount;
        document.getElementById('countPT').innerText = ptCount;
        
        renderAbsentList(absentees);

        setFilterMode('teacher');
        renderCancellations();

      } catch (err) {
        showStatus("error", "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err.message);
      }
    };

    function extractError(html) {
       // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÅ‡∏Å‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Error ‡∏à‡∏≤‡∏Å HTML ‡∏Ç‡∏≠‡∏á Google
       if (html.includes("Google Docs")) return "‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò (Check File ID/Permissions)";
       if (html.includes("script")) return "‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (Check Script Logs)";
       return html.substring(0, 100) + "..."; // ‡∏ï‡∏±‡∏î‡∏°‡∏≤‡∏™‡∏±‡πâ‡∏ô‡πÜ
    }

    function showStatus(type, msg) {
       const box = document.getElementById('statusBox');
       box.classList.remove('hidden');
       box.className = type === 'error' ? 'p-4 m-4 bg-red-100 text-red-700 rounded-lg border border-red-300 text-sm' : 'p-4 m-4 bg-blue-50 text-blue-700 rounded-lg text-center text-sm';
       box.innerHTML = msg;
    }

    // --- Filter & Render Logic (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    function switchTab(tab) {
      document.getElementById('view-schedule').classList.add('hidden');
      document.getElementById('view-cancel').classList.add('hidden');
      document.getElementById('tab-schedule').className = "flex-1 py-3 text-sm text-center tab-inactive text-gray-400";
      document.getElementById('tab-cancel').className = "flex-1 py-3 text-sm text-center tab-inactive text-gray-400";

      document.getElementById('view-' + tab).classList.remove('hidden');
      document.getElementById('tab-' + tab).className = "flex-1 py-3 text-sm text-center tab-active border-b-2 border-green-600 text-green-700 font-bold";
    }

    function setFilterMode(mode) {
      currentFilterMode = mode;
      ['teacher', 'school', 'coord'].forEach(m => {
        document.getElementById('btn-f-' + m).className = (m === mode) 
          ? "flex-1 border rounded text-xs py-1 bg-green-100 border-green-500 text-green-800 font-bold"
          : "flex-1 border rounded text-xs py-1 text-gray-600";
      });

      const select = document.getElementById('filterSelect');
      select.innerHTML = '<option value="all">-- Show All --</option>';
      
      let items = [];
      if(mode === 'teacher') items = rawData.filters.teachers;
      if(mode === 'school') items = rawData.filters.schools;
      if(mode === 'coord') items = rawData.filters.coordinators;

      items.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item;
        opt.text = item;
        select.appendChild(opt);
      });
      applyFilter();
    }

    function applyFilter() {
      const val = document.getElementById('filterSelect').value;
      const list = document.getElementById('scheduleList');
      list.innerHTML = "";

      const filtered = rawData.sessions.filter(s => {
        if (val === 'all') return true;
        if (currentFilterMode === 'teacher') return s.teacher === val;
        if (currentFilterMode === 'school') return s.school === val;
        if (currentFilterMode === 'coord') return s.coordinator === val;
      });

      document.getElementById('dateDisplay').innerText = `${filtered.length} ‡∏Ñ‡∏≤‡∏ö`;

      if (filtered.length === 0) {
        list.innerHTML = `<div class="text-center py-10 text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
        return;
      }

      filtered.forEach(s => {
        const isCover = s.status === 'Cover';
        const isCancel = s.status.includes('Cancel');
        
        let statusBadge = "";
        if(isCover) statusBadge = `<span class="bg-yellow-100 text-yellow-800 text-[10px] px-1 rounded ml-1">Sub</span>`;
        if(isCancel) statusBadge = `<span class="bg-red-100 text-red-800 text-[10px] px-1 rounded ml-1">Cancel</span>`;

        const html = `
          <div class="card bg-white p-3 rounded-lg shadow-sm border border-gray-100 ${isCancel ? 'opacity-60 bg-gray-50' : ''}">
            <div class="flex justify-between items-start">
              <div>
                <div class="flex items-center">
                  <span class="font-bold text-gray-800">${s.school}</span>
                  <span class="text-xs bg-gray-100 text-gray-500 px-1 rounded ml-2">${s.class}</span>
                  ${statusBadge}
                </div>
                <div class="text-xs text-gray-500 mt-1">üïí ${s.time}</div>
                <div class="text-xs text-gray-700 mt-1 flex items-center">
                   <span>üë§ ${s.teacher}</span>
                   <span class="ml-1 text-[10px] px-1 rounded border ${s.teacherType === 'Full-time' ? 'bg-blue-50 text-blue-600 border-blue-200' : 'bg-orange-50 text-orange-600 border-orange-200'}">
                     ${s.teacherType === 'Full-time' ? 'FT' : 'PT'}
                   </span>
                </div>
              </div>
              <div class="text-[10px] text-gray-400 text-right">
                ${s.coordinator}<br>(Coord)
              </div>
            </div>
          </div>`;
        list.innerHTML += html;
      });
    }

    function renderCancellations() {
      const list = document.getElementById('cancelList');
      const cancels = rawData.cancellations;
      list.innerHTML = "";
      
      if(cancels.length === 0) {
        list.innerHTML = `<div class="text-center py-10 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤</div>`;
        return;
      }

      cancels.forEach(c => {
        list.innerHTML += `
          <div class="bg-white border-l-4 border-red-500 p-3 rounded shadow-sm">
            <div class="flex justify-between">
              <span class="font-bold text-red-600">${c.school}</span>
              <span class="text-[10px] text-gray-400">${new Date(c.time).toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'})}</span>
            </div>
            <div class="text-sm font-bold mt-1 text-gray-800">${c.type}</div>
            <div class="text-xs text-gray-600 bg-gray-50 p-2 rounded mt-1">${c.reason}</div>
            <div class="text-[10px] text-gray-400 mt-1 text-right">‡πÇ‡∏î‡∏¢: ${c.user}</div>
          </div>`;
      });
    }

    function renderAbsentList(list) {
      const ul = document.getElementById('absentUl');
      ul.innerHTML = "";
      if (list.length === 0) {
        ul.innerHTML = "<div class='text-center text-gray-400 py-10'>- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏£‡∏π‡∏•‡∏≤ -</div>";
        return;
      }

      // Sort: FT ‡∏Å‡πà‡∏≠‡∏ô PT
      list.sort((a, b) => (a.type === 'Full-time' ? -1 : 1));

      list.forEach((p, index) => {
        const isFT = p.type === 'Full-time';
        const badgeColor = isFT ? 'bg-blue-100 text-blue-700 border-blue-200' : 'bg-orange-100 text-orange-700 border-orange-200';
        
        const impactHtml = p.impacts.length > 0 
          ? `<div class="mt-2 bg-gray-50 rounded p-2 border border-gray-200">
               <p class="text-[10px] font-bold text-gray-500 mb-1">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö (${p.impacts.length}):</p>
               ${p.impacts.map(i => {
                  let statusClass = i.status === 'Cover' ? 'text-green-600' : (i.status.includes('Cancel') ? 'text-red-600' : 'text-gray-600');
                  let icon = i.status === 'Cover' ? '<i class="fas fa-sync-alt"></i>' : (i.status.includes('Cancel') ? '<i class="fas fa-times-circle"></i>' : '<i class="fas fa-question-circle"></i>');
                  let detail = i.status === 'Cover' ? `Cover by <b>${i.actualTeacher}</b>` : i.status;
                  
                  return `
                  <div class="flex justify-between items-center text-[11px] py-1 border-b border-gray-100 last:border-0">
                    <div>
                      <span class="font-mono text-gray-500">${i.time}</span> 
                      <span class="font-bold text-gray-700 ml-1">${i.school}</span>
                    </div>
                    <div class="${statusClass} flex items-center gap-1">
                      ${icon} ${detail}
                    </div>
                  </div>`;
               }).join('')}
             </div>`
          : `<div class="mt-2 text-[10px] text-gray-400 italic text-center bg-gray-50 p-1 rounded">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ -</div>`;

        ul.innerHTML += `
          <li class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
            <div class="flex justify-between items-start">
               <div>
                 <div class="flex items-center gap-2">
                   <span class="font-bold text-gray-800 text-lg">${p.name}</span>
                   <span class="text-[10px] px-2 py-0.5 rounded border font-bold ${badgeColor}">${isFT ? 'FT' : 'PT'}</span>
                 </div>
                 <div class="text-xs text-gray-500 mt-1">
                   <i class="far fa-clock mr-1"></i> ${p.period}
                 </div>
               </div>
               <div class="text-right">
                 <span class="text-xs font-bold text-orange-600 bg-orange-50 px-2 py-1 rounded-lg border border-orange-100">
                   ${p.reason}
                 </span>
               </div>
            </div>
            
            <!-- Impact Section -->
            ${impactHtml}
          </li>`;
      });
    }

    function openAbsentModal() {
      document.getElementById('absentModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }

    function closeAbsentModal() {
      document.getElementById('absentModal').classList.add('hidden');
      document.body.style.overflow = ''; // Restore scrolling
    }

    function toggleImpact(id) {
       // Deprecated in new UI
    }

    function toggleAbsentList() {
       // Deprecated
    }
  </script>
</body>
</html>

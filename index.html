<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Supabase Connection Test</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body { font-family: monospace; padding: 20px; word-wrap: break-word; font-size: 14px; }
  .log { margin-bottom: 5px; border-bottom: 1px solid #eee; padding: 2px; }
  .error { color: red; font-weight: bold; }
  .success { color: green; font-weight: bold; }
  h1 { font-size: 18px; }
</style>
</head>
<body>
  <h1>Supabase Diagnostic v1.0</h1>
  <div id="status">Initializing...</div>
  <hr>
  <div id="output"></div>
  
  <script>
    const logDiv = document.getElementById('output');
    const statusDiv = document.getElementById('status');

    function log(msg, type='') {
      console.log(msg);
      const div = document.createElement('div');
      div.className = 'log ' + type;
      div.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logDiv.appendChild(div);
    }

    log("Script started execution.");

    const SUPABASE_URL = "https://cgznmxcecljfybcgujjb.supabase.co";
    // Using the key you provided in the previous file
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnem5teGNlY2xqZnliY2d1ampiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2Nzc2NTI1MywiZXhwIjoyMDgzMzQxMjUzfQ.kTov9RFS-FVDNZokkslR0jFH2zaKTUYSBH9NQ8aItlQ";

    async function testConnection() {
      try {
        statusDiv.innerText = "Checking Dependencies...";
        
        if (typeof window.supabase === 'undefined') {
          throw new Error("Supabase SDK NOT loaded. Check script tag/CDN.");
        }
        log("Supabase SDK detected.");

        statusDiv.innerText = "Connecting...";
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        log(`Client initialized. URL: ${SUPABASE_URL}`);
        log("Attempting to fetch 1 row from 'dim_school'...");

        const start = Date.now();
        const { data, error } = await sb
          .from('dim_school')
          .select('school_name')
          .limit(1);
        const duration = Date.now() - start;

        if (error) {
          statusDiv.innerText = "Connection Failed";
          statusDiv.style.color = "red";
          log("Supabase Error: " + JSON.stringify(error), 'error');
          log("Hint: Check RLS (Row Level Security) policies or Table Permissions.", 'error');
        } else {
          statusDiv.innerText = "Connection Successful";
          statusDiv.style.color = "green";
          log(`Success! Request took ${duration}ms.`, 'success');
          log("Data Received: " + JSON.stringify(data), 'success');
        }

      } catch (e) {
        statusDiv.innerText = "Critical Error";
        statusDiv.style.color = "red";
        log("EXCEPTION: " + e.message, 'error');
        log(e.stack);
      }
    }

    // Run immediately when body parses
    testConnection();
  </script>
</body>
</html>

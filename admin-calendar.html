<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Calendar v1.0.3 (With Alarms)</title>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
    body { font-family: 'Sarabun', sans-serif; }
    
    /* Calendar Overrides & Beautification (Thai Style) */
    
    /* Fonts & General */
    .fc { font-family: 'Sarabun', sans-serif; }
    .fc-toolbar-title { font-size: 2rem !important; font-weight: 800 !important; color: #1e3a8a; letter-spacing: -0.5px; } /* Bold Deep Blue Title */
    .fc-col-header-cell-cushion { font-size: 1.1rem; font-weight: 800; text-transform: uppercase; padding: 8px 0; }
    .fc-daygrid-day-number { font-size: 1.1rem; font-weight: 700; padding: 8px !important; }

    /* Sunday (Red) */
    .fc-day-sun .fc-col-header-cell-cushion { color: #dc2626; }
    .fc-day-sun .fc-daygrid-day-number { color: #dc2626; }
    .fc-day-sun { background-color: #fef2f2; } /* Faint Red Background */

    /* Saturday (Pale Blue / Indigo) */
    .fc-day-sat .fc-col-header-cell-cushion { color: #6366f1; }
    .fc-day-sat .fc-daygrid-day-number { color: #6366f1; }
    .fc-day-sat { background-color: #f5f3ff; } /* Faint Indigo Background */

    /* Weekdays (Deep Blue) */
    .fc-day-mon .fc-col-header-cell-cushion, .fc-day-mon .fc-daygrid-day-number,
    .fc-day-tue .fc-col-header-cell-cushion, .fc-day-tue .fc-daygrid-day-number,
    .fc-day-wed .fc-col-header-cell-cushion, .fc-day-wed .fc-daygrid-day-number,
    .fc-day-thu .fc-col-header-cell-cushion, .fc-day-thu .fc-daygrid-day-number,
    .fc-day-fri .fc-col-header-cell-cushion, .fc-day-fri .fc-daygrid-day-number { color: #1e3a8a; }

    /* Events */
    .fc-event { cursor: pointer; border: none; z-index: 10; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
    .fc-daygrid-event { font-size: 0.75rem; border-radius: 4px; padding: 1px; margin-top: 1px; }
    
    /* Enhance Today */
    .fc-day-today { background-color: #ecfdf5 !important; }
    .fc-day-today .fc-daygrid-day-number { font-size: 1.5em; color: #059669 !important; }
    
    /* Loading & Alert Animation */
    @keyframes pulse-alert {
        0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); border-color: #f87171; transform: scale(1); }
        50% { box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.2); border-color: #ef4444; transform: scale(1.005); }
        100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); border-color: #f87171; transform: scale(1); }
    }
    .status-pulse { animation: pulse-alert 1.5s infinite; border-width: 2px !important; z-index: 20 !important; }
    .fc-day-past { background-color: #f8fafc; }
    .fc-day-past .fc-daygrid-day-number { opacity: 0.4; }
    .fc-day-past .fc-col-header-cell-cushion { opacity: 0.5; }
    
    .fc-button-primary { background-color: #1e40af !important; border-color: #1e40af !important; font-weight: 600; text-transform: uppercase; }
    .fc-button-active { background-color: #1e3a8a !important; }

    /* Modal Animation */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-backdrop { animation: fadeIn 0.15s ease-out; }
    .modal-content { animation: slideUp 0.15s ease-out; }
    
    /* Switch Toggle */
    .toggle-checkbox:checked { right: 0; border-color: #68D391; }
    .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }

    /* Popover (More Events) Scroll Fix */
    .fc-popover {
        z-index: 9999 !important;
        border-radius: 0.5rem !important;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
        border: 1px solid #e2e8f0 !important;
        
        /* Flex layout to handle header + list correctly */
        display: flex !important;
        flex-direction: column !important;
        
        /* Aggressively restrict height to simulate "cell-sized" popup */
        max-height: 220px !important; 
        width: 16rem !important;
    }
    
    .fc-popover-header {
        background-color: #f8fafc !important;
        padding: 8px 12px !important;
        font-weight: 700;
        border-bottom: 1px solid #e2e8f0;
        flex-shrink: 0 !important;
        font-size: 0.9rem !important;
    }

    .fc-popover-body {
        overflow-y: auto !important;
        flex-grow: 1 !important;
        min-height: 0 !important;
        padding: 4px !important;
    }

    /* Scrollbar styling for Webkit */
    .fc-popover-body::-webkit-scrollbar { width: 6px; }
    .fc-popover-body::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
    .fc-popover-body::-webkit-scrollbar-track { background-color: transparent; }

    /* Multi-day Split Visuals */
    .multi-day-start {
        border-top-right-radius: 0 !important;
        border-bottom-right-radius: 0 !important;
        border-right: 2px dashed rgba(0,0,0,0.2) !important; /* Visible dark perforation */
        margin-right: 0 !important;
        position: relative;
    }
    .multi-day-middle {
        border-radius: 0 !important;
        border-left: none !important;
        border-right: 2px dashed rgba(0,0,0,0.2) !important; /* Visible dark perforation */
        margin-left: 0 !important;
        margin-right: 0 !important;
        position: relative;
    }
    .multi-day-end {
        border-top-left-radius: 0 !important;
        border-bottom-left-radius: 0 !important;
        border-left: none !important;
        margin-left: 0 !important;
        position: relative;
    }
    /* Add a tiny connector line visual on hover? Optional */
    .multi-day-start:after, .multi-day-middle:after {
        content: '';
        position: absolute;
        right: -4px;
        top: 50%;
        width: 6px;
        height: 1px;
        background: rgba(0,0,0,0.1);
        z-index: 20;
    }
  </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col overflow-hidden">

  <!-- Header & Stats -->
  <header class="bg-white border-b px-6 py-4 flex justify-between items-center shadow-sm z-10">
    <div class="flex items-center space-x-3">
        <div class="bg-green-100 p-2 rounded-lg text-green-700">
            <i class="fas fa-calendar-check text-xl"></i>
        </div>
        <div>
            <h1 class="text-xl font-bold text-gray-800">Request Dashboard</h1>
            <p class="text-xs text-gray-500">Braincloud Operations</p>
        </div>
    </div>

    <div class="flex space-x-6 items-center">
        <!-- Stats -->
        <div class="flex space-x-4 mr-4">
            <div class="text-center">
                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-1">Active Today</p>
                <div class="flex items-center space-x-3 bg-gray-50 rounded-lg px-2 py-1 border border-gray-100 shadow-sm">
                    <div class="text-center px-1">
                         <span class="block text-lg font-bold text-teal-600 leading-none" id="stat-today-holiday">0</span>
                         <span class="text-[9px] text-teal-800 uppercase font-bold">School</span>
                    </div>
                    <div class="h-6 w-px bg-gray-200"></div>
                    <div class="text-center px-1">
                         <span class="block text-lg font-bold text-indigo-600 leading-none" id="stat-today-leave">0</span>
                         <span class="text-[9px] text-indigo-800 uppercase font-bold">Leave</span>
                    </div>
                </div>
            </div>
            
            <!-- Removed 'Action Needed' Stats as per request -->
        </div>

        <!-- Toolbar -->
        <div class="flex space-x-2 border-l pl-6">
            <!-- Filter Toggles -->
            <div class="flex bg-gray-100 rounded-lg p-1 mr-2">
                <button onclick="setFilter('all')" id="btn-filter-all" class="px-3 py-1 rounded-md text-xs font-bold bg-white text-gray-700 shadow-sm transition">ALL</button>
                <button onclick="setFilter('school')" id="btn-filter-school" class="px-3 py-1 rounded-md text-xs font-bold text-gray-500 hover:text-teal-600 transition">SCHOOL</button>
                <button onclick="setFilter('teacher')" id="btn-filter-teacher" class="px-3 py-1 rounded-md text-xs font-bold text-gray-500 hover:text-indigo-600 transition">TEACHER</button>
            </div>

            <!-- Email Check Mode -->
            <button onclick="toggleEmailMode()" id="btn-email-mode" class="bg-gray-100 hover:bg-gray-200 text-gray-600 p-2 rounded-lg text-sm transition shadow-sm mr-2 flex items-center space-x-1" title="Toggle Email Check Mode">
                <i class="far fa-envelope"></i> <span id="email-mode-text" class="hidden md:inline text-xs font-bold">MODE</span>
            </button>
            <button onclick="saveEmailStatus()" id="btn-email-save" class="hidden bg-green-500 hover:bg-green-600 text-white p-2 rounded-lg text-sm transition shadow-sm mr-2 animate-pulse" title="Save Email Status">
                <i class="fas fa-save"></i> <span class="text-xs font-bold ml-1">SAVE</span>
            </button>

            <button onclick="openAlarmModal()" class="bg-indigo-50 hover:bg-indigo-100 text-indigo-600 p-2 rounded-full w-10 h-10 flex items-center justify-center transition shadow-sm relative group" title="Notification Settings">
                <i class="fas fa-bell"></i>
                <span id="alarm-indicator" class="absolute top-0 right-0 h-3 w-3 bg-red-500 rounded-full border-2 border-white hidden"></span>
            </button>
            <button onclick="calendar.refetchEvents(); this.querySelector('i').classList.add('fa-spin'); setTimeout(() => this.querySelector('i').classList.remove('fa-spin'), 1000)" class="bg-gray-100 hover:bg-gray-200 text-gray-600 p-2 rounded-full w-10 h-10 flex items-center justify-center transition shadow-sm" title="Refresh Data">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>
  </header>

  <!-- Main Calendar Area -->
  <div class="flex-1 overflow-hidden p-4">
    <div class="bg-white rounded-xl shadow h-full p-4 overflow-hidden flex flex-col">
        <div id='calendar' class="flex-1"></div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="eventModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-40 backdrop-blur-sm modal-backdrop" onclick="closeModal()"></div>
    
    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl w-full max-w-4xl modal-content overflow-hidden">
        
        <!-- Modal Header -->
        <div id="modalHeader" class="p-6 text-white bg-gray-600 transition-colors duration-300">
            <div class="flex justify-between items-start">
                <div>
                    <span id="modalTypeBadge" class="inline-block px-2 py-1 rounded text-xs font-bold uppercase tracking-wider bg-white bg-opacity-20 mb-2">Type</span>
                    <h2 id="modalTitle" class="text-2xl font-bold leading-tight">Title</h2>
                    <p id="modalSubtitle" class="text-sm opacity-90 mt-1">Subtitle</p>
                </div>
                <button onclick="closeModal()" class="text-white opacity-70 hover:opacity-100 hover:rotate-90 transition-transform duration-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Modal Body -->
        <div class="p-6 space-y-5 max-h-[60vh] overflow-y-auto" id="modalDetailView">
            
            <!-- Dates -->
            <div class="flex items-center text-gray-600">
                <div class="w-8 flex justify-center"><i class="far fa-calendar-alt text-lg"></i></div>
                <span id="modalDates" class="font-medium text-lg text-gray-800">Date Range</span>
            </div>

            <!-- DB Verification Status (Injected) -->
            <div id="dbStatusContainer" class="hidden flex items-start text-sm">
                 <div class="w-8 flex justify-center mt-1"><i class="fas fa-database text-blue-500"></i></div>
                 <div class="flex-1 bg-blue-50 border border-blue-100 rounded-md p-2 text-blue-800">
                     <span class="font-bold">Database Record Found:</span> <span id="dbStatusText">Checking...</span>
                     <div id="coverageSummary" class="mt-1 pt-1 border-t border-blue-200 text-xs font-semibold hidden">
                         Checking coverage...
                     </div>
                 </div>
            </div>

            <!-- Reason -->
            <div class="flex items-start text-gray-600">
                <div class="w-8 flex justify-center mt-1"><i class="far fa-comment-alt"></i></div>
                <div class="flex-1">
                    <p class="text-xs uppercase text-gray-400 font-bold mb-1">Reason</p>
                    <p id="modalReason" class="text-gray-700 italic bg-gray-50 p-3 rounded-lg border border-gray-100 text-sm">Reason text...</p>
                </div>
            </div>
            
            <!-- Affected Classes -->
            <div id="modalClassesContainer" class="hidden">
                 <div class="flex items-start">
                    <div class="w-8 flex justify-center mt-1"><i class="fas fa-chalkboard-teacher text-gray-400"></i></div>
                    <div class="flex-1 w-full">
                        <p class="text-xs uppercase text-gray-400 font-bold mb-2">Affected Sessions</p>
                        <div class="border rounded-lg overflow-hidden relative min-h-[100px]">
                             <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-24">Time</th>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Class</th>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Teacher</th>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="modalClassesBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                             </table>
                             <div id="modalClassesLoading" class="hidden absolute inset-0 bg-white/80 flex items-center justify-center text-sm text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i> Syncing Data...
                             </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Free Status Change Dropdown -->
            <div class="flex items-center justify-between border-t pt-4 mt-2">
                 <div class="flex items-center w-full space-x-2">
                    <span class="text-sm font-semibold text-gray-500">Status:</span>
                    <select id="modalStatusSelect" class="flex-1 form-select block w-full pl-3 pr-10 py-2 text-base sm:text-sm rounded-md shadow-sm border bg-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="Pending">Pending</option>
                        <option value="Approved">Complete</option>
                        <option value="Rejected">Reject</option>
                    </select>
                    <button id="btnUpdateStatus" onclick="saveStatus()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded-md shadow-sm transition whitespace-nowrap">
                        <i class="fas fa-save mr-1"></i> Update
                    </button>
                 </div>
            </div>
        </div>

        <!-- EDIT VIEW (Hidden by default) -->
        <div class="p-6 space-y-4 max-h-[60vh] overflow-y-auto hidden" id="modalEditView">
            <div class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-4">
                <div class="flex">
                    <div class="flex-shrink-0"><i class="fas fa-exclamation-triangle text-amber-400"></i></div>
                    <div class="ml-3">
                        <p class="text-sm text-amber-700">You are editing a live request record.</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Start Date</label>
                    <input type="date" id="editStartDate" class="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-200 outline-none" onchange="refreshEditSessions()">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">End Date</label>
                    <input type="date" id="editEndDate" class="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-200 outline-none" onchange="refreshEditSessions()">
                </div>
            </div>

            <div>
                 <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Reason</label>
                 <textarea id="editReason" rows="2" class="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-200 outline-none"></textarea>
            </div>

            <div>
                <div class="flex justify-between items-center mb-2">
                     <label class="block text-xs font-bold text-gray-500 uppercase">Affected Sessions</label>
                     <span class="text-[10px] text-gray-400" id="editSessionCount">0 sessions found</span>
                </div>
                <div class="border rounded-lg overflow-hidden h-48 relative">
                    <div class="absolute inset-0 overflow-y-auto bg-white p-2" id="editSessionList">
                        <!-- Checkboxes go here -->
                        <div class="text-center text-gray-400 mt-10">Select dates to load sessions...</div>
                    </div>
                    <!-- Spinner -->
                    <div id="editSessionLoading" class="absolute inset-0 bg-white/80 flex items-center justify-center hidden">
                        <i class="fas fa-circle-notch fa-spin text-indigo-500 text-2xl"></i>
                    </div>
                </div>
                <p class="text-[10px] text-gray-400 mt-1">* Uncheck sessions to exclude them from this ticket (Partial Leave/Holiday).</p>
            </div>

            <div class="border-t pt-4">
                 <label class="block text-xs font-bold text-indigo-600 uppercase mb-1">Editor Name <span class="text-red-500">*</span></label>
                 <input type="text" id="editEditorName" placeholder="Enter your name to sign this edit" class="w-full border-2 border-indigo-100 rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>
        </div>

        <div class="p-4 bg-gray-50 border-t flex justify-between items-center">
             <!-- Left Side Actions -->
             <div id="modalLeftActions">
                 <button onclick="toggleEditMode()" id="btnToggleEdit" class="text-gray-500 hover:text-indigo-600 text-sm font-medium px-2 py-1 rounded hover:bg-indigo-50 transition">
                    <i class="fas fa-edit mr-1"></i> Edit Ticket
                 </button>
             </div>
             
             <!-- Right Side Actions -->
             <div class="flex space-x-2">
                <button onclick="closeModal()" class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 text-sm font-medium text-gray-700">Close</button>
                <button id="btnSaveEdit" onclick="saveEdit()" class="hidden px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded-lg shadow-sm">
                    Save Changes
                </button>
             </div>
        </div>
    </div>
  </div>

  <!-- Alarm Settings Modal -->
  <div id="alarmModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-40 backdrop-blur-sm modal-backdrop" onclick="closeAlarmModal()"></div>
    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-xl shadow-2xl w-full max-w-sm modal-content">
        <div class="p-5 border-b bg-indigo-600 text-white rounded-t-xl">
            <h3 class="font-bold text-lg"><i class="fas fa-bell mr-2"></i> Notification Settings</h3>
            <p class="text-xs opacity-80">Daily Discord alerts for pending tickets.</p>
        </div>
        
        <div class="p-5">
            <!-- Add New Alarm -->
            <div class="flex space-x-2 mb-4">
                <input type="time" id="newAlarmTime" class="border rounded p-2 flex-1 focus:ring-2 focus:ring-indigo-200 outline-none">
                <button onclick="addAlarm()" class="bg-indigo-600 text-white px-3 rounded hover:bg-indigo-700 shadow-md"><i class="fas fa-plus"></i></button>
            </div>

            <!-- Alarm List -->
            <div class="space-y-3 max-h-60 overflow-y-auto" id="alarmList">
                <!-- Injected via JS -->
                 <div class="text-center text-gray-400 text-sm py-4"><i class="fas fa-circle-notch fa-spin"></i> Loading...</div>
            </div>
            
            <!-- Manual Trigger -->
            <div class="mt-4 pt-4 border-t">
                <button onclick="manualTrigger()" class="w-full bg-orange-100 hover:bg-orange-200 text-orange-700 font-bold py-2 rounded flex items-center justify-center transition">
                    <i class="fas fa-paper-plane mr-2"></i> Send Notification Now
                </button>
            </div>

            <p class="text-[10px] text-gray-400 mt-4 italic text-center">
                * Alarms are universal. Only fires if page/bot is active.
            </p>
        </div>

        <div class="p-3 bg-gray-50 text-right rounded-b-xl">
            <button onclick="closeAlarmModal()" class="text-sm text-gray-600 hover:text-gray-900 font-medium px-3 py-1">Close</button>
        </div>
    </div>
  </div>

<script>
    // --- Config ---
    const CONFIG = {
        SUPABASE_URL: "https://cgznmxcecljfybcgujjb.supabase.co",
        SUPABASE_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnem5teGNlY2xqZnliY2d1ampiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2Nzc2NTI1MywiZXhwIjoyMDgzMzQxMjUzfQ.kTov9RFS-FVDNZokkslR0jFH2zaKTUYSBH9NQ8aItlQ",
        DISCORD_WEBHOOK: "https://discordapp.com/api/webhooks/1463030732602609665/-V-K56hgPh5mjcaFiFpc_6ZLhoqTceEQzuWXO7k4-0ztIuLXF6lk_TEKX6uIfKXWl5TX"
    };

    let calendar;
    let currentEventId = null;
    let teacherMap = new Map(); 
    let schoolMap = new Map(); // id -> name
    let schoolCodeMap = new Map(); // code -> id
    let activeAlarms = [];
    let currentFilter = 'all'; // 'all', 'school', 'teacher'
    let globalRequests = []; // Store for day render
    let isEmailMode = false;
    let pendingEmailChanges = new Map(); // id -> boolean (true=checked/sent, false=unchecked)
    const db = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);

    // --- Init ---
    document.addEventListener('DOMContentLoaded', async function() {
        await Promise.all([loadTeachers(), loadSchools()]);
        
        // Setup Calendar
        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            themeSystem: 'standard',
            eventOrder: function(a, b) {
                // Stable sort by creation time to keep multi-day chunks aligned
                return (a.extendedProps.orderKey || 0) - (b.extendedProps.orderKey || 0);
            },
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,dayGridWeek,listWeek'
            },
            height: '100%',
            views: {
                dayGridMonth: { dayMaxEvents: 6 },
                dayGridWeek: { dayMaxEvents: false }
            },
            eventClick: function(info) { 
                if (isEmailMode) {
                    handleEmailToggle(info.event);
                } else {
                    openModal(info.event); 
                }
            },
            events: fetchEvents,
            eventContent: renderEventContent,
            datesSet: function() { setTimeout(renderDailyStats, 100); }
        });
        calendar.render();

        // Setup Alarms
        setupAlarmSystem();
    });

    // --- Alarm System ---
    async function setupAlarmSystem() {
        // 1. Load Alarms
        await fetchAlarms();
        
        // 2. Start Polling (Every 30s)
        setInterval(checkAlarms, 30000); 
    }

    async function fetchAlarms() {
        try {
            const { data, error } = await db.from('admin_alarms').select('*').order('time');
            if(error) {
                // If table missing, maybe just warn or handle gracefully
                console.warn("Alarm table might be missing:", error);
                activeAlarms = []; 
                return;
            }
            // Logic: Default 3PM
            const hasDefault = data.find(a => a.time === '15:00');
            if(!hasDefault && data.length === 0) {
                // Auto-create default 3:00 PM if DB empty
                await db.from('admin_alarms').insert({ time: '15:00', label: 'Daily Default' });
                return fetchAlarms(); // Retry
            }
            activeAlarms = data;
            renderAlarmList();
        } catch(e) { console.error(e); }
    }

    function renderAlarmList() {
        const list = document.getElementById('alarmList');
        if(activeAlarms.length === 0) {
            list.innerHTML = `<div class="text-sm text-gray-400 text-center">No active alarms.</div>`;
            return;
        }
        
        list.innerHTML = activeAlarms.map(a => `
            <div class="flex items-center justify-between bg-gray-50 p-2 rounded border border-gray-100">
                <div class="flex items-center">
                    <span class="font-mono text-lg font-bold text-gray-700">${a.time}</span>
                    ${a.label ? `<span class="text-xs text-gray-400 ml-2">(${a.label})</span>` : ''}
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="toggleAlarm(${a.id}, ${!a.is_active})" class="${a.is_active ? 'text-green-500' : 'text-gray-300'} hover:scale-110 transition">
                        <i class="fas fa-toggle-${a.is_active ? 'on' : 'off'} text-2xl"></i>
                    </button>
                    <button onclick="deleteAlarm(${a.id})" class="text-red-400 hover:text-red-600 ml-2 text-sm">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');

        // Indicator
        const anyActive = activeAlarms.some(a => a.is_active);
        const ind = document.getElementById('alarm-indicator');
        if(ind) {
             if(anyActive) ind.classList.remove('hidden'); else ind.classList.add('hidden');
        }
    }

    async function addAlarm() {
        const time = document.getElementById('newAlarmTime').value;
        if(!time) return;
        
        await db.from('admin_alarms').insert({ time: time, is_active: true });
        fetchAlarms();
    }

    async function deleteAlarm(id) {
        if(!confirm("Delete this alarm?")) return;
        await db.from('admin_alarms').delete().eq('id', id);
        fetchAlarms();
    }

    async function toggleAlarm(id, newState) {
        await db.from('admin_alarms').update({ is_active: newState }).eq('id', id);
        fetchAlarms();
    }

    function openAlarmModal() { document.getElementById('alarmModal').classList.remove('hidden'); }
    function closeAlarmModal() { document.getElementById('alarmModal').classList.add('hidden'); }

    // --- Polling Logic ---
    async function checkAlarms() {
        const now = new Date();
        const currentStr = now.toTimeString().substring(0,5); // "HH:MM"
        
        // Find matching active alarm
        const match = activeAlarms.find(a => a.time === currentStr && a.is_active);
        
        if(match) {
            // Strict Debounce: Ensure we only fire ONCE per minute cycle.
            // Using LocalStorage to track the last fired timestamp key (Date + Time + AlarmID)
            const uniqueKey = `alarm_fired_${currentStr}_${match.id}`;
            const alreadyFiredToday = localStorage.getItem(uniqueKey);
            
            // Check expiry of old keys? Not strictly needed for a single day cycle, but good hygiene
            // Just check if we exist
            if(alreadyFiredToday) {
                 console.log(`Skipping alarm ${currentStr}, already fired.`);
                 return; 
            }

            const pendingCount = window.pendingRequestsCount || 0;
            
            if(pendingCount > 0) {
                console.log(`â° ALARM: ${currentStr} - Pending: ${pendingCount}. Sending Webhook.`);
                await sendDiscordNotification(pendingCount); // Await to ensure completion
                
                // Mark as done for this specific minute
                localStorage.setItem(uniqueKey, 'true');
                
                // Cleanup old keys (optional, but keeps storage clean)
                // Remove any key that doesn't match current time
                Object.keys(localStorage).forEach(k => {
                    if(k.startsWith('alarm_fired_') && k !== uniqueKey) {
                        localStorage.removeItem(k);
                    }
                });
            }
        }
    }

    async function manualTrigger() {
        if(!confirm("Send notification to Discord now?")) return;
        const pendingCount = window.pendingRequestsCount || 0;
        if(pendingCount === 0) { alert("No pending tickets to notify about."); return; }
        await sendDiscordNotification(pendingCount);
        alert("Notification Sent!");
    }

    async function sendDiscordNotification(count) {
        if(!CONFIG.DISCORD_WEBHOOK || CONFIG.DISCORD_WEBHOOK.includes("REPLACE")) return;
        
        // Simple dedupe: Check if we alerted recently in LocalStorage?
        // const lastAlert = localStorage.getItem('last_discord_alert');
        // const nowTs = Date.now();
        // if(lastAlert && (nowTs - parseInt(lastAlert)) < 60000) return; // Ignore if < 1m ago

        // Fetch detailed pending list for the embed
        let pendingDetails = [];
        try {
            const { data } = await db.from('requests_log').select('school_code, user_name, start_date, request_category').eq('status', 'Pending').limit(5);
            if(data) pendingDetails = data;
        } catch(e) {}

        const schoolCount = pendingDetails.filter(r => r.request_category !== 'Teacher').length;
        const teacherCount = pendingDetails.filter(r => r.request_category === 'Teacher').length;
        
        // Build Description
        let desc = `There are **${count}** pending ticket(s) waiting for approval.\n\n`;
        pendingDetails.forEach(r => {
             const typeIcon = r.request_category === 'Teacher' ? 'ðŸ‘¤' : 'ðŸ«';
             const title = r.request_category === 'Teacher' ? r.user_name : r.school_code;
             desc += `> ${typeIcon} **${title}** (${r.start_date})\n`;
        });
        if(count > 5) desc += `> ... and ${count - 5} more.\n`;

        const payload = {
            username: "Braincloud Admin Bot",
            avatar_url: "https://cdn-icons-png.flaticon.com/512/3652/3652191.png",
            embeds: [{
                title: "ðŸ”” Pending Requests Action Required",
                description: desc,
                color: 15105570, // Orange
                fields: [
                    { name: "School Requests", value: `${schoolCount} (Visible)`, inline: true },
                    { name: "Teacher Requests", value: `${teacherCount} (Visible)`, inline: true },
                    { name: "Dashboard", value: `[Click to Manage](${window.location.href})` }
                ],
                footer: { text: "Braincloud Operations â€¢ " + new Date().toLocaleString('en-US', { timeZone: 'Asia/Bangkok' }) }
            }]
        };

        try {
            await fetch(CONFIG.DISCORD_WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            // localStorage.setItem('last_discord_alert', nowTs.toString());
        } catch(e) { console.error("Webhook failed", e); }
    }

    // --- Core Calendar Logic ---
    
    function renderEventContent(arg) {
        const props = arg.event.extendedProps;
        let icon = '';
        if(props.isLeave) {
            if((props.leave_type || '').toLowerCase().includes('sick')) icon = '<i class="fas fa-briefcase-medical mr-1 opacity-70"></i>';
            else if((props.leave_type || '').toLowerCase().includes('business')) icon = '<i class="fas fa-briefcase mr-1 opacity-70"></i>';
            else icon = '<i class="fas fa-user-clock mr-1 opacity-70"></i>';
        } else {
            icon = '<i class="fas fa-school mr-1 opacity-70"></i>';
        }

        // Email Mode Override
        if (isEmailMode) {
            // Updated for per-day tracking: Use event.id (composite) and dayEmailSent
            const originalStatus = props.dayEmailSent === true;
            const isChecked = pendingEmailChanges.has(arg.event.id) ? pendingEmailChanges.get(arg.event.id) : originalStatus;
            
            let badgeHtml = '';
            if(props.badgeText && props.badgeText !== 'FULL') {
                badgeHtml = `<span class="ml-1 text-[9px] px-1 rounded bg-white/40 font-bold whitespace-nowrap opacity-90">${props.badgeText}</span>`;
            }

            // Checkbox + Title Layout
            return { html: `
                <div class="flex items-center overflow-hidden w-full h-full px-1 space-x-1">
                    <input type="checkbox" class="form-checkbox h-3 w-3 min-w-[12px] text-indigo-600 rounded border-gray-300 transition duration-150 ease-in-out pointer-events-none" ${isChecked ? 'checked' : ''}>
                    <span class="truncate font-semibold text-xs flex-1 opacity-90">${icon} ${arg.event.title}</span>
                    ${badgeHtml}
                </div>
            ` };
        }

        // Normal View
        let html = `<div class="flex items-center overflow-hidden w-full h-full px-1"><span class="truncate font-semibold text-xs flex-1">${icon} ${arg.event.title}</span>`;
        if(props.badgeText && props.badgeText !== 'FULL') {
            html += `<span class="ml-1 text-[9px] px-1 rounded bg-white/40 font-bold whitespace-nowrap opacity-90">${props.badgeText}</span>`;
        }
        
        // Coverage Status Icons
        if (props.coverageStatus === 'all_cancelled' || props.coverageStatus === 'all_covered' || props.coverageStatus === 'all_resolved') {
             // GREEN CHECK = Resolved (Covered or Cancelled)
             html += `<i class="fas fa-check-circle text-green-500 ml-1 text-xs bg-white rounded-full" title="Resolved"></i>`;
        } else if (props.coverageStatus === 'partial') {
             // ORANGE ALERT = Action Needed
             html += `<i class="fas fa-exclamation-circle text-orange-400 ml-1 text-xs bg-white rounded-full" title="Action Needed"></i>`;
        }

        // Email Sent Icon (Small Envelope if NOT in email mode and sent)
        if (props.email_sent || props.dayEmailSent) {
            html += `<i class="fas fa-envelope text-indigo-500 ml-1 text-xs" title="Email Sent"></i>`;
        }

        html += `</div>`;
        return { html: html };
    }

    // --- Email Tracking Logic ---
    function toggleEmailMode() {
        isEmailMode = !isEmailMode;
        
        const btn = document.getElementById('btn-email-mode');
        const saveBtn = document.getElementById('btn-email-save');
        const modeText = document.getElementById('email-mode-text');
        
        if (isEmailMode) {
            btn.classList.remove('bg-gray-100', 'text-gray-600');
            btn.classList.add('bg-indigo-100', 'text-indigo-700', 'ring-2', 'ring-indigo-300');
            modeText.innerText = "EXIT";
            calendar.render(); // Re-render to show checkboxes
        } else {
            // Cancel mode
            pendingEmailChanges.clear();
            btn.classList.add('bg-gray-100', 'text-gray-600');
            btn.classList.remove('bg-indigo-100', 'text-indigo-700', 'ring-2', 'ring-indigo-300');
            saveBtn.classList.add('hidden');
            modeText.innerText = "MODE";
            calendar.render(); // Re-render to show normal events
        }
    }

    function handleEmailToggle(event) {
        const p = event.extendedProps;
        // Use event.id (Composite) for map key
        const compositeId = event.id; 
        const currentVal = pendingEmailChanges.has(compositeId) ? pendingEmailChanges.get(compositeId) : (p.dayEmailSent === true);
        
        const newVal = !currentVal;
        pendingEmailChanges.set(compositeId, newVal);
        
        // Show/Hide Save Button
        const saveBtn = document.getElementById('btn-email-save');
        if (pendingEmailChanges.size > 0) saveBtn.classList.remove('hidden');
        else saveBtn.classList.add('hidden');
        
        // Force re-render of this specific event
        event.setExtendedProp('_forceRender', Math.random()); 
    }

    async function saveEmailStatus() {
       if (pendingEmailChanges.size === 0) return;
       
       const btn = document.getElementById('btn-email-save');
       // Loading State
       const originalContent = '<i class="fas fa-save"></i> <span class="text-xs font-bold ml-1">SAVE</span>';
       btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
       btn.disabled = true;
       
       try {
           // We need to group updates by original ID because we are storing JSON
           // Map<originalId, { date: boolean }>
           const updatesById = new Map();
           
           for (const [compositeId, makeActive] of pendingEmailChanges) {
               const [idStr, dateStr] = compositeId.split('_');
               const id = parseInt(idStr);
               
               if (!updatesById.has(id)) updatesById.set(id, {});
               updatesById.get(id)[dateStr] = makeActive;
           }

           // Process each row update
           // fetch current JSONS first to merge? Or can we blindly merge?
           // Supabase update with jsonb matches merges at top level? No, it replaces the column.
           // So we MUST read-modify-write.
           
           const idsToUpdate = Array.from(updatesById.keys());
           const { data: currentRows, error: fetchError } = await db.from('requests_log')
               .select('id, daily_email_status')
               .in('id', idsToUpdate);
               
           if(fetchError) throw fetchError;
           
           const updatePromises = currentRows.map(row => {
               const newStatus = { ...(row.daily_email_status || {}) }; // Clone existing
               const changes = updatesById.get(row.id);
               
               // Apply changes
               Object.keys(changes).forEach(date => {
                   if (changes[date]) newStatus[date] = true;
                   else delete newStatus[date]; // Remove false/unchecked to keep clean? Or set to false? Let's use boolean.
               });
               
               // If we want explicit false, set false. If we want concise, delete.
               // Let's set to explicit boolean to be safe.
               Object.keys(changes).forEach(date => {
                    newStatus[date] = changes[date];
               });

               return db.from('requests_log').update({ daily_email_status: newStatus }).eq('id', row.id);
           });
           
           await Promise.all(updatePromises);
           
           pendingEmailChanges.clear();
           
           // Restore button state before hiding
           btn.innerHTML = originalContent;
           btn.disabled = false;

           toggleEmailMode(); // Exit mode and reset UI
           calendar.refetchEvents(); // Get fresh data
           
       } catch (e) {
           alert("Error saving: " + e.message + "\n\n(Make sure 'daily_email_status' column exists: alter table requests_log add column daily_email_status jsonb default '{}'::jsonb;)");
           btn.innerHTML = originalContent; // Restore text on error
           btn.disabled = false;
       }
       // If success, toggleEmailMode handles the UI reset
    }

    async function loadTeachers() {
        try {
            const { data } = await db.from('dim_user').select('user_id, firstname_en, lastname_en, nickname_en');
            if(data) data.forEach(u => {
                if(u.user_id) {
                    let name = `${u.firstname_en || ''} ${u.lastname_en || ''}`.trim();
                    if(u.nickname_en) name += ` (${u.nickname_en})`;
                    teacherMap.set(String(u.user_id), name);
                }
            });
        } catch(e) {}
    }

    async function loadSchools() {
        try {
            const { data } = await db.from('dim_school').select('school_id, school_code, school_name_en');
            if(data) data.forEach(s => {
                if(s.school_id) {
                    schoolMap.set(String(s.school_id), s.school_name_en);
                    if(s.school_code) schoolCodeMap.set(s.school_code, String(s.school_id));
                }
            });
        } catch(e) {}
    }

    async function fetchEvents(fetchInfo, successCallback, failureCallback) {
        try {
            const { data, error } = await db.from('requests_log').select('*').order('created_at', { ascending: false });
            if (error) throw error;

            updateStats(data);
            
            // Transform Data into Events (Split Multi-day)
            const events = [];
            
            data.forEach(r => {
                const isLeave = r.request_category === 'Teacher' || r.school_code === 'N/A';
                
                // FILTER LOGIC
                if (currentFilter === 'school' && isLeave) return;
                if (currentFilter === 'teacher' && !isLeave) return;
                
                const isPending = r.status === 'Pending';
                
                let bg, border, text;
                
                // SIMPLIFIED COLOR SCHEME
                if (r.status === 'Rejected' || r.status === 'Cancelled') { 
                    bg = '#f3f4f6'; border = '#e5e7eb'; text = '#9ca3af'; 
                } else if (isLeave) {
                    bg = '#e0e7ff'; border = '#c7d2fe'; text = '#3730a3';
                } else {
                    bg = '#ccfbf1'; border = '#99f6e4'; text = '#115e59'; 
                }

                let classNames = [];
                if(isPending) classNames.push('status-pulse');

                let displayName = r.user_name || "Unknown";
                if(isLeave && r.teacher_id) {
                    const mapped = teacherMap.get(String(r.teacher_id));
                    displayName = mapped || `${r.user_name || 'Teacher'} (${r.teacher_id})`;
                } else if (!isLeave) displayName = r.school_code;

                // Badge Logic
                let badge = "";
                const sessions = parseSessions(r.affected_sessions);
                if (typeof sessions === 'object' && sessions.startTime) badge = `${sessions.startTime.substring(0,5)}-${sessions.endTime.substring(0,5)}`;
                else if (Array.isArray(sessions) && sessions.length > 0) {
                     const times = sessions.map(s => {
                        const parts = s.split('_');
                        return parts.length >= 3 ? parts[2].substring(0,5) : null;
                     }).filter(Boolean).sort();
                     if (times.length > 0) badge = (times.length > 1) ? `${times[0]}..` : times[0];
                }

                // SPLIT DAYS LOGIC
                let loopDate = new Date(r.start_date);
                const endDate = new Date(r.end_date || r.start_date);
                
                // Multi-day calculation
                const diffTime = Math.abs(endDate - loopDate);
                const totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                let dayCounter = 1;

                // Sort Order: Use timestamp (newer on top or bottom). DB returns DESC.
                // We want consistent order across days.
                const orderKey = new Date(r.created_at).getTime();
                
                // Safety limiter for infinite loops
                let limit = 0;
                while (loopDate <= endDate && limit < 365) {
                    const dStr = loopDate.toISOString().split('T')[0];
                    const compositeId = `${r.id}_${dStr}`;
                    
                    // Multi-day Visual Chain Logic
                    let chainClass = '';
                    if (totalDays > 1) {
                        if (dayCounter === 1) chainClass = 'multi-day-start';
                        else if (dayCounter === totalDays) chainClass = 'multi-day-end';
                        else chainClass = 'multi-day-middle';
                    }

                    // Determine Email Status for this specific day
                    // Check new JSON column 'daily_email_status' OR fallback to legacy 'email_sent'
                    const statusJson = r.daily_email_status || {};
                    const isDaySent = statusJson[dStr] === true || (r.email_sent === true && statusJson[dStr] === undefined);

                    events.push({
                        id: compositeId,
                        title: displayName,
                        start: dStr,
                        allDay: true,
                        backgroundColor: bg, borderColor: border, textColor: text, 
                        classNames: [...classNames, chainClass], 
                        extendedProps: { 
                            ...r, 
                            mapped_name: displayName, 
                            badgeText: badge, 
                            leave_type: r.type, 
                            isLeave: isLeave,
                            originalId: r.id,      // Keep reference to DB ID
                            eventDate: dStr,       // Explicit Date
                            dayEmailSent: isDaySent, // Computed Day Status
                            orderKey: orderKey     // Keep them aligned
                        }
                    });

                    loopDate.setDate(loopDate.getDate() + 1);
                    dayCounter++;
                    limit++;
                }
            });
            
            if(successCallback) successCallback(events);
            
            // Trigger coverage check for visible events
            setTimeout(() => checkCoverageForView(), 500);

        } catch (err) { failureCallback(err); }
    }
    
    // --- Filter Logic ---
    function setFilter(type) {
        currentFilter = type;
        
        // Update UI
        ['all', 'school', 'teacher'].forEach(t => {
            const btn = document.getElementById(`btn-filter-${t}`);
            if(t === type) {
                btn.className = "px-3 py-1 rounded-md text-xs font-bold bg-white text-gray-800 shadow-sm ring-1 ring-gray-200 transition transform scale-105";
            } else {
                btn.className = "px-3 py-1 rounded-md text-xs font-bold text-gray-400 hover:text-gray-600 transition";
            }
        });

        calendar.refetchEvents();
    }

    function parseSessions(raw) {
        if(!raw) return [];
        try { if(typeof raw === 'string') { if(raw.startsWith('[')) return JSON.parse(raw); if(raw.startsWith('{')) return JSON.parse(raw); return [raw]; } return raw; } catch(e) { return []; }
    }

    function updateStats(data) {
        globalRequests = data; // Save for renderDailyStats
        
        // 1. Pulsing (Pending) Count
        const pending = data.filter(d => d.status === 'Pending').length;
        window.pendingRequestsCount = pending;
        
        // 2. Today's Stats
        const now = new Date();
        const todayStr = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        
        const activeToday = data.filter(r => {
            if(r.status === 'Rejected' || r.status === 'Cancelled') return false;
            const end = r.end_date || r.start_date;
            return r.start_date <= todayStr && end >= todayStr;
        });
        
        const schoolCount = activeToday.filter(r => r.request_category !== 'Teacher' && r.school_code !== 'N/A').length;
        const leaveCount = activeToday.filter(r => r.request_category === 'Teacher' || r.school_code === 'N/A').length;
        
        const scEl = document.getElementById('stat-today-holiday');
        if(scEl) scEl.innerText = schoolCount;
        const lvEl = document.getElementById('stat-today-leave');
        if(lvEl) lvEl.innerText = leaveCount;
        
        // Trigger Daily Stats Render
        setTimeout(renderDailyStats, 50);
    }

    function renderDailyStats() {
        // Clear old stats
        document.querySelectorAll('.day-stat-badge').forEach(e => e.remove());
        
        if(!globalRequests || globalRequests.length === 0) return;

        // Group by Date
        const stats = new Map(); // Date -> { s:0, l:0 }
        
        globalRequests.forEach(r => {
             if(r.status === 'Rejected' || r.status === 'Cancelled') return;

             const isLeave = r.request_category === 'Teacher' || r.school_code === 'N/A';
             // Expand date range
             let curr = new Date(r.start_date);
             const end = new Date(r.end_date || r.start_date);
             
             let loopLimit = 0;
             while(curr <= end && loopLimit < 60) {
                 const dStr = curr.toISOString().split('T')[0];
                 if(!stats.has(dStr)) stats.set(dStr, { s:0, l:0 });
                 const entry = stats.get(dStr);
                 if(isLeave) entry.l++; else entry.s++;
                 
                 curr.setDate(curr.getDate() + 1);
                 loopLimit++;
             }
        });

        // Inject into DOM
        stats.forEach((val, date) => {
             // Find Day Cell Number container
             const cell = document.querySelector(`.fc-day[data-date="${date}"] .fc-daygrid-day-top`); 
             if(cell) {
                 const badge = document.createElement('div');
                 badge.className = 'day-stat-badge flex space-x-1 absolute top-2 left-10 pointer-events-none opacity-90 z-0'; 
                 // Positioning: Top-2, Left-10 (Next to date number usually)
                 
                 badge.innerHTML = `
                    ${val.s > 0 ? `<span class="bg-teal-50 text-teal-700 text-[9px] font-bold px-1.5 py-0.5 rounded-full ring-1 ring-teal-200">${val.s} SCH</span>` : ''}
                    ${val.l > 0 ? `<span class="bg-indigo-50 text-indigo-700 text-[9px] font-bold px-1.5 py-0.5 rounded-full ring-1 ring-indigo-200">${val.l} LEAVE</span>` : ''}
                 `;
                 cell.style.position = 'relative'; 
                 cell.appendChild(badge);
             }
        });
    }

    async function openModal(event) {
        const p = event.extendedProps;
        currentEventId = p.originalId || p.id;

        // RESET UI STATE (Ensure we start in View Mode)
        document.getElementById('modalDetailView').classList.remove('hidden');
        document.getElementById('modalEditView').classList.add('hidden');
        document.getElementById('btnToggleEdit').innerHTML = '<i class="fas fa-edit mr-1"></i> Edit Ticket';
        document.getElementById('btnSaveEdit').classList.add('hidden');
        
        // Dynamic Header
        const header = document.getElementById('modalHeader');
        let bgClass = 'bg-gray-600';
        if(p.status === 'Rejected') bgClass = 'bg-gray-500';
        else if(p.status === 'Cancelled') bgClass = 'bg-red-800'; // Dark red for cancelled
        else if (p.isLeave) {
             const type = (p.leave_type || '').toLowerCase();
             if(type.includes('sick')) bgClass = 'bg-rose-600'; else if(type.includes('business')) bgClass = 'bg-blue-600'; else bgClass = 'bg-indigo-600';
        } else bgClass = p.badgeText ? 'bg-amber-500' : 'bg-teal-600';
        header.className = `p-6 text-white transition-colors duration-300 ${bgClass}`;

        document.getElementById('modalTypeBadge').innerText = p.isLeave ? (p.type || "Teacher Leave") : "School Holiday";
        document.getElementById('modalTitle').innerText = p.mapped_name || p.title; 
        document.getElementById('modalSubtitle').innerText = "Requested by: " + (p.user_name || "Guest");
        
        let dateText = p.start_date; if(p.end_date && p.end_date !== p.start_date) dateText += ` âž” ${p.end_date}`;
        document.getElementById('modalDates').innerText = dateText;
        document.getElementById('modalReason').innerText = (p.reason && p.reason !== 'undefined') ? p.reason : "No specific reason provided.";
        
        // --- Simple DB Verification (Teacher Only) ---
        const dbStat = document.getElementById('dbStatusContainer');
        const container = document.getElementById('modalClassesContainer');
        const tbody = document.getElementById('modalClassesBody');
        const loading = document.getElementById('modalClassesLoading');
        
        // Robust Reset: Always restore "Clean" state first to fix destruction
        dbStat.innerHTML = `
             <div class="w-8 flex justify-center mt-1"><i class="fas fa-database text-blue-500"></i></div>
             <div class="flex-1 bg-blue-50 border border-blue-100 rounded-md p-2 text-blue-800">
                 <span class="font-bold">Database Record Found:</span> <span id="dbStatusText">Checking...</span>
                 <div id="coverageSummary" class="mt-1 pt-1 border-t border-blue-200 text-xs font-semibold hidden">
                     Checking coverage...
                 </div>
             </div>
        `;
        dbStat.className = "hidden flex items-start text-sm";
        tbody.innerHTML = ''; container.classList.add('hidden'); loading.classList.add('hidden');

        // Main Logic
        // 1. If Teacher Leave, check Reference Table
        if(p.isLeave && p.teacher_id) {
             const { data } = await db.from('fact_teacher_unavailability')
               .select('*')
               .eq('teacher_id', p.teacher_id)
               .lte('start_date', p.end_date || p.start_date) 
               .gte('end_date', p.start_date);
             
             if(data && data.length > 0) {
                dbStat.className = "flex items-start text-sm mt-2"; 
                const types = [...new Set(data.map(u => u.unavailability_type || 'Unspecified'))].join(', ');
                document.getElementById('dbStatusText').innerText = `Found ${data.length} record(s). Type: ${types}`;
             } else {
                dbStat.className = "flex items-start text-sm mt-2 opacity-75"; 
                dbStat.innerHTML = `<div class="w-8 flex justify-center mt-1"><i class="fas fa-exclamation-circle text-orange-400"></i></div><div class="flex-1 bg-orange-50 border border-orange-100 rounded-md p-2 text-orange-700 italic">No official 'unavailability' record found for these dates. <br><span class="text-xs not-italic text-gray-500">Checked range: ${p.start_date} to ${p.end_date || p.start_date}</span></div>`;
             } // End Teacher Check
        } 
        else if (!p.isLeave) {
             // --- School Holiday Coverage Check ---
             const schoolId = schoolCodeMap.get(p.school_code);
             if(schoolId) {
                 loading.classList.remove('hidden'); container.classList.remove('hidden');
                 
                 // Smart Logic: Check for Affected Sessions List First
                 let data = [];
                 let isSpecific = false;
                 
                 const raw = parseSessions(p.affected_sessions);

                 if (Array.isArray(raw) && raw.length > 0) {
                     // 1. Partial Mode: Fetch specific IDs
                     isSpecific = true;
                     const ids = raw.filter(x => typeof x === 'string' && x.length > 5); // Basic validation
                     if(ids.length > 0) {
                         const { data: partialData } = await db.from('fact_daily_session').select('*').in('session_id', ids);
                         data = partialData || [];
                     }
                 } 
                 
                 if (!isSpecific || data.length === 0) {
                     // 2. Fallback: Fetch ALL for school/date range
                     const { data: fullData } = await db.from('fact_daily_session')
                        .select('*')
                        .eq('school_id', schoolId)
                        .gte('date', p.start_date)
                        .lte('date', p.end_date || p.start_date);
                     data = fullData || [];
                 }
                 
                 loading.classList.add('hidden');
                 
                 if(data && data.length > 0) {
                     // Sort Chronologically
                     data.sort((a, b) => {
                        if (a.date !== b.date) return a.date.localeCompare(b.date);
                        return (a.start_time || '').localeCompare(b.start_time || '');
                     });

                     // Check for NON-cancelled (Fuzzy match)
                     const active = data.filter(s => !(s.status || '').includes('Cancelled'));
                     if(active.length === 0) {
                         dbStat.className = "flex items-start text-sm mt-2"; 
                         dbStat.innerHTML = `<div class="w-8 flex justify-center mt-1"><i class="fas fa-check-circle text-teal-600"></i></div><div class="flex-1 bg-teal-50 border border-teal-100 rounded-md p-2 text-teal-800 font-bold">All ${data.length} sessions are Cancelled. Operations Complete.</div>`;
                     } else {
                         dbStat.className = "flex items-start text-sm mt-2"; 
                         dbStat.innerHTML = `<div class="w-8 flex justify-center mt-1"><i class="fas fa-exclamation-triangle text-red-500"></i></div><div class="flex-1 bg-red-50 border border-red-100 rounded-md p-2 text-red-800 font-bold">Alert: ${active.length} sessions are still Active (Not Cancelled).</div>`;
                     }
                     
                     // List Sessions
                     tbody.innerHTML = data.map(s => {
                         const isCancelled = (s.status || '').includes('Cancelled');
                         let statusHtml = `<span class="px-2 py-0.5 rounded text-xs font-bold bg-green-100 text-green-700">Active</span>`;
                         if (isCancelled) statusHtml = `<span class="px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-700">${s.status}</span>`;
                         
                         // Date Format: DD-Jan-YYYY
                         let dateDisplay = s.date;
                         if(s.date) {
                             const [y, m, d] = s.date.split('-');
                             const mon = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][parseInt(m)-1];
                             dateDisplay = `${d}-${mon}-${y}`;
                         }

                         // Teacher Name
                         const teacherName = teacherMap.get(String(s.actual_teacher_id)) || s.actual_teacher_id || '-';

                         return `<tr class="hover:bg-gray-50 border-b">
                            <td class="px-3 py-2 text-sm font-bold text-blue-600 whitespace-nowrap">${dateDisplay} ${(s.start_time||'').substring(0,5)}</td>
                            <td class="px-3 py-2 text-sm text-gray-700">${s.class_name || '-'}</td>
                            <td class="px-3 py-2 text-sm text-gray-600 truncate max-w-[200px]" title="${teacherName}">${teacherName} ${statusHtml}</td>
                            <td class="px-3 py-2 align-middle text-xs font-bold whitespace-nowrap">${isCancelled ? '<span class="text-green-600"><i class="fas fa-check-circle lg:mr-1"></i><span class="hidden lg:inline">Resolved</span></span>' : '<span class="text-red-500"><i class="fas fa-exclamation-circle lg:mr-1"></i><span class="hidden lg:inline">Active</span></span>'}</td>
                         </tr>`;
                     }).join('');
                 } else {
                     // No classes found -> Treat as Neutral/Green
                     dbStat.className = "flex items-start text-sm mt-2 opacity-75"; 
                     dbStat.innerHTML = `<div class="w-8 flex justify-center mt-1"><i class="fas fa-info-circle text-gray-400"></i></div><div class="flex-1 bg-gray-50 border border-gray-100 rounded-md p-2 text-gray-600 italic">No classes found in DB for this school/date. (Likely Weekend or No Clean Data)</div>`;
                     tbody.innerHTML = `<tr><td colspan="4" class="px-3 py-4 text-center text-sm text-gray-500 italic">No scheduled sessions found in database.</td></tr>`;
                 }
                 
                 // --- Status Dropdown (Duplicated for School Logic) ---
                 const select = document.getElementById('modalStatusSelect');
                 select.value = p.status;
                 const updateSelectColor = (val) => {
                    select.className = "flex-1 form-select block w-full pl-3 pr-10 py-2 text-base sm:text-sm rounded-md shadow-sm border focus:outline-none transition-colors duration-300 ";
                    if(val === 'Approved') select.classList.add('bg-green-50', 'text-green-700', 'border-green-300');
                    else if(val === 'Rejected') select.classList.add('bg-gray-100', 'text-gray-500', 'border-gray-300');
                    else if(val === 'Cancelled') select.classList.add('bg-red-50', 'text-red-700', 'border-red-300');
                    else select.classList.add('bg-orange-50', 'text-orange-700', 'border-orange-300');
                 }
                 updateSelectColor(p.status);
                 select.onchange = (e) => { updateSelectColor(e.target.value); };

                 document.getElementById('eventModal').classList.remove('hidden');
                 return; 
             }
        }


        // 2. Load Sessions & Check Coverage
        // Headers Update
        const thead = container.querySelector('thead tr');
        if(thead) thead.innerHTML = `
            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-24">Time</th>
            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Class</th>
            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Teacher / Status</th>
            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Operations Check</th>
        `;

        const raw = parseSessions(p.affected_sessions);
        if (typeof raw === 'object' && raw.startTime) {
            container.classList.remove('hidden');
            loading.classList.remove('hidden');

            // --- Partial Day: Resolve Sessions manually ---
            const { data: sessions } = await db.from('fact_daily_session')
                .select('*')
                .eq('original_teacher_id', p.teacher_id)
                .eq('date', p.start_date)
                .gte('start_time', raw.startTime)
                .lte('end_time', raw.endTime);
            loading.classList.add('hidden');
            
            if(!sessions || sessions.length === 0) {
                 tbody.innerHTML = `<tr><td class="px-3 py-2 text-sm text-gray-500 italic" colspan="5">Partial Day - No classes found in DB for this range.</td></tr>`;
            } else {
                 let coveredCount = 0;
                 let totalCount = sessions.length;

                 tbody.innerHTML = sessions.map(s => {
                    const currentTeacherId = String(s.actual_teacher_id);
                    const originalTeacherId = String(p.teacher_id);
                    const teacherName = teacherMap.get(currentTeacherId) || s.actual_teacher_id || "-";
                    const isCancelled = (s.status || '').includes('Cancelled');
                    
                    let statusHtml = `<span class="px-2 py-0.5 rounded text-xs font-bold bg-green-100 text-green-700">Active</span>`;
                    if (isCancelled) statusHtml = `<span class="px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-700">${s.status}</span>`;
                    
                    let coverageHtml = '';
                    let isCovered = false;
                    
                    if (isCancelled) {
                            coverageHtml = `<div class="text-gray-400 text-xs mb-1"><i class="fas fa-ban"></i> Class Cancelled</div>`;
                            isCovered = true;
                    } else if (currentTeacherId && currentTeacherId !== originalTeacherId && currentTeacherId !== 'undefined') {
                            coverageHtml = `<div class="text-teal-600 text-xs font-bold mb-1"><i class="fas fa-user-check"></i> Covered by ${teacherName}</div>`;
                            isCovered = true;
                    } else {
                            coverageHtml = `<div class="text-xs text-orange-600 font-bold mb-1"><i class="fas fa-user-times"></i> Not Covered</div>`;
                    }
                    if(isCovered) coveredCount++;

                    return `<tr class="hover:bg-gray-50 border-b">
                        <td class="px-3 py-2 text-sm text-gray-700 font-mono whitespace-nowrap">${s.date}</td>
                        <td class="px-3 py-2 text-sm font-bold text-blue-600 whitespace-nowrap">${(s.start_time||'').substring(0,5)} - ${(s.end_time||'').substring(0,5)}</td>
                        <td class="px-3 py-2 text-sm text-gray-700">${s.class_name || '-'}</td>
                        <td class="px-3 py-2 text-sm text-gray-600">
                            <div>${teacherName}</div>
                            <div class="mt-1">${statusHtml}</div>
                        </td>
                        <td class="px-3 py-2 align-middle">
                            ${coverageHtml}
                        </td>
                    </tr>`;
                 }).join('');

                 // Validation Summary (Partial)
                 const dbCovRef = document.getElementById('coverageSummary');
                 if(dbCovRef && !dbStat.className.includes('hidden') && totalCount > 0) {
                     dbCovRef.classList.remove('hidden');
                     if(coveredCount === totalCount) {
                         dbCovRef.className = "mt-1 pt-1 border-t border-blue-200 text-xs font-bold text-teal-600 flex items-center";
                         dbCovRef.innerHTML = `<i class="fas fa-check-circle mr-1"></i> Operations Complete! All ${totalCount} classes are covered/cancelled.`;
                     } else {
                         dbCovRef.className = "mt-1 pt-1 border-t border-blue-200 text-xs font-bold text-orange-600 flex items-center";
                         dbCovRef.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i> Attention: Only ${coveredCount}/${totalCount} classes are covered.`;
                     }
                 }
            }

        } else if (Array.isArray(raw) && raw.length > 0) {
            container.classList.remove('hidden');
            loading.classList.remove('hidden');
            
            const sessionInfo = raw.map(s => {
                let time = "?"; if(typeof s === 'string' && s.split('_').length >= 3) time = s.split('_')[2].substring(0,5);
                return { id: s, time: time };
            });

            // Fetch Session Data
            const { data: sessions } = await db.from('fact_daily_session').select('*').in('session_id', sessionInfo.map(x=>x.id));
            loading.classList.add('hidden');
            
            const sessionMap = new Map();
            if(sessions) sessions.forEach(s => sessionMap.set(s.session_id, s));
            
            // Calculate Coverage Summary
            let coveredCount = 0;
            let totalCount = sessionInfo.length;

            tbody.innerHTML = sessionInfo.map(item => {
                const s = sessionMap.get(item.id);
                if(s) {
                    const currentTeacherId = String(s.actual_teacher_id);
                    const originalTeacherId = String(p.teacher_id);
                    const teacherName = teacherMap.get(currentTeacherId) || s.actual_teacher_id || "-";
                    const isCancelled = (s.status || '').includes('Cancelled');
                    
                    let statusHtml = `<span class="px-2 py-0.5 rounded text-xs font-bold bg-green-100 text-green-700">Active</span>`;
                    if (isCancelled) statusHtml = `<span class="px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-700">${s.status}</span>`;
                    
                    // --- Admin Coverage Check ---
                    // Simply checking if the teacher is substituted
                    let coverageHtml = '';
                    let isCovered = false;
                    
                    if (isCancelled) {
                            coverageHtml = `<div class="text-gray-400 text-xs mb-1"><i class="fas fa-ban"></i> Class Cancelled</div>`;
                            isCovered = true;
                    } else if (currentTeacherId && currentTeacherId !== originalTeacherId && currentTeacherId !== 'undefined') {
                            coverageHtml = `<div class="text-teal-600 text-xs font-bold mb-1"><i class="fas fa-user-check"></i> Covered by ${teacherName}</div>`;
                            isCovered = true;
                    } else {
                            coverageHtml = `<div class="text-xs text-orange-600 font-bold mb-1"><i class="fas fa-user-times"></i> Not Covered</div>`;
                    }
                    if(isCovered) coveredCount++;

                    return `<tr class="hover:bg-gray-50 border-b">
                        <td class="px-3 py-2 text-sm text-gray-700 font-mono whitespace-nowrap">${s.date}</td>
                        <td class="px-3 py-2 text-sm font-bold text-blue-600 whitespace-nowrap">${(s.start_time||'').substring(0,5)} - ${(s.end_time||'').substring(0,5)}</td>
                        <td class="px-3 py-2 text-sm text-gray-700">${s.class_name || '-'}</td>
                        <td class="px-3 py-2 text-sm text-gray-600">
                            <div>${teacherName}</div>
                            <div class="mt-1">${statusHtml}</div>
                        </td>
                        <td class="px-3 py-2 align-middle">
                            ${coverageHtml}
                        </td>
                    </tr>`;
                }
                return `<tr class="bg-red-50 border-b"><td colspan="5" class="px-3 py-2 text-sm text-gray-400 italic">Session ID ${item.id} not found in database</td></tr>`;
            }).join('');
            
            // Show Summary if DB Record Exists
            const dbCovRef = document.getElementById('coverageSummary');
            if(dbCovRef && !dbStat.className.includes('hidden') && totalCount > 0) {
                 dbCovRef.classList.remove('hidden');
                 if(coveredCount === totalCount) {
                     dbCovRef.className = "mt-1 pt-1 border-t border-blue-200 text-xs font-bold text-teal-600 flex items-center";
                     dbCovRef.innerHTML = `<i class="fas fa-check-circle mr-1"></i> Operations Complete! All ${totalCount} classes are covered/cancelled.`;
                 } else {
                     dbCovRef.className = "mt-1 pt-1 border-t border-blue-200 text-xs font-bold text-orange-600 flex items-center";
                     dbCovRef.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i> Attention: Only ${coveredCount}/${totalCount} classes are covered.`;
                 }
            }

        } else {
             container.classList.remove('hidden'); tbody.innerHTML = `<tr><td colspan="5" class="px-3 py-4 text-center text-sm text-gray-500 italic">Full Day Holiday</td></tr>`;
        }

        // --- Status Dropdown ---
        const select = document.getElementById('modalStatusSelect');
        select.value = p.status; // Set current status
        
        // Colorize Select
        const updateSelectColor = (val) => {
            select.className = "flex-1 form-select block w-full pl-3 pr-10 py-2 text-base sm:text-sm rounded-md shadow-sm border focus:outline-none transition-colors duration-300 ";
            if(val === 'Approved') select.classList.add('bg-green-50', 'text-green-700', 'border-green-300');
            else if(val === 'Rejected') select.classList.add('bg-gray-100', 'text-gray-500', 'border-gray-300');
            else if(val === 'Cancelled') select.classList.add('bg-red-50', 'text-red-700', 'border-red-300');
            else select.classList.add('bg-orange-50', 'text-orange-700', 'border-orange-300');
        }
        updateSelectColor(p.status);
        select.onchange = (e) => { updateSelectColor(e.target.value); }; // Just change color, don't save yet

        document.getElementById('eventModal').classList.remove('hidden');
    }

    function closeModal() { document.getElementById('eventModal').classList.add('hidden'); currentEventId = null; }

    async function saveStatus() {
        if(!currentEventId) return;
        const select = document.getElementById('modalStatusSelect');
        const btn = document.getElementById('btnUpdateStatus');
        const newStatus = select.value;
        const originalText = btn.innerText;

        // 1. Loading UI
        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
        
        try {
            // 2. DB Update
            const { error } = await db.from('requests_log').update({ status: newStatus }).eq('id', currentEventId);
            if (error) throw error;
            
            // 3. Optimistic Calendar Update
            const evt = calendar.getEventById(currentEventId.toString());
            if(evt) {
                // Update Props
                evt.setExtendedProp('status', newStatus);
                
                // Update Color
                let bg, border, text;
                const isLeave = evt.extendedProps.isLeave;
                // Copy logic from fetchEvents (simplified)
                if (newStatus === 'Rejected') { bg = '#f3f4f6'; border = 'transparent'; text = '#9ca3af'; }
                else if (newStatus === 'Cancelled') { bg = '#fef2f2'; border = '#fee2e2'; text = '#991b1b'; }
                else if (newStatus === 'Pending') { /* Keep orig or partial? */ bg = '#fff7ed'; border='#fdba74'; text='#9a3412'; } 
                else if (isLeave) { // Approved Leave
                    const type = (evt.extendedProps.leave_type || '').toLowerCase();
                    if(type.includes('sick')) { bg = '#ffe4e6'; border = '#fda4af'; text = '#be123c'; }
                    else if(type.includes('business')) { bg = '#dbeafe'; border = '#93c5fd'; text = '#1e40af'; }
                    else { bg = '#e0e7ff'; border = '#a5b4fc'; text = '#3730a3'; }
                } else { // Approved School
                    bg = '#ccfbf1'; border = '#5eead4'; text = '#115e59'; 
                }
                
                evt.setProp('backgroundColor', bg);
                evt.setProp('borderColor', border);
                evt.setProp('textColor', text);
                
                // Remove Pending Ring if not pending
                let classNames = [...evt.classNames];
                if(newStatus !== 'Pending') {
                    classNames = []; // Stop Pulse
                } else {
                    if(!classNames.includes('status-pulse')) classNames.push('status-pulse');
                }
                evt.setProp('classNames', classNames);
            }
            
            // 4. Success UI
            btn.innerHTML = `<i class="fas fa-check"></i>`;
            setTimeout(() => { 
                btn.innerHTML = originalText; 
                btn.disabled = false;
                closeModal();
            }, 500);

        } catch (err) { 
            alert("Error updating: " + err.message); 
            btn.innerHTML = "Error";
            btn.disabled = false;
        }
    }

    // --- Bulk Coverage Check ---
    async function checkCoverageForView() {
        const events = calendar.getEvents();
        
        // Target: Not Rejected/Cancelled (Pending or already rendered but might need status update)
        // We filter for Pending items specifically to update their 'pulse' status, 
        // or items without coverage status calculated yet.
        const targets = events.filter(e => {
            const p = e.extendedProps;
            return p.status !== 'Rejected' && p.status !== 'Cancelled' && (p.status === 'Pending' || !p.coverageStatus);
        });

        if(targets.length === 0) return;

        // Process in parallel
        await Promise.all(targets.map(async (e) => {
            const p = e.extendedProps;
            const queryDate = e.startStr; // YYYY-MM-DD (Per-day check)
            const raw = parseSessions(p.affected_sessions);
            let rows = [];

            try {
                if (p.isLeave) { // Teacher Logic
                    if (typeof raw === 'object' && raw.startTime && p.teacher_id) {
                        // Partial Day
                        const { data } = await db.from('fact_daily_session')
                            .select('status, actual_teacher_id')
                            .eq('original_teacher_id', p.teacher_id)
                            .eq('date', queryDate)
                            .gte('start_time', raw.startTime)
                            .lte('end_time', raw.endTime);
                        rows = data || [];
                    } else if (Array.isArray(raw) && raw.length > 0) {
                        // ID List (Specific Sessions)
                        // Filter by IDs found in the list AND the specific date of this event
                        const ids = raw.map(s => (typeof s==='string' && s.includes('_')) ? s : null).filter(Boolean);
                        if(ids.length > 0) {
                            const { data } = await db.from('fact_daily_session')
                                .select('status, actual_teacher_id')
                                .in('session_id', ids)
                                .eq('date', queryDate); 
                            rows = data || [];
                        }
                    } else {
                        // Generic Full Day check (If no sessions specified)
                         const { data } = await db.from('fact_daily_session')
                            .select('status, actual_teacher_id')
                            .eq('original_teacher_id', p.teacher_id)
                            .eq('date', queryDate);
                         rows = data || [];
                    }
                    
                    if(rows.length > 0) {
                        const total = rows.length;
                        let cancelled = rows.filter(r => (r.status || '').includes('Cancelled')).length;
                        let covered = rows.filter(r => !(r.status || '').includes('Cancelled') && String(r.actual_teacher_id) !== String(p.teacher_id) && String(r.actual_teacher_id) !== 'undefined').length;
                        
                        // Status Determination
                        let status = 'none';
                        if (cancelled === total) status = 'all_cancelled';
                        else if ((cancelled + covered) === total) status = 'all_covered'; 
                        else if (cancelled > 0 || covered > 0) status = 'partial';
                        
                        e.setExtendedProp('coverageStatus', status);

                        // Visual Update for Pending Tickets (Stop blinking if this day is fully resolved)
                        if(p.status === 'Pending') {
                            const isResolved = ((cancelled + covered) === total);
                            if(isResolved) {
                                e.setProp('classNames', []); // Resolved -> Stop Pulse -> Green Check (rendered via coverageStatus)
                            } else {
                                e.setProp('classNames', ['status-pulse']); // Not Resolved -> Keep Pulse
                            }
                        }
                    }

                } else { // School Logic
                     const schoolId = schoolCodeMap.get(p.school_code);
                     if(schoolId) {
                         let data = [];
                         let isSpecific = false;
                         const raw = parseSessions(p.affected_sessions);

                         // 1. Try Specific IDs first
                         if (Array.isArray(raw) && raw.length > 0) {
                             const ids = raw.filter(x => typeof x === 'string' && x.length > 5);
                             if(ids.length > 0) {
                                 isSpecific = true;
                                 const { data: specificData } = await db.from('fact_daily_session')
                                    .select('status')
                                    .in('session_id', ids)
                                    .eq('date', queryDate);
                                 data = specificData || [];
                             }
                         }

                         // 2. Fallback to Full Day query for this specific date
                         if (!isSpecific) {
                             const { data: fullData } = await db.from('fact_daily_session')
                                 .select('status')
                                 .eq('school_id', schoolId)
                                 .eq('date', queryDate);
                             data = fullData || [];
                         }
                         
                         if(data && data.length > 0) {
                             const total = data.length;
                             const cancelled = data.filter(s => (s.status || '').includes('Cancelled')).length;
                             
                             if (cancelled === total) e.setExtendedProp('coverageStatus', 'all_cancelled'); 
                             else e.setExtendedProp('coverageStatus', 'partial');
                             
                             // Visual Update for Pending Tickets
                             if(p.status === 'Pending') {
                                 if (cancelled === total) {
                                     e.setProp('classNames', []); // Stop pulsing
                                 } else {
                                     e.setProp('classNames', ['status-pulse']);
                                 }
                             }
                         }
                     }
                }
            } catch(err) { console.warn("Coverage check fail:", err); }
        }));
    }

    // --- EDIT MODE LOGIC ---
    let currentEditEvent = null;
    let availableSessions = []; 

    async function toggleEditMode() {
        const detailView = document.getElementById('modalDetailView');
        const editView = document.getElementById('modalEditView');
        const btnEdit = document.getElementById('btnToggleEdit');
        const btnSave = document.getElementById('btnSaveEdit');

        if (editView.classList.contains('hidden')) {
            // ENTER EDIT MODE
            const event = calendar.getEventById(currentEventId);
            if(!event) return;
            const p = event.extendedProps;
            currentEditEvent = p;

            // Populate Form
            document.getElementById('editStartDate').value = p.start_date;
            document.getElementById('editEndDate').value = p.end_date || p.start_date;
            document.getElementById('editReason').value = (p.reason && p.reason !== 'undefined') ? p.reason : '';
            document.getElementById('editEditorName').value = ''; 

            detailView.classList.add('hidden');
            editView.classList.remove('hidden');
            btnEdit.innerHTML = '<i class="fas fa-times mr-1"></i> Cancel Edit';
            btnSave.classList.remove('hidden');
            
            // Load Sessions immediately
            refreshEditSessions();

        } else {
            // EXIT EDIT MODE
            detailView.classList.remove('hidden');
            editView.classList.add('hidden');
            btnEdit.innerHTML = '<i class="fas fa-edit mr-1"></i> Edit Ticket';
            btnSave.classList.add('hidden');
        }
    }

    async function refreshEditSessions() {
        if(!currentEditEvent) return;
        const p = currentEditEvent;
        
        const start = document.getElementById('editStartDate').value;
        const end = document.getElementById('editEndDate').value;
        if(!start || !end) return;

        const list = document.getElementById('editSessionList');
        const loading = document.getElementById('editSessionLoading');
        const countSpan = document.getElementById('editSessionCount');

        list.innerHTML = '';
        loading.classList.remove('hidden');
        availableSessions = [];

        try {
            // Determine Fetch Logic (Teacher vs School)
            // [UPDATED] Use correct column names (original_teacher_id / actual_teacher_id)
            let query = db.from('fact_daily_session').select('session_id, date, start_time, class_name, original_teacher_id, actual_teacher_id, status');
            
            // Add Dates
            query = query.gte('date', start).lte('date', end);

            // Add Context
            if(p.isLeave && p.teacher_id) {
                // Filter by original_teacher_id to see classes assigned to this teacher
                query = query.eq('original_teacher_id', p.teacher_id);
            } else if (!p.isLeave && p.school_code) {
                const schoolId = schoolCodeMap.get(p.school_code);
                if(schoolId) query = query.eq('school_id', schoolId);
                else throw "Unknown School ID for code: " + p.school_code;
            } else {
                loading.classList.add('hidden');
                list.innerHTML = '<div class="text-red-500 text-center text-xs mt-4">Cannot determine context (School/Teacher ID missing).</div>';
                return;
            }

            // Execute
            const { data, error } = await query;
            if(error) throw error;
            
            // Sort by Date + Time
            availableSessions = (data || []).sort((a,b) => (a.date + a.start_time).localeCompare(b.date + b.start_time));
            
            countSpan.innerText = `${availableSessions.length} session(s) found`;

            if(availableSessions.length === 0) {
                list.innerHTML = '<div class="text-gray-400 text-center text-xs mt-4">No sessions found in this date range.</div>';
            } else {
                // Determine pre-selections
                const currentAffected = parseSessions(p.affected_sessions);
                // "Has Specific" if array is non-empty. 
                // If it's empty/null, it typically means "Whole Day/All Sessions" in legacy logic.
                // SO we default to ALL CHECKED if empty/null.
                const hasSpecific = Array.isArray(currentAffected) && currentAffected.length > 0;
                
                // Render
                list.innerHTML = availableSessions.map(s => {
                    const time = s.start_time ? s.start_time.substring(0,5) : '??:??';
                    
                    let isChecked = false;
                    if (!hasSpecific) isChecked = true; // Default All
                    else if (currentAffected.includes(s.session_id)) isChecked = true;

                    // [UPDATED] Show coverage status if applicable
                    let statusHtml = `<span class="text-gray-500">${s.status || 'Active'}</span>`;
                    if((s.status || '').includes('Cancelled')) {
                        statusHtml = `<span class="text-red-500 font-bold"><i class="fas fa-ban mr-1"></i>Cancelled</span>`;
                    } else if (s.original_teacher_id && s.actual_teacher_id && String(s.original_teacher_id) !== String(s.actual_teacher_id)) {
                        statusHtml = `<span class="text-green-600 font-bold"><i class="fas fa-user-check mr-1"></i>Covered</span>`;
                    }

                    return `
                        <div class="flex items-center p-2 hover:bg-gray-50 border-b border-gray-100 last:border-0 text-xs">
                            <input type="checkbox" value="${s.session_id}" ${isChecked ? 'checked' : ''} class="session-checkbox w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-3">
                            <div class="flex-1">
                                <div class="font-bold text-gray-700">${s.date} ${time} - ${s.class_name}</div>
                                <div class="text-[10px]">${statusHtml}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

        } catch(e) {
            console.error(e);
            list.innerHTML = `<div class="text-red-500 text-center text-xs mt-4">Error loading sessions: ${e.message}</div>`;
        } finally {
            loading.classList.add('hidden');
        }
    }

    async function saveEdit() {
        const editorName = document.getElementById('editEditorName').value.trim();
        if(!editorName) { alert("Please enter your name to sign this edit."); return; }

        const start = document.getElementById('editStartDate').value;
        const end = document.getElementById('editEndDate').value;
        const reason = document.getElementById('editReason').value;

        // Collect Sessions
        const checks = document.querySelectorAll('.session-checkbox:checked');
        const selectedIds = Array.from(checks).map(c => c.value);
        
        if (!confirm(`Save changes? \nUser: ${editorName}\nSessions: ${selectedIds.length}`)) return;
        
        const btn = document.getElementById('btnSaveEdit');
        const originalText = btn.innerText;
        btn.innerText = "Saving..."; btn.disabled = true;

        try {
            // 1. Get Log History
            const { data: currentData } = await db.from('requests_log').select('change_log').eq('id', currentEditEvent.id).single();
            
            // 2. Build New Log Entry
            let newLog = [];
            if(currentData && Array.isArray(currentData.change_log)) newLog = [...currentData.change_log]; // Copy
            
            const logEntry = {
                date: new Date().toISOString(),
                editor: editorName,
                note: `Updated dates (${start} to ${end}) and sessions (${selectedIds.length}).`
            };
            newLog.push(logEntry);

            // 3. Update
            const updatePayload = {
                start_date: start,
                end_date: end,
                reason: reason,
                affected_sessions: selectedIds,
                change_log: newLog
            };

            const { error } = await db.from('requests_log').update(updatePayload).eq('id', currentEditEvent.id);
            if(error) {
                // Fallback: If 'change_log' column missing, try saving without it
                if(error.message && error.message.includes('change_log')) {
                    console.warn("change_log column missing, saving basic data only.");
                    delete updatePayload.change_log;
                    const { error: retryError } = await db.from('requests_log').update(updatePayload).eq('id', currentEditEvent.id);
                    if(retryError) throw retryError;
                } else throw error;
            }

            alert("Ticket updated successfully!");
            closeModal();
            calendar.refetchEvents(); 

        } catch(e) {
            console.error(e);
            alert("Failed to save changes: " + e.message);
        } finally {
            btn.innerText = originalText; btn.disabled = false;
        }
    }
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Calendar v1.0.3 (With Alarms)</title>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
    body { font-family: 'Sarabun', sans-serif; }
    
    /* Calendar Overrides & Beautification (Thai Style) */
    
    /* Fonts & General */
    .fc { font-family: 'Sarabun', sans-serif; }
    .fc-toolbar-title { font-size: 2rem !important; font-weight: 800 !important; color: #1e3a8a; letter-spacing: -0.5px; } /* Bold Deep Blue Title */
    .fc-col-header-cell-cushion { font-size: 1.1rem; font-weight: 800; text-transform: uppercase; padding: 8px 0; }
    .fc-daygrid-day-number { font-size: 1.1rem; font-weight: 700; padding: 8px !important; }

    /* Sunday (Red) */
    .fc-day-sun .fc-col-header-cell-cushion { color: #dc2626; }
    .fc-day-sun .fc-daygrid-day-number { color: #dc2626; }
    .fc-day-sun { background-color: #fef2f2; } /* Faint Red Background */

    /* Saturday (Pale Blue / Indigo) */
    .fc-day-sat .fc-col-header-cell-cushion { color: #6366f1; }
    .fc-day-sat .fc-daygrid-day-number { color: #6366f1; }
    .fc-day-sat { background-color: #f5f3ff; } /* Faint Indigo Background */

    /* Weekdays (Deep Blue) */
    .fc-day-mon .fc-col-header-cell-cushion, .fc-day-mon .fc-daygrid-day-number,
    .fc-day-tue .fc-col-header-cell-cushion, .fc-day-tue .fc-daygrid-day-number,
    .fc-day-wed .fc-col-header-cell-cushion, .fc-day-wed .fc-daygrid-day-number,
    .fc-day-thu .fc-col-header-cell-cushion, .fc-day-thu .fc-daygrid-day-number,
    .fc-day-fri .fc-col-header-cell-cushion, .fc-day-fri .fc-daygrid-day-number { color: #1e3a8a; }

    /* Events */
    .fc-event { cursor: pointer; border: none; z-index: 10; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
    .fc-daygrid-event { font-size: 0.75rem; border-radius: 4px; padding: 1px; margin-top: 1px; }
    
    /* Enhance Today */
    .fc-day-today { background-color: #ecfdf5 !important; }
    .fc-day-today .fc-daygrid-day-number { font-size: 1.5em; color: #059669 !important; }
    
    /* Dim Past Days - No opacity to avoid stacking context bugs */
    .fc-day-past { background-color: #f8fafc; }
    .fc-day-past .fc-daygrid-day-number { opacity: 0.4; }
    .fc-day-past .fc-col-header-cell-cushion { opacity: 0.5; }
    
    .fc-button-primary { background-color: #1e40af !important; border-color: #1e40af !important; font-weight: 600; text-transform: uppercase; }
    .fc-button-active { background-color: #1e3a8a !important; }

    /* Modal Animation */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-backdrop { animation: fadeIn 0.15s ease-out; }
    .modal-content { animation: slideUp 0.15s ease-out; }
    
    /* Switch Toggle */
    .toggle-checkbox:checked { right: 0; border-color: #68D391; }
    .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
  </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col overflow-hidden">

  <!-- Header & Stats -->
  <header class="bg-white border-b px-6 py-4 flex justify-between items-center shadow-sm z-10">
    <div class="flex items-center space-x-3">
        <div class="bg-green-100 p-2 rounded-lg text-green-700">
            <i class="fas fa-calendar-check text-xl"></i>
        </div>
        <div>
            <h1 class="text-xl font-bold text-gray-800">Request Dashboard</h1>
            <p class="text-xs text-gray-500">Braincloud Operations</p>
        </div>
    </div>

    <div class="flex space-x-6 items-center">
        <!-- Stats -->
        <div class="text-center">
            <p class="text-xs text-gray-400 font-semibold uppercase">Pending</p>
            <p id="stat-pending" class="text-2xl font-bold text-orange-500">0</p>
        </div>
        <div class="text-center mr-4">
            <p class="text-xs text-gray-400 font-semibold uppercase">Approved (Mo.)</p>
            <p id="stat-approved" class="text-2xl font-bold text-green-600">0</p>
        </div>

        <!-- Toolbar -->
        <div class="flex space-x-2 border-l pl-6">
            <!-- Filter Toggles -->
            <div class="flex bg-gray-100 rounded-lg p-1 mr-2">
                <button onclick="setFilter('all')" id="btn-filter-all" class="px-3 py-1 rounded-md text-xs font-bold bg-white text-gray-700 shadow-sm transition">ALL</button>
                <button onclick="setFilter('school')" id="btn-filter-school" class="px-3 py-1 rounded-md text-xs font-bold text-gray-500 hover:text-teal-600 transition">SCHOOL</button>
                <button onclick="setFilter('teacher')" id="btn-filter-teacher" class="px-3 py-1 rounded-md text-xs font-bold text-gray-500 hover:text-indigo-600 transition">TEACHER</button>
            </div>

            <button onclick="openAlarmModal()" class="bg-indigo-50 hover:bg-indigo-100 text-indigo-600 p-2 rounded-full w-10 h-10 flex items-center justify-center transition shadow-sm relative group" title="Notification Settings">
                <i class="fas fa-bell"></i>
                <span id="alarm-indicator" class="absolute top-0 right-0 h-3 w-3 bg-red-500 rounded-full border-2 border-white hidden"></span>
            </button>
            <button onclick="fetchEvents()" class="bg-gray-100 hover:bg-gray-200 text-gray-600 p-2 rounded-full w-10 h-10 flex items-center justify-center transition shadow-sm" title="Refresh Data">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>
  </header>

  <!-- Main Calendar Area -->
  <div class="flex-1 overflow-hidden p-4">
    <div class="bg-white rounded-xl shadow h-full p-4 overflow-hidden flex flex-col">
        <div id='calendar' class="flex-1"></div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="eventModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-40 backdrop-blur-sm modal-backdrop" onclick="closeModal()"></div>
    
    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl w-full max-w-2xl modal-content overflow-hidden">
        
        <!-- Modal Header -->
        <div id="modalHeader" class="p-6 text-white bg-gray-600 transition-colors duration-300">
            <div class="flex justify-between items-start">
                <div>
                    <span id="modalTypeBadge" class="inline-block px-2 py-1 rounded text-xs font-bold uppercase tracking-wider bg-white bg-opacity-20 mb-2">Type</span>
                    <h2 id="modalTitle" class="text-2xl font-bold leading-tight">Title</h2>
                    <p id="modalSubtitle" class="text-sm opacity-90 mt-1">Subtitle</p>
                </div>
                <button onclick="closeModal()" class="text-white opacity-70 hover:opacity-100 hover:rotate-90 transition-transform duration-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Modal Body -->
        <div class="p-6 space-y-5 max-h-[60vh] overflow-y-auto">
            
            <!-- Dates -->
            <div class="flex items-center text-gray-600">
                <div class="w-8 flex justify-center"><i class="far fa-calendar-alt text-lg"></i></div>
                <span id="modalDates" class="font-medium text-lg text-gray-800">Date Range</span>
            </div>

            <!-- DB Verification Status (Injected) -->
            <div id="dbStatusContainer" class="hidden flex items-start text-sm">
                 <div class="w-8 flex justify-center mt-1"><i class="fas fa-database text-blue-500"></i></div>
                 <div class="flex-1 bg-blue-50 border border-blue-100 rounded-md p-2 text-blue-800">
                     <span class="font-bold">Database Record Found:</span> <span id="dbStatusText">Checking...</span>
                     <div id="coverageSummary" class="mt-1 pt-1 border-t border-blue-200 text-xs font-semibold hidden">
                         Checking coverage...
                     </div>
                 </div>
            </div>

            <!-- Reason -->
            <div class="flex items-start text-gray-600">
                <div class="w-8 flex justify-center mt-1"><i class="far fa-comment-alt"></i></div>
                <div class="flex-1">
                    <p class="text-xs uppercase text-gray-400 font-bold mb-1">Reason</p>
                    <p id="modalReason" class="text-gray-700 italic bg-gray-50 p-3 rounded-lg border border-gray-100 text-sm">Reason text...</p>
                </div>
            </div>
            
            <!-- Affected Classes -->
            <div id="modalClassesContainer" class="hidden">
                 <div class="flex items-start">
                    <div class="w-8 flex justify-center mt-1"><i class="fas fa-chalkboard-teacher text-gray-400"></i></div>
                    <div class="flex-1 w-full">
                        <p class="text-xs uppercase text-gray-400 font-bold mb-2">Affected Sessions</p>
                        <div class="border rounded-lg overflow-hidden relative min-h-[100px]">
                             <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-24">Time</th>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Class</th>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Teacher</th>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="modalClassesBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                             </table>
                             <div id="modalClassesLoading" class="hidden absolute inset-0 bg-white/80 flex items-center justify-center text-sm text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i> Syncing Data...
                             </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Free Status Change Dropdown -->
            <div class="flex items-center justify-between border-t pt-4 mt-2">
                 <div class="flex items-center w-full space-x-2">
                    <span class="text-sm font-semibold text-gray-500">Status:</span>
                    <select id="modalStatusSelect" class="flex-1 form-select block w-full pl-3 pr-10 py-2 text-base sm:text-sm rounded-md shadow-sm border bg-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                    <button id="btnUpdateStatus" onclick="saveStatus()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded-md shadow-sm transition whitespace-nowrap">
                        Update
                    </button>
                 </div>
            </div>
        </div>

        <div class="p-4 bg-gray-50 border-t flex justify-end">
            <button onclick="closeModal()" class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 text-sm font-medium text-gray-700">Close</button>
        </div>
    </div>
  </div>

  <!-- Alarm Settings Modal -->
  <div id="alarmModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-40 backdrop-blur-sm modal-backdrop" onclick="closeAlarmModal()"></div>
    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-xl shadow-2xl w-full max-w-sm modal-content">
        <div class="p-5 border-b bg-indigo-600 text-white rounded-t-xl">
            <h3 class="font-bold text-lg"><i class="fas fa-bell mr-2"></i> Notification Settings</h3>
            <p class="text-xs opacity-80">Daily Discord alerts for pending tickets.</p>
        </div>
        
        <div class="p-5">
            <!-- Add New Alarm -->
            <div class="flex space-x-2 mb-4">
                <input type="time" id="newAlarmTime" class="border rounded p-2 flex-1 focus:ring-2 focus:ring-indigo-200 outline-none">
                <button onclick="addAlarm()" class="bg-indigo-600 text-white px-3 rounded hover:bg-indigo-700 shadow-md"><i class="fas fa-plus"></i></button>
            </div>

            <!-- Alarm List -->
            <div class="space-y-3 max-h-60 overflow-y-auto" id="alarmList">
                <!-- Injected via JS -->
                 <div class="text-center text-gray-400 text-sm py-4"><i class="fas fa-circle-notch fa-spin"></i> Loading...</div>
            </div>
            
            <!-- Manual Trigger -->
            <div class="mt-4 pt-4 border-t">
                <button onclick="manualTrigger()" class="w-full bg-orange-100 hover:bg-orange-200 text-orange-700 font-bold py-2 rounded flex items-center justify-center transition">
                    <i class="fas fa-paper-plane mr-2"></i> Send Notification Now
                </button>
            </div>

            <p class="text-[10px] text-gray-400 mt-4 italic text-center">
                * Alarms are universal. Only fires if page/bot is active.
            </p>
        </div>

        <div class="p-3 bg-gray-50 text-right rounded-b-xl">
            <button onclick="closeAlarmModal()" class="text-sm text-gray-600 hover:text-gray-900 font-medium px-3 py-1">Close</button>
        </div>
    </div>
  </div>

<script>
    // --- Config ---
    const CONFIG = {
        SUPABASE_URL: "https://cgznmxcecljfybcgujjb.supabase.co",
        SUPABASE_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnem5teGNlY2xqZnliY2d1ampiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2Nzc2NTI1MywiZXhwIjoyMDgzMzQxMjUzfQ.kTov9RFS-FVDNZokkslR0jFH2zaKTUYSBH9NQ8aItlQ",
        DISCORD_WEBHOOK: "https://discordapp.com/api/webhooks/1463030732602609665/-V-K56hgPh5mjcaFiFpc_6ZLhoqTceEQzuWXO7k4-0ztIuLXF6lk_TEKX6uIfKXWl5TX"
    };

    let calendar;
    let currentEventId = null;
    let teacherMap = new Map(); 
    let schoolMap = new Map(); // id -> name
    let schoolCodeMap = new Map(); // code -> id
    let activeAlarms = [];
    let currentFilter = 'all'; // 'all', 'school', 'teacher'
    const db = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);

    // --- Init ---
    document.addEventListener('DOMContentLoaded', async function() {
        await Promise.all([loadTeachers(), loadSchools()]);
        
        // Setup Calendar
        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            themeSystem: 'standard',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,dayGridWeek,listWeek'
            },
            height: '100%',
            views: {
                dayGridMonth: { dayMaxEvents: 6 },
                dayGridWeek: { dayMaxEvents: false }
            },
            eventClick: function(info) { openModal(info.event); },
            events: fetchEvents,
            eventContent: renderEventContent
        });
        calendar.render();

        // Setup Alarms
        setupAlarmSystem();
    });

    // --- Alarm System ---
    async function setupAlarmSystem() {
        // 1. Load Alarms
        await fetchAlarms();
        
        // 2. Start Polling (Every 30s)
        setInterval(checkAlarms, 30000); 
    }

    async function fetchAlarms() {
        try {
            const { data, error } = await db.from('admin_alarms').select('*').order('time');
            if(error) {
                // If table missing, maybe just warn or handle gracefully
                console.warn("Alarm table might be missing:", error);
                activeAlarms = []; 
                return;
            }
            // Logic: Default 3PM
            const hasDefault = data.find(a => a.time === '15:00');
            if(!hasDefault && data.length === 0) {
                // Auto-create default 3:00 PM if DB empty
                await db.from('admin_alarms').insert({ time: '15:00', label: 'Daily Default' });
                return fetchAlarms(); // Retry
            }
            activeAlarms = data;
            renderAlarmList();
        } catch(e) { console.error(e); }
    }

    function renderAlarmList() {
        const list = document.getElementById('alarmList');
        if(activeAlarms.length === 0) {
            list.innerHTML = `<div class="text-sm text-gray-400 text-center">No active alarms.</div>`;
            return;
        }
        
        list.innerHTML = activeAlarms.map(a => `
            <div class="flex items-center justify-between bg-gray-50 p-2 rounded border border-gray-100">
                <div class="flex items-center">
                    <span class="font-mono text-lg font-bold text-gray-700">${a.time}</span>
                    ${a.label ? `<span class="text-xs text-gray-400 ml-2">(${a.label})</span>` : ''}
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="toggleAlarm(${a.id}, ${!a.is_active})" class="${a.is_active ? 'text-green-500' : 'text-gray-300'} hover:scale-110 transition">
                        <i class="fas fa-toggle-${a.is_active ? 'on' : 'off'} text-2xl"></i>
                    </button>
                    <button onclick="deleteAlarm(${a.id})" class="text-red-400 hover:text-red-600 ml-2 text-sm">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');

        // Indicator
        const anyActive = activeAlarms.some(a => a.is_active);
        const ind = document.getElementById('alarm-indicator');
        if(ind) {
             if(anyActive) ind.classList.remove('hidden'); else ind.classList.add('hidden');
        }
    }

    async function addAlarm() {
        const time = document.getElementById('newAlarmTime').value;
        if(!time) return;
        
        await db.from('admin_alarms').insert({ time: time, is_active: true });
        fetchAlarms();
    }

    async function deleteAlarm(id) {
        if(!confirm("Delete this alarm?")) return;
        await db.from('admin_alarms').delete().eq('id', id);
        fetchAlarms();
    }

    async function toggleAlarm(id, newState) {
        await db.from('admin_alarms').update({ is_active: newState }).eq('id', id);
        fetchAlarms();
    }

    function openAlarmModal() { document.getElementById('alarmModal').classList.remove('hidden'); }
    function closeAlarmModal() { document.getElementById('alarmModal').classList.add('hidden'); }

    // --- Polling Logic ---
    async function checkAlarms() {
        const now = new Date();
        const currentStr = now.toTimeString().substring(0,5); // "HH:MM"
        
        // Find matching active alarm
        const match = activeAlarms.find(a => a.time === currentStr && a.is_active);
        
        if(match) {
            // Check if we already fired this minute? (Simple debounce: check Seconds < 35)
            // Or just check Pending count
            const pendingCount = parseInt(document.getElementById('stat-pending').innerText || '0');
            
            if(pendingCount > 0) {
                console.log(`‚è∞ ALARM: ${currentStr} - Pending: ${pendingCount}. Sending Webhook.`);
                sendDiscordNotification(pendingCount);
            }
        }
    }

    async function manualTrigger() {
        if(!confirm("Send notification to Discord now?")) return;
        const pendingCount = parseInt(document.getElementById('stat-pending').innerText || '0');
        if(pendingCount === 0) { alert("No pending tickets to notify about."); return; }
        await sendDiscordNotification(pendingCount);
        alert("Notification Sent!");
    }

    async function sendDiscordNotification(count) {
        if(!CONFIG.DISCORD_WEBHOOK || CONFIG.DISCORD_WEBHOOK.includes("REPLACE")) return;
        
        // Simple dedupe: Check if we alerted recently in LocalStorage?
        // const lastAlert = localStorage.getItem('last_discord_alert');
        // const nowTs = Date.now();
        // if(lastAlert && (nowTs - parseInt(lastAlert)) < 60000) return; // Ignore if < 1m ago

        // Fetch detailed pending list for the embed
        let pendingDetails = [];
        try {
            const { data } = await db.from('requests_log').select('school_code, user_name, start_date, request_category').eq('status', 'Pending').limit(5);
            if(data) pendingDetails = data;
        } catch(e) {}

        const schoolCount = pendingDetails.filter(r => r.request_category !== 'Teacher').length;
        const teacherCount = pendingDetails.filter(r => r.request_category === 'Teacher').length;
        
        // Build Description
        let desc = `There are **${count}** pending ticket(s) waiting for approval.\n\n`;
        pendingDetails.forEach(r => {
             const typeIcon = r.request_category === 'Teacher' ? 'üë§' : 'üè´';
             const title = r.request_category === 'Teacher' ? r.user_name : r.school_code;
             desc += `> ${typeIcon} **${title}** (${r.start_date})\n`;
        });
        if(count > 5) desc += `> ... and ${count - 5} more.\n`;

        const payload = {
            username: "Braincloud Admin Bot",
            avatar_url: "https://cdn-icons-png.flaticon.com/512/3652/3652191.png",
            embeds: [{
                title: "üîî Pending Requests Action Required",
                description: desc,
                color: 15105570, // Orange
                fields: [
                    { name: "School Requests", value: `${schoolCount} (Visible)`, inline: true },
                    { name: "Teacher Requests", value: `${teacherCount} (Visible)`, inline: true },
                    { name: "Dashboard", value: `[Click to Manage](${window.location.href})` }
                ],
                footer: { text: "Braincloud Operations ‚Ä¢ " + new Date().toLocaleString('en-US', { timeZone: 'Asia/Bangkok' }) }
            }]
        };

        try {
            await fetch(CONFIG.DISCORD_WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            // localStorage.setItem('last_discord_alert', nowTs.toString());
        } catch(e) { console.error("Webhook failed", e); }
    }

    // --- Core Calendar Logic ---
    
    function renderEventContent(arg) {
        const props = arg.event.extendedProps;
        let icon = '';
        if(props.isLeave) {
            if((props.leave_type || '').toLowerCase().includes('sick')) icon = '<i class="fas fa-briefcase-medical mr-1 opacity-70"></i>';
            else if((props.leave_type || '').toLowerCase().includes('business')) icon = '<i class="fas fa-briefcase mr-1 opacity-70"></i>';
            else icon = '<i class="fas fa-user-clock mr-1 opacity-70"></i>';
        } else {
            icon = '<i class="fas fa-school mr-1 opacity-70"></i>';
        }
        
        let html = `<div class="flex items-center overflow-hidden w-full h-full px-1"><span class="truncate font-semibold text-xs flex-1">${icon} ${arg.event.title}</span>`;
        if(props.badgeText && props.badgeText !== 'FULL') {
            html += `<span class="ml-1 text-[9px] px-1 rounded bg-white/40 font-bold whitespace-nowrap opacity-90">${props.badgeText}</span>`;
        }
        
        // Coverage Status Icons
        if (props.coverageStatus === 'all_cancelled') {
             html += `<i class="fas fa-check-circle text-red-500 ml-1 text-xs bg-white rounded-full" title="All Cancelled"></i>`; 
        } else if (props.coverageStatus === 'all_covered') {
             html += `<i class="fas fa-check-circle text-green-500 ml-1 text-xs bg-white rounded-full" title="All Covered"></i>`;
        } else if (props.coverageStatus === 'partial') {
             html += `<i class="fas fa-exclamation-circle text-orange-400 ml-1 text-xs bg-white rounded-full" title="Partially Covered"></i>`;
        }

        html += `</div>`;
        return { html: html };
    }

    async function loadTeachers() {
        try {
            const { data } = await db.from('dim_user').select('user_id, firstname_en, lastname_en, nickname_en');
            if(data) data.forEach(u => {
                if(u.user_id) {
                    let name = `${u.firstname_en || ''} ${u.lastname_en || ''}`.trim();
                    if(u.nickname_en) name += ` (${u.nickname_en})`;
                    teacherMap.set(String(u.user_id), name);
                }
            });
        } catch(e) {}
    }

    async function loadSchools() {
        try {
            const { data } = await db.from('dim_school').select('school_id, school_code, school_name_en');
            if(data) data.forEach(s => {
                if(s.school_id) {
                    schoolMap.set(String(s.school_id), s.school_name_en);
                    if(s.school_code) schoolCodeMap.set(s.school_code, String(s.school_id));
                }
            });
        } catch(e) {}
    }

    async function fetchEvents(fetchInfo, successCallback, failureCallback) {
        try {
            const { data, error } = await db.from('requests_log').select('*').order('created_at', { ascending: false });
            if (error) throw error;

            updateStats(data);
            const events = data.map(r => {
                const isLeave = r.request_category === 'Teacher' || r.school_code === 'N/A';
                
                // FILTER LOGIC
                if (currentFilter === 'school' && isLeave) return null;
                if (currentFilter === 'teacher' && !isLeave) return null;
                
                const isPending = r.status === 'Pending';
                
                let bg, border, text;
                if (r.status === 'Rejected') { bg = '#f3f4f6'; border = 'transparent'; text = '#9ca3af'; }
                else if (r.status === 'Cancelled') { bg = '#fef2f2'; border = '#fee2e2'; text = '#991b1b'; } // Add Cancelled style
                else if (isLeave) {
                    const type = (r.type || '').toLowerCase();
                    if(type.includes('sick')) { bg = '#ffe4e6'; border = '#fda4af'; text = '#be123c'; }
                    else if(type.includes('business')) { bg = '#dbeafe'; border = '#93c5fd'; text = '#1e40af'; }
                    else { bg = '#e0e7ff'; border = '#a5b4fc'; text = '#3730a3'; }
                } else {
                    const sessions = parseSessions(r.affected_sessions);
                    const isPartial = sessions.length > 0 && sessions.length < 8; 
                    if(isPartial) { bg = '#fef3c7'; border = '#fcd34d'; text = '#92400e'; }
                    else { bg = '#ccfbf1'; border = '#5eead4'; text = '#115e59'; }
                }

                let classNames = [];
                if(isPending) classNames.push('ring-2', 'ring-orange-400', 'ring-dashed', 'z-10');

                let displayName = r.user_name || "Unknown";
                if(isLeave && r.teacher_id) {
                    const mapped = teacherMap.get(String(r.teacher_id));
                    displayName = mapped || `${r.user_name || 'Teacher'} (${r.teacher_id})`;
                } else if (!isLeave) displayName = r.school_code;

                // Badge Logic
                let badge = "";
                const sessions = parseSessions(r.affected_sessions);
                if (typeof sessions === 'object' && sessions.startTime) badge = `${sessions.startTime.substring(0,5)}-${sessions.endTime.substring(0,5)}`;
                else if (Array.isArray(sessions) && sessions.length > 0) {
                     const times = sessions.map(s => {
                        const parts = s.split('_');
                        return parts.length >= 3 ? parts[2].substring(0,5) : null;
                     }).filter(Boolean).sort();
                     if (times.length > 0) badge = (times.length > 1) ? `${times[0]}..` : times[0];
                }

                return {
                    id: r.id,
                    title: displayName,
                    start: r.start_date,
                    end: r.end_date ? new Date(new Date(r.end_date).getTime() + 86400000).toISOString().split('T')[0] : r.start_date,
                    backgroundColor: bg, borderColor: border, textColor: text, classNames: classNames,
                    extendedProps: { ...r, mapped_name: displayName, badgeText: badge, leave_type: r.type, isLeave: isLeave }
                };
            }).filter(Boolean); // Filter nulls
            if(successCallback) successCallback(events);
            
            // Trigger coverage check for visible events
            setTimeout(() => checkCoverageForView(), 500);

        } catch (err) { failureCallback(err); }
    }
    
    // --- Filter Logic ---
    function setFilter(type) {
        currentFilter = type;
        
        // Update UI
        ['all', 'school', 'teacher'].forEach(t => {
            const btn = document.getElementById(`btn-filter-${t}`);
            if(t === type) {
                btn.className = "px-3 py-1 rounded-md text-xs font-bold bg-white text-gray-800 shadow-sm ring-1 ring-gray-200 transition transform scale-105";
            } else {
                btn.className = "px-3 py-1 rounded-md text-xs font-bold text-gray-400 hover:text-gray-600 transition";
            }
        });

        calendar.refetchEvents();
    }

    function parseSessions(raw) {
        if(!raw) return [];
        try { if(typeof raw === 'string') { if(raw.startsWith('[')) return JSON.parse(raw); if(raw.startsWith('{')) return JSON.parse(raw); return [raw]; } return raw; } catch(e) { return []; }
    }

    function updateStats(data) {
        document.getElementById('stat-pending').innerText = data.filter(d => d.status === 'Pending').length;
        document.getElementById('stat-approved').innerText = data.filter(d => d.status === 'Approved' && new Date(d.start_date).getMonth() === new Date().getMonth()).length;
    }

    async function openModal(event) {
        const p = event.extendedProps;
        currentEventId = p.id;
        
        // Dynamic Header
        const header = document.getElementById('modalHeader');
        let bgClass = 'bg-gray-600';
        if(p.status === 'Rejected') bgClass = 'bg-gray-500';
        else if(p.status === 'Cancelled') bgClass = 'bg-red-800'; // Dark red for cancelled
        else if (p.isLeave) {
             const type = (p.leave_type || '').toLowerCase();
             if(type.includes('sick')) bgClass = 'bg-rose-600'; else if(type.includes('business')) bgClass = 'bg-blue-600'; else bgClass = 'bg-indigo-600';
        } else bgClass = p.badgeText ? 'bg-amber-500' : 'bg-teal-600';
        header.className = `p-6 text-white transition-colors duration-300 ${bgClass}`;

        document.getElementById('modalTypeBadge').innerText = p.isLeave ? (p.type || "Teacher Leave") : "School Holiday";
        document.getElementById('modalTitle').innerText = p.mapped_name || p.title; 
        document.getElementById('modalSubtitle').innerText = "Requested by: " + (p.user_name || "Guest");
        
        let dateText = p.start_date; if(p.end_date && p.end_date !== p.start_date) dateText += ` ‚ûî ${p.end_date}`;
        document.getElementById('modalDates').innerText = dateText;
        document.getElementById('modalReason').innerText = (p.reason && p.reason !== 'undefined') ? p.reason : "No specific reason provided.";
        
        // --- Simple DB Verification (Teacher Only) ---
        const dbStat = document.getElementById('dbStatusContainer');
        const container = document.getElementById('modalClassesContainer');
        const tbody = document.getElementById('modalClassesBody');
        const loading = document.getElementById('modalClassesLoading');
        
        // Robust Reset: Always restore "Clean" state first to fix destruction
        dbStat.innerHTML = `
             <div class="w-8 flex justify-center mt-1"><i class="fas fa-database text-blue-500"></i></div>
             <div class="flex-1 bg-blue-50 border border-blue-100 rounded-md p-2 text-blue-800">
                 <span class="font-bold">Database Record Found:</span> <span id="dbStatusText">Checking...</span>
                 <div id="coverageSummary" class="mt-1 pt-1 border-t border-blue-200 text-xs font-semibold hidden">
                     Checking coverage...
                 </div>
             </div>
        `;
        dbStat.className = "hidden flex items-start text-sm";
        tbody.innerHTML = ''; container.classList.add('hidden'); loading.classList.add('hidden');

        // Main Logic
        // 1. If Teacher Leave, check Reference Table
        if(p.isLeave && p.teacher_id) {
             const { data } = await db.from('fact_teacher_unavailability')
               .select('*')
               .eq('teacher_id', p.teacher_id)
               .lte('start_date', p.end_date || p.start_date) 
               .gte('end_date', p.start_date);
             
             if(data && data.length > 0) {
                dbStat.className = "flex items-start text-sm mt-2"; 
                const types = [...new Set(data.map(u => u.unavailability_type || 'Unspecified'))].join(', ');
                document.getElementById('dbStatusText').innerText = `Found ${data.length} record(s). Type: ${types}`;
             } else {
                dbStat.className = "flex items-start text-sm mt-2 opacity-75"; 
                dbStat.innerHTML = `<div class="w-8 flex justify-center mt-1"><i class="fas fa-exclamation-circle text-orange-400"></i></div><div class="flex-1 bg-orange-50 border border-orange-100 rounded-md p-2 text-orange-700 italic">No official 'unavailability' record found for these dates. <br><span class="text-xs not-italic text-gray-500">Checked range: ${p.start_date} to ${p.end_date || p.start_date}</span></div>`;
             } // End Teacher Check
        } 
        else if (!p.isLeave) {
             // --- School Holiday Coverage Check ---
             const schoolId = schoolCodeMap.get(p.school_code);
             if(schoolId) {
                 loading.classList.remove('hidden'); container.classList.remove('hidden');
                 const { data } = await db.from('fact_daily_session')
                     .select('*')
                     .eq('school_id', schoolId)
                     .gte('date', p.start_date)
                     .lte('date', p.end_date || p.start_date);
                 loading.classList.add('hidden');
                 
                 if(data && data.length > 0) {
                     // Check for NON-cancelled (Fuzzy match)
                     const active = data.filter(s => !(s.status || '').includes('Cancelled'));
                     if(active.length === 0) {
                         dbStat.className = "flex items-start text-sm mt-2"; 
                         dbStat.innerHTML = `<div class="w-8 flex justify-center mt-1"><i class="fas fa-check-circle text-teal-600"></i></div><div class="flex-1 bg-teal-50 border border-teal-100 rounded-md p-2 text-teal-800 font-bold">All ${data.length} sessions are Cancelled. Operations Complete.</div>`;
                     } else {
                         dbStat.className = "flex items-start text-sm mt-2"; 
                         dbStat.innerHTML = `<div class="w-8 flex justify-center mt-1"><i class="fas fa-exclamation-triangle text-red-500"></i></div><div class="flex-1 bg-red-50 border border-red-100 rounded-md p-2 text-red-800 font-bold">Alert: ${active.length} sessions are still Active (Not Cancelled).</div>`;
                     }
                     
                     // List Sessions
                     tbody.innerHTML = data.map(s => {
                         const isCancelled = (s.status || '').includes('Cancelled');
                         let statusHtml = `<span class="px-2 py-0.5 rounded text-xs font-bold bg-green-100 text-green-700">Active</span>`;
                         if (isCancelled) statusHtml = `<span class="px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-700">${s.status}</span>`;
                         return `<tr class="hover:bg-gray-50 border-b">
                            <td class="px-3 py-2 text-sm font-bold text-blue-600 whitespace-nowrap">${(s.date||'').substring(5)} ${(s.start_time||'').substring(0,5)}</td>
                            <td class="px-3 py-2 text-sm text-gray-700">${s.class_name || '-'}</td>
                            <td class="px-3 py-2 text-sm text-gray-600">${s.actual_teacher_id || '-'} ${statusHtml}</td>
                            <td class="px-3 py-2 align-middle">${isCancelled ? '<i class="fas fa-check text-green-500"></i>' : '<i class="fas fa-times text-red-400"></i>'}</td>
                         </tr>`;
                     }).join('');
                 } else {
                     // No classes found -> Treat as Neutral/Green
                     dbStat.className = "flex items-start text-sm mt-2 opacity-75"; 
                     dbStat.innerHTML = `<div class="w-8 flex justify-center mt-1"><i class="fas fa-info-circle text-gray-400"></i></div><div class="flex-1 bg-gray-50 border border-gray-100 rounded-md p-2 text-gray-600 italic">No classes found in DB for this school/date. (Likely Weekend or No Clean Data)</div>`;
                     tbody.innerHTML = `<tr><td colspan="4" class="px-3 py-4 text-center text-sm text-gray-500 italic">No scheduled sessions found in database.</td></tr>`;
                 }
                 
                 // --- Status Dropdown (Duplicated for School Logic) ---
                 const select = document.getElementById('modalStatusSelect');
                 select.value = p.status;
                 const updateSelectColor = (val) => {
                    select.className = "flex-1 form-select block w-full pl-3 pr-10 py-2 text-base sm:text-sm rounded-md shadow-sm border focus:outline-none transition-colors duration-300 ";
                    if(val === 'Approved') select.classList.add('bg-green-50', 'text-green-700', 'border-green-300');
                    else if(val === 'Rejected') select.classList.add('bg-gray-100', 'text-gray-500', 'border-gray-300');
                    else if(val === 'Cancelled') select.classList.add('bg-red-50', 'text-red-700', 'border-red-300');
                    else select.classList.add('bg-orange-50', 'text-orange-700', 'border-orange-300');
                 }
                 updateSelectColor(p.status);
                 select.onchange = (e) => { updateSelectColor(e.target.value); };

                 document.getElementById('eventModal').classList.remove('hidden');
                 return; 
             }
        }


        // 2. Load Sessions & Check Coverage
        // Headers Update
        const thead = container.querySelector('thead tr');
        if(thead) thead.innerHTML = `
            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-24">Time</th>
            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Class</th>
            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Teacher / Status</th>
            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Operations Check</th>
        `;

        const raw = parseSessions(p.affected_sessions);
        if (typeof raw === 'object' && raw.startTime) {
            container.classList.remove('hidden');
            loading.classList.remove('hidden');

            // --- Partial Day: Resolve Sessions manually ---
            const { data: sessions } = await db.from('fact_daily_session')
                .select('*')
                .eq('original_teacher_id', p.teacher_id)
                .eq('date', p.start_date)
                .gte('start_time', raw.startTime)
                .lte('end_time', raw.endTime);
            loading.classList.add('hidden');
            
            if(!sessions || sessions.length === 0) {
                 tbody.innerHTML = `<tr><td class="px-3 py-2 text-sm font-bold text-gray-700">${raw.startTime} - ${raw.endTime}</td><td class="px-3 py-2 text-sm text-gray-500 italic" colspan="3">Partial Day - No classes found in DB for this range.</td></tr>`;
            } else {
                 let coveredCount = 0;
                 let totalCount = sessions.length;

                 tbody.innerHTML = sessions.map(s => {
                    const currentTeacherId = String(s.actual_teacher_id);
                    const originalTeacherId = String(p.teacher_id);
                    const teacherName = teacherMap.get(currentTeacherId) || s.actual_teacher_id || "-";
                    const isCancelled = (s.status || '').includes('Cancelled');
                    
                    let statusHtml = `<span class="px-2 py-0.5 rounded text-xs font-bold bg-green-100 text-green-700">Active</span>`;
                    if (isCancelled) statusHtml = `<span class="px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-700">${s.status}</span>`;
                    
                    let coverageHtml = '';
                    let isCovered = false;
                    
                    if (isCancelled) {
                            coverageHtml = `<div class="text-gray-400 text-xs mb-1"><i class="fas fa-ban"></i> Class Cancelled</div>`;
                            isCovered = true;
                    } else if (currentTeacherId && currentTeacherId !== originalTeacherId && currentTeacherId !== 'undefined') {
                            coverageHtml = `<div class="text-teal-600 text-xs font-bold mb-1"><i class="fas fa-user-check"></i> Covered by ${teacherName}</div>`;
                            isCovered = true;
                    } else {
                            coverageHtml = `<div class="text-xs text-orange-600 font-bold mb-1"><i class="fas fa-user-times"></i> Not Covered</div>`;
                    }
                    if(isCovered) coveredCount++;

                    return `<tr class="hover:bg-gray-50 border-b">
                        <td class="px-3 py-2 text-sm font-bold text-blue-600 whitespace-nowrap">${(s.start_time||'').substring(0,5)} - ${(s.end_time||'').substring(0,5)}</td>
                        <td class="px-3 py-2 text-sm text-gray-700">${s.class_name || '-'}</td>
                        <td class="px-3 py-2 text-sm text-gray-600">
                            <div>${teacherName}</div>
                            <div class="mt-1">${statusHtml}</div>
                        </td>
                        <td class="px-3 py-2 align-middle">
                            ${coverageHtml}
                        </td>
                    </tr>`;
                 }).join('');

                 // Validation Summary (Partial)
                 const dbCovRef = document.getElementById('coverageSummary');
                 if(dbCovRef && !dbStat.className.includes('hidden') && totalCount > 0) {
                     dbCovRef.classList.remove('hidden');
                     if(coveredCount === totalCount) {
                         dbCovRef.className = "mt-1 pt-1 border-t border-blue-200 text-xs font-bold text-teal-600 flex items-center";
                         dbCovRef.innerHTML = `<i class="fas fa-check-circle mr-1"></i> Operations Complete! All ${totalCount} classes are covered/cancelled.`;
                     } else {
                         dbCovRef.className = "mt-1 pt-1 border-t border-blue-200 text-xs font-bold text-orange-600 flex items-center";
                         dbCovRef.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i> Attention: Only ${coveredCount}/${totalCount} classes are covered.`;
                     }
                 }
            }

        } else if (Array.isArray(raw) && raw.length > 0) {
            container.classList.remove('hidden');
            loading.classList.remove('hidden');
            
            const sessionInfo = raw.map(s => {
                let time = "?"; if(typeof s === 'string' && s.split('_').length >= 3) time = s.split('_')[2].substring(0,5);
                return { id: s, time: time };
            });

            // Fetch Session Data
            const { data: sessions } = await db.from('fact_daily_session').select('*').in('session_id', sessionInfo.map(x=>x.id));
            loading.classList.add('hidden');
            
            const sessionMap = new Map();
            if(sessions) sessions.forEach(s => sessionMap.set(s.session_id, s));
            
            // Calculate Coverage Summary
            let coveredCount = 0;
            let totalCount = sessionInfo.length;

            tbody.innerHTML = sessionInfo.map(item => {
                const s = sessionMap.get(item.id);
                if(s) {
                    const currentTeacherId = String(s.actual_teacher_id);
                    const originalTeacherId = String(p.teacher_id);
                    const isCancelled = (s.status || '').includes('Cancelled');
                    
                    let statusHtml = `<span class="px-2 py-0.5 rounded text-xs font-bold bg-green-100 text-green-700">Active</span>`;
                    if (isCancelled) statusHtml = `<span class="px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-700">${s.status}</span>`;
                    
                    // --- Admin Coverage Check ---
                    // Simply checking if the teacher is substituted
                    let coverageHtml = '';
                    let isCovered = false;
                    
                    if (isCancelled) {
                            coverageHtml = `<div class="text-gray-400 text-xs mb-1"><i class="fas fa-ban"></i> Class Cancelled</div>`;
                            isCovered = true;
                    } else if (currentTeacherId && currentTeacherId !== originalTeacherId && currentTeacherId !== 'undefined') {
                            coverageHtml = `<div class="text-teal-600 text-xs font-bold mb-1"><i class="fas fa-user-check"></i> Covered by ${teacherName}</div>`;
                            isCovered = true;
                    } else {
                            coverageHtml = `<div class="text-xs text-orange-600 font-bold mb-1"><i class="fas fa-user-times"></i> Not Covered</div>`;
                    }
                    if(isCovered) coveredCount++;

                    return `<tr class="hover:bg-gray-50 border-b">
                        <td class="px-3 py-2 text-sm font-bold text-blue-600 whitespace-nowrap">${(s.start_time||'').substring(0,5)} - ${(s.end_time||'').substring(0,5)}</td>
                        <td class="px-3 py-2 text-sm text-gray-700">${s.class_name || '-'}</td>
                        <td class="px-3 py-2 text-sm text-gray-600">
                            <div>${teacherName}</div>
                            <div class="mt-1">${statusHtml}</div>
                        </td>
                        <td class="px-3 py-2 align-middle">
                            ${coverageHtml}
                        </td>
                    </tr>`;
                }
                return `<tr class="bg-red-50 border-b"><td class="px-3 py-2 text-sm font-bold text-gray-400 font-mono">${item.time}</td><td class="px-3 py-2 text-sm text-gray-400 italic" colspan="3">Details not found</td></tr>`;
            }).join('');
            
            // Show Summary if DB Record Exists
            const dbCovRef = document.getElementById('coverageSummary');
            if(dbCovRef && !dbStat.className.includes('hidden') && totalCount > 0) {
                 dbCovRef.classList.remove('hidden');
                 if(coveredCount === totalCount) {
                     dbCovRef.className = "mt-1 pt-1 border-t border-blue-200 text-xs font-bold text-teal-600 flex items-center";
                     dbCovRef.innerHTML = `<i class="fas fa-check-circle mr-1"></i> Operations Complete! All ${totalCount} classes are covered/cancelled.`;
                 } else {
                     dbCovRef.className = "mt-1 pt-1 border-t border-blue-200 text-xs font-bold text-orange-600 flex items-center";
                     dbCovRef.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i> Attention: Only ${coveredCount}/${totalCount} classes are covered.`;
                 }
            }

        } else {
             container.classList.remove('hidden'); tbody.innerHTML = `<tr><td colspan="4" class="px-3 py-4 text-center text-sm text-gray-500 italic">Full Day Holiday</td></tr>`;
        }

        // --- Status Dropdown ---
        const select = document.getElementById('modalStatusSelect');
        select.value = p.status; // Set current status
        
        // Colorize Select
        const updateSelectColor = (val) => {
            select.className = "flex-1 form-select block w-full pl-3 pr-10 py-2 text-base sm:text-sm rounded-md shadow-sm border focus:outline-none transition-colors duration-300 ";
            if(val === 'Approved') select.classList.add('bg-green-50', 'text-green-700', 'border-green-300');
            else if(val === 'Rejected') select.classList.add('bg-gray-100', 'text-gray-500', 'border-gray-300');
            else if(val === 'Cancelled') select.classList.add('bg-red-50', 'text-red-700', 'border-red-300');
            else select.classList.add('bg-orange-50', 'text-orange-700', 'border-orange-300');
        }
        updateSelectColor(p.status);
        select.onchange = (e) => { updateSelectColor(e.target.value); }; // Just change color, don't save yet

        document.getElementById('eventModal').classList.remove('hidden');
    }

    function closeModal() { document.getElementById('eventModal').classList.add('hidden'); currentEventId = null; }

    async function saveStatus() {
        if(!currentEventId) return;
        const select = document.getElementById('modalStatusSelect');
        const btn = document.getElementById('btnUpdateStatus');
        const newStatus = select.value;
        const originalText = btn.innerText;

        // 1. Loading UI
        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
        
        try {
            // 2. DB Update
            const { error } = await db.from('requests_log').update({ status: newStatus }).eq('id', currentEventId);
            if (error) throw error;
            
            // 3. Optimistic Calendar Update
            const evt = calendar.getEventById(currentEventId.toString());
            if(evt) {
                // Update Props
                evt.setExtendedProp('status', newStatus);
                
                // Update Color
                let bg, border, text;
                const isLeave = evt.extendedProps.isLeave;
                // Copy logic from fetchEvents (simplified)
                if (newStatus === 'Rejected') { bg = '#f3f4f6'; border = 'transparent'; text = '#9ca3af'; }
                else if (newStatus === 'Cancelled') { bg = '#fef2f2'; border = '#fee2e2'; text = '#991b1b'; }
                else if (newStatus === 'Pending') { /* Keep orig or partial? */ bg = '#fff7ed'; border='#fdba74'; text='#9a3412'; } 
                else if (isLeave) { // Approved Leave
                    const type = (evt.extendedProps.leave_type || '').toLowerCase();
                    if(type.includes('sick')) { bg = '#ffe4e6'; border = '#fda4af'; text = '#be123c'; }
                    else if(type.includes('business')) { bg = '#dbeafe'; border = '#93c5fd'; text = '#1e40af'; }
                    else { bg = '#e0e7ff'; border = '#a5b4fc'; text = '#3730a3'; }
                } else { // Approved School
                    bg = '#ccfbf1'; border = '#5eead4'; text = '#115e59'; 
                }
                
                evt.setProp('backgroundColor', bg);
                evt.setProp('borderColor', border);
                evt.setProp('textColor', text);
                
                // Remove Pending Ring if not pending
                let classNames = [...evt.classNames];
                if(newStatus !== 'Pending') {
                    classNames = classNames.filter(c => !c.includes('ring'));
                } else {
                    if(!classNames.includes('ring-2')) classNames.push('ring-2', 'ring-orange-400', 'ring-dashed', 'z-10');
                }
                evt.setProp('classNames', classNames);
            }
            
            // 4. Success UI
            btn.innerHTML = `<i class="fas fa-check"></i>`;
            setTimeout(() => { 
                btn.innerHTML = originalText; 
                btn.disabled = false;
                closeModal();
            }, 500);

        } catch (err) { 
            alert("Error updating: " + err.message); 
            btn.innerHTML = "Error";
            btn.disabled = false;
        }
    }

    // --- Bulk Coverage Check ---
    async function checkCoverageForView() {
        const events = calendar.getEvents();
        // Target: Not Rejected/Cancelled, No status yet
        const targets = events.filter(e => {
            const p = e.extendedProps;
            return p.status !== 'Rejected' && p.status !== 'Cancelled' && !p.coverageStatus;
        });

        if(targets.length === 0) return;

        // Process in parallel
        await Promise.all(targets.map(async (e) => {
            const p = e.extendedProps;
            const raw = parseSessions(p.affected_sessions);
            let rows = [];

            try {
                if (p.isLeave) { // Teacher Logic
                    if (typeof raw === 'object' && raw.startTime && p.teacher_id) {
                        // Partial Day
                        const { data } = await db.from('fact_daily_session')
                            .select('status, actual_teacher_id')
                            .eq('original_teacher_id', p.teacher_id)
                            .eq('date', p.start_date)
                            .gte('start_time', raw.startTime)
                            .lte('end_time', raw.endTime);
                        rows = data || [];
                    } else if (Array.isArray(raw) && raw.length > 0) {
                        // ID List
                        const ids = raw.map(s => (typeof s==='string' && s.includes('_')) ? s : null).filter(Boolean);
                        if(ids.length > 0) {
                            const { data } = await db.from('fact_daily_session')
                                .select('status, actual_teacher_id')
                                .in('session_id', ids);
                            rows = data || [];
                        }
                    } else return; // Full Day (maybe check all classes?)

                    if(rows.length > 0) {
                        const total = rows.length;
                        let cancelled = rows.filter(r => (r.status || '').includes('Cancelled')).length;
                        // Count covered (substitution)
                        let covered = rows.filter(r => !(r.status || '').includes('Cancelled') && String(r.actual_teacher_id) !== String(p.teacher_id) && String(r.actual_teacher_id) !== 'undefined').length;
                        
                        if (cancelled === total) e.setExtendedProp('coverageStatus', 'all_cancelled');
                        else if ((cancelled + covered) === total) e.setExtendedProp('coverageStatus', 'all_covered');
                        else if (cancelled > 0 || covered > 0) e.setExtendedProp('coverageStatus', 'partial');
                    }

                } else { // School Logic
                     const schoolId = schoolCodeMap.get(p.school_code);
                     if(schoolId) {
                         const { data } = await db.from('fact_daily_session')
                             .select('status')
                             .eq('school_id', schoolId)
                             .gte('date', p.start_date)
                             .lte('date', p.end_date || p.start_date);
                         
                         if(data && data.length > 0) {
                             const total = data.length;
                             const cancelled = data.filter(s => (s.status || '').includes('Cancelled')).length;
                             
                             if (cancelled === total) e.setExtendedProp('coverageStatus', 'all_cancelled'); // Green
                             else e.setExtendedProp('coverageStatus', 'partial'); // Orange (Warning)
                         } else {
                             // E.g. No classes found -> Maybe already handled or weekend? 
                             // Treat as neutral or covered?
                             // Let's leave blank for now unless requested.
                         }
                     }
                }
            } catch(err) { console.warn("Coverage check fail:", err); }
        }));
    }
</script>
</body>
</html>
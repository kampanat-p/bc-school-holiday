<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <title>BC Timeline (Supabase)</title>
  <script type="text/javascript" src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script>
  <link href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <!-- SUPABASE SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    /* Global & Layout */
    body, html { height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; overflow: hidden; display: flex; flex-direction: column; }
    
    .header-section { padding: 8px 15px; background: white; border-bottom: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 10; flex-shrink: 0; }
    
    /* [FIXED] Visualization Area */
    #visualization { 
        flex-grow: 1; 
        width: 100%; 
        background-color: white; 
        position: relative; 
        overflow: hidden; /* ‡πÉ‡∏´‡πâ Vis.js ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ scroll */
    }

    /* [FIXED] Sim Controls Bar - ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Flow ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á */
    #sim-controls { 
        background: #263238; 
        color: white; 
        padding: 12px 20px; 
        box-shadow: 0 -2px 10px rgba(0,0,0,0.2); 
        z-index: 15000; 
        display: none; /* Flex when active */
        align-items: center; 
        justify-content: center; 
        gap: 30px; 
        font-family: 'Segoe UI', sans-serif;
        border-top: 3px solid #E040FB;
        flex-shrink: 0; /* ‡∏´‡πâ‡∏≤‡∏°‡∏´‡∏î */
        width: 100%;
        box-sizing: border-box;
    }
    
    /* ... (CSS ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ... */
    #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); z-index: 20000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loading-text { margin-top: 15px; color: #555; font-size: 16px; font-weight: bold; }
    .error-text { margin-top: 10px; color: #d32f2f; font-size: 14px; font-weight: bold; padding: 10px; background: #ffebee; border-radius: 4px; display: none; text-align: center; max-width: 80%; }

    .vis-item { border-right: 2px solid white !important; border-left: 2px solid white !important; border-radius: 0px !important; opacity: 0.95; height: 40px !important; display: flex !important; align-items: center; justify-content: center; cursor: pointer; color: #333 !important; } 
    .vis-item .vis-item-content { padding: 0 5px; font-size: 11px; font-weight: 600; line-height: 1.2; text-align: center; width: 100%; color: inherit; }
    
    /* [COLOR UPDATE v10.6] Pastel Palette */
    .vis-item.group-thesaban { background-color: #FDB2D7; border-color: #F885BE; color: #880E4F !important; }
    .vis-item.group-obec3 { background-color: #FDA07D; border-color: #FB8C66; color: #BF360C !important; }
    .vis-item.group-private { background-color: #C7B5E9; border-color: #B39DDB; color: #4527A0 !important; }
    .vis-item.group-obec-south { background-color: #FFDF7F; border-color: #FFCF3F; color: #795548 !important; }
    .vis-item.group-other { background-color: #E2E8F0; border-color: #CBD5E1; color: #475569 !important; }
    
    /* [ANIMATION v10.7] Live Pulse */
    @keyframes pulse-live-border {
        0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); border-color: #4CAF50; }
        70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); border-color: #4CAF50; }
        100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); border-color: #4CAF50; }
    }
    .vis-item.status-live {
        z-index: 1000;
        animation: pulse-live-border 2s infinite;
        border: 2px solid #4CAF50 !important;
    }

    .vis-item.status-cancelled { background-color: #ffffff !important; color: #d32f2f !important; border: 2px dashed #d32f2f !important; }
    .vis-item.status-covered { border-top: 4px solid #00E676 !important; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
    .vis-item.status-simulated { background-color: rgba(156, 39, 176, 0.9) !important; border: 2px dashed #7B1FA2 !important; color: white !important; box-shadow: 0 4px 8px rgba(0,0,0,0.3); z-index: 1000; }
    .vis-item.status-sim-cancelled { background-color: #eeeeee !important; border: 2px dotted #aaa !important; color: #888 !important; opacity: 0.5; text-decoration: line-through; pointer-events: none; }
    .vis-item.sim-moved-original { opacity: 0.3; text-decoration: line-through; background-color: #ccc !important; border-color: #aaa !important; pointer-events: none; }

    .vis-time-axis .vis-grid.vis-minor { border-color: #f0f0f0; }
    .vis-time-axis .vis-text.vis-major { display: none; } 
    .vis-time-axis .vis-text.vis-minor { transform: rotate(-90deg); transform-origin: left bottom; white-space: nowrap; margin-top: -5px; margin-left: 2px; font-size: 10px; color: #666; }

    .vis-custom-time.mouse-ruler { background-color: rgba(255, 0, 0, 0.5); width: 1px; pointer-events: none; z-index: 100; }
    .vis-custom-time.mouse-ruler .vis-custom-time-marker { display: none; }
    #mouse-tooltip { position: absolute; background: rgba(255, 255, 255, 0.95); border: 1px solid #d32f2f; color: #d32f2f; padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; pointer-events: none; display: none; z-index: 10000; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.15); transform: translate(15px, 15px); }
    .vis-custom-time.current-ruler { background-color: #2962FF; width: 2px; pointer-events: none; z-index: 99; }
    .vis-custom-time.current-ruler .vis-custom-time-marker { background-color: #2962FF; color: white; font-size: 11px; font-weight: bold; padding: 2px 6px; border-radius: 4px; top: 0px; white-space: nowrap; display: block !important; }

    .controls-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; justify-content: space-between; }
    .left-group { display: flex; align-items: center; gap: 10px; }
    h2 { margin: 0; color: #333; font-size: 1.1rem; }
    input[type="date"] { padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
    .btn { padding: 6px 12px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; font-weight: bold; font-size: 13px; }
    .btn:hover { background: #0056b3; }
    .btn-log { background: #6f42c1; color: white; }
    .btn-zoom { background: #6c757d; color: white; padding: 6px 10px; font-size: 14px; }
    .toggle-container { display: flex; align-items: center; gap: 5px; font-size: 13px; margin-left: 10px; border-left: 1px solid #ccc; padding-left: 10px; }
    .legend { display: flex; gap: 10px; font-size: 11px; flex-wrap: wrap; margin-top: 5px; }
    .legend-item { display: flex; align-items: center; gap: 3px; }
    .color-box { width: 10px; height: 10px; border-radius: 2px; }

    .sim-status { display: flex; flex-direction: column; align-items: center; }
    .sim-status-title { font-weight: bold; font-size: 16px; color: #E040FB; text-transform: uppercase; letter-spacing: 1px; }
    .sim-status-desc { font-size: 12px; color: #ccc; margin-top: 3px; }
    
    .btn-finish-sim { background: #00E676; border: none; color: #004D40; padding: 10px 25px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 14px; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
    .btn-finish-sim:hover { background: #00C853; transform: scale(1.05); }
    
    .btn-clear-sim { background: transparent; border: 1px solid #FF5252; color: #FF5252; padding: 8px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 13px; transition: 0.2s; }
    .btn-clear-sim:hover { background: rgba(255, 82, 82, 0.1); }

    .modal { display: none; position: fixed; z-index: 5000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(2px); }
    .modal-content { background-color: #fefefe; margin: 2% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 8px; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; margin-left: 10px;}
    .log-header { border-bottom: 1px solid #eee; margin-bottom: 15px; padding-bottom: 10px; }
    .log-header h2 { margin: 0; font-size: 20px; color: #333; }
    .log-meta { font-size: 12px; color: #666; margin-top: 5px; }
    
    .log-section { margin-bottom: 20px; background: #fcfcfc; border-radius: 6px; padding: 15px; border: 1px solid #eee; }
    .log-section h3 { margin: 0 0 12px 0; font-size: 15px; border-bottom: 2px solid #eee; padding-bottom: 8px; color: #444; }
    .log-item { padding: 10px 0; border-bottom: 1px dashed #e0e0e0; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
    .log-item:last-child { border-bottom: none; }
    .badge-cancel { color: #d32f2f; background: #ffebee; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
    .badge-cover { color: #00695c; background: #e0f2f1; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }

    .sim-header { background: #e3f2fd; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #90caf9; }
    .sim-header strong { color: #1565C0; display: block; margin-bottom: 3px; font-size: 14px;}
    .sim-note { font-size: 11px; color: #E65100; background: #FFF3E0; padding: 8px; border-radius: 4px; margin-top: 8px; border-left: 4px solid #FF9800; display: flex; align-items: center; gap: 5px; }

    .teacher-card { display: flex; justify-content: space-between; align-items: center; padding: 12px; margin-bottom: 8px; background: white; border: 1px solid #e0e0e0; border-radius: 6px; transition: 0.2s; }
    .teacher-card.absent { background: #fafafa !important; border: 1px solid #eee; color: #999; }
    .teacher-card.absent .t-name { color: #777; }
    .teacher-card:hover { border-color: #2196F3; background: #f0f7ff !important; transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    
    .teacher-info { display: flex; flex-direction: column; }
    .t-name { font-weight: bold; font-size: 14px; color: #333; }
    .t-type { font-size: 11px; color: #666; display: flex; align-items: center; gap: 5px; margin-top: 2px;}
    .t-qual { font-size: 10px; color: #2E7D32; background: #E8F5E9; padding: 2px 6px; border-radius: 10px; font-weight: bold; }
    
    .t-workload { font-size: 12px; margin-right: 20px; font-weight: 500; text-align: right; min-width: 80px; }
    .load-low { color: #388E3C; }
    .load-med { color: #F57C00; }
    .load-high { color: #D32F2F; font-weight: bold; }
    .warning-text { color: #D32F2F; font-size: 10px; font-weight: bold; margin-top: 4px; display:flex; align-items:center; gap:3px; background:#ffebee; padding:2px 5px; border-radius:4px; width:fit-content;}
    
    .btn-select { background: #28a745; color: white; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: bold; }
    .btn-select:hover { background: #218838; }
    .btn-sim-cancel { background: #e53935; color: white; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; }
    .btn-sim-cancel:hover { background: #c62828; }

    .loading-sim { text-align: center; color: #666; padding: 30px; font-style: italic;}
    .modal-actions { margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; border-top: 1px solid #eee; padding-top: 15px; }
    .btn-action { padding: 8px 16px; border-radius: 4px; font-size: 12px; cursor: pointer; border: 1px solid #ccc; background: white; display: flex; align-items: center; gap: 5px; }
    .btn-action:hover { background: #f0f0f0; border-color: #bbb; }

    /* [MOBILE OPTIMIZATIONS] */
    @media (max-width: 768px) {
        .vis-item { height: 55px !important; } /* Taller items for touch */
        .vis-item .vis-item-content { font-size: 13px !important; font-weight: 600; }
        
        /* Time Axis: Make readable */
        .vis-time-axis .vis-text.vis-minor { 
            font-size: 11px !important; 
            color: #333 !important;
            font-weight: bold;
            /* On mobile JS will set step to 30 mins, allowing horizontal text */
            transform: none !important; 
            margin-top: 2px !important;
        }

        /* Layout Adjustments */
        .controls-row { gap: 10px; }
        .left-group { width: 100%; justify-content: space-between; }
        .left-group h2 { font-size: 1rem; }
        
        /* Buttons larger for touch */
        .btn, .btn-zoom { padding: 8px 12px; font-size: 14px; }
        
        /* Legend Scrollable */
        .legend { flex-wrap: nowrap; overflow-x: auto; padding-bottom: 8px; -webkit-overflow-scrolling: touch; }
        .legend-item { flex-shrink: 0; background: #fff; padding: 2px 5px; border-radius: 4px; border: 1px solid #eee; }

        #sim-controls { flex-direction: column; gap: 15px; padding: 15px; }
        .sim-status { text-align: center; }
        .btn-finish-sim, .btn-clear-sim { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>


  <script>
    // Global Error Handler
    window.onerror = function(msg, url, line, col, error) {
        console.error("üî• ERROR: " + msg + "\nLine: " + line);
        return false;
    };
    function debugLog(msg) {
        console.log(msg);
    }
    // Test Log
    debugLog("Script loaded. checking supabase...");
  </script>

  <div id="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text" id="loading-text">Loading Timetable...</div>
    <div class="error-text" id="error-text"></div>
  </div>

  <div class="header-section">
    <div class="controls-row">
      <div class="left-group">
        <h2>üìÖ Master Timetable</h2>
        <input type="date" id="datePicker">
        <button class="btn" onclick="manualReload()">Refresh</button>
        <div class="toggle-container">
            <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()">
            <label for="autoRefresh">Auto (1m)</label>
        </div>
      </div>
      
      <div class="left-group">
        <button class="btn btn-zoom" onclick="zoom(-0.2)">‚ûï</button>
        <button class="btn btn-zoom" onclick="zoom(0.2)">‚ûñ</button>
        <button class="btn" style="background:#6c757d;" onclick="resetZoom()">Reset</button>
        <button class="btn btn-log" onclick="showLogs()">üìã View Logs (<span id="logCount">0</span>)</button>
      </div>
    </div>

    <div class="legend">
        <div class="legend-item"><div class="color-box" style="background:#FDB2D7;"></div>Thesaban</div>
        <div class="legend-item"><div class="color-box" style="background:#FDA07D;"></div>OBEC3</div>
        <div class="legend-item"><div class="color-box" style="background:#C7B5E9;"></div>Private</div>
        <div class="legend-item"><div class="color-box" style="background:#FFDF7F;"></div>OBEC South</div>
        <div class="legend-item"><div class="color-box" style="background:#E2E8F0;"></div>Other</div>
        <div class="legend-item"><div class="color-box" style="background:white; border:1px dashed #d32f2f;"></div>Cancelled</div>
        <div class="legend-item"><div class="color-box" style="background:#eee; border-top:3px solid #00E676;"></div>Covered</div>
        <div class="legend-item">| üëî Full-time | ‚è≥ Part-time</div>
        <div class="legend-item"><div class="color-box" style="background:rgba(156, 39, 176, 0.8);"></div>Simulated</div>
        <div class="legend-item"><div class="color-box" style="background:#eee; border:2px dotted #aaa;"></div>Sim-Cancel</div>
    </div>
  </div>

  <div id="visualization"></div>
  <div id="mouse-tooltip">00:00</div>

  <div id="sim-controls">
    <div id="version-display" style="position:fixed; bottom:5px; right:5px; opacity:0.5; font-size:10px; z-index:9999; color:#888;">v10.8 (Mobile UX)</div>
      <div class="sim-status">
          <span class="sim-status-title">üîÆ Simulation Mode Active</span>
          <span class="sim-status-desc">Changes are temporary. Click items to simulate moves.</span>
      </div>
      <button class="btn-finish-sim" onclick="finishSimulation()">üìã Finish & Get Summary</button>
      <button class="btn-clear-sim" onclick="clearSimulation()">‚úñ Exit & Reset</button>
  </div>

  <!-- Log Modal -->
  <div id="logModal" class="modal">
    <div class="modal-content" id="modalCaptureTarget">
      <div class="log-header">
          <span class="close" onclick="closeModal('logModal')">&times;</span>
          <h2 id="modalTitle">Daily Report</h2>
          <div class="log-meta">Date: <span id="reportDate"></span> | Last updated: <span id="lastUpdated"></span></div>
      </div>
      <div id="logBody">Loading...</div>
      <div class="modal-actions" data-html2canvas-ignore="true">
          <button class="btn-action" onclick="copyLogText()">üìã Copy Text</button>
          <button class="btn-action" onclick="exportLogImage()">üì∏ Save Image</button>
      </div>
    </div>
  </div>

  <!-- Simulation Modal -->
  <div id="simModal" class="modal">
    <div class="modal-content">
      <div class="log-header">
          <span class="close" onclick="closeModal('simModal')">&times;</span>
          <h2>üõ†Ô∏è Cover Simulator</h2>
      </div>
      <div id="simBody">
          <div class="loading-sim">üîç Checking availability...</div>
      </div>
    </div>
  </div>

  <script>
    // --------------------------------------------------------
    // SETUP SUPABASE
    // --------------------------------------------------------
    const SUPABASE_URL = "https://cgznmxcecljfybcgujjb.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnem5teGNlY2xqZnliY2d1ampiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2Nzc2NTI1MywiZXhwIjoyMDgzMzQxMjUzfQ.kTov9RFS-FVDNZokkslR0jFH2zaKTUYSBH9NQ8aItlQ";
    // Defer initialization to loadData or ensure loaded
    
    var timeline;
    var visItemsDataSet;
    var groupsDataSet;
    var currentLogData = null;
    var autoRefreshInterval;
    var currentTimer;
    
    // Simulation Vars
    var isSimMode = false;
    var currentSimTarget = null;
    var simState = { removed: [], added: [] }; 
    var simulatedItemIds = []; 
    var simLog = [];
    var visibleTeachersCache = new Set();
    
    // Cache Master Data
    var cachedUsers = null;
    var cachedSchools = null;

    window.onload = function() {
        // [FIX] Force Date to Bangkok Time Zone for default value
        var now = new Date();
        // Adjust to UTC+7
        var bkkTime = new Date(now.getTime() + (7 * 60 * 60 * 1000) + (now.getTimezoneOffset() * 60000));
        var bkkDateStr = bkkTime.toISOString().slice(0, 10);
        
        document.getElementById('datePicker').value = bkkDateStr;
        
        loadData();
        setInterval(updateCurrentTimeRuler, 60000);
    };

    function updateStatus(msg) {
        var el = document.getElementById('loading-text');
        if(el) el.innerText = msg;
        console.log("[Status] " + msg);
    }

    function showError(msg) {
        var el = document.getElementById('error-text');
        if(el) {
            el.innerText = msg;
            el.style.display = 'block';
        }
        document.querySelector('.spinner').style.borderTopColor = '#d32f2f'; // Red spinner
    }

    function manualReload() { loadData(); }

    function toggleAutoRefresh() {
        var checkbox = document.getElementById('autoRefresh');
        if (checkbox.checked) {
            autoRefreshInterval = setInterval(loadData, 30000); 
        } else {
            clearInterval(autoRefreshInterval);
        }
    }

    function debugLog(msg) {
        console.log(msg);
        const area = document.getElementById('debug-output');
        if(area) {
            area.value += msg + "\n";
            document.getElementById('debug-section').style.display = 'block';
        }
    }

    async function fetchMasterData() {
        // ... (Same as before)
        if (cachedUsers) return; 

        updateStatus("Loading Teachers & Schools...");
        debugLog("Starting Master Data Load...");
        
        // Ensure Supabase client logic
        const sb = getSupabase();

        // [USER MAPPING FIX]
        // In Supabase, the fact_daily_session table uses the User PK (user_id), NOT the braincloud_id.
        // But dim_user has PK "user_id".
        // Let's load the mapping properly.
        const { data: users, error: uErr } = await sb.from('dim_user').select('user_id, braincloud_id, firstname_en, lastname_en, user_type, position, affiliation, status, qualification');
        
        if (uErr) {
             console.error("Error loading users:", uErr);
             debugLog("Error loading users: " + uErr.message);
        }
        
        // [SCHOOL MAPPING FIX]
        // Assuming fact_daily_session.school_id -> dim_school.school_id (PK)
        let schools = [];
        try {
            const { data: sData, error: sErr } = await sb.from('dim_school').select('*');
            if (!sErr) schools = sData;
        } catch(e) { console.log("Skipping school load"); }

        cachedUsers = {};
        if (users) {
            users.forEach(u => {
                let isFT = (String(u.user_type) === '210' || String(u.position) === '210');
                let fname = u.firstname_en || "";
                let lname = u.lastname_en || "";
                let initial = lname ? lname.charAt(0) + "." : "";
                
                // Key = PK (user_id) because that's what's in fact_daily_session
                // Note: user_id might be int, convert to string
                cachedUsers[String(u.user_id).trim()] = {
                    name: `${fname} ${initial}`,
                    isFullTime: isFT,
                    bcId: u.braincloud_id,
                    affiliation: u.affiliation,
                    status: u.status,
                    position: u.position,
                    qualification: u.qualification || ""
                };
            });
        }

        cachedSchools = {};
        if (schools) {
            schools.forEach(s => {
                cachedSchools[String(s.school_id)] = {
                    code: s.school_code || s.school_name || s.school_id, 
                    group: s.region_group_name || s.school_group || "Other"
                };
            });
        }
        
        debugLog(`Loaded ${Object.keys(cachedUsers).length} users and ${Object.keys(cachedSchools).length} schools.`);
        debugLog("User Keys: " + JSON.stringify(Object.keys(cachedUsers).slice(0, 5)));
        debugLog("School Keys: " + JSON.stringify(Object.keys(cachedSchools).slice(0, 5)));
    }
    
    function getSupabase() {
        if (window.supabaseClient) return window.supabaseClient;
        if (window.supabase) {
             window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
             return window.supabaseClient;
        }
        throw new Error("Supabase Library not loaded. Check your connection or AdBlocker.");
    }

    async function loadData() {
        if(isSimMode) return; 
        document.getElementById('loading-overlay').style.display = 'flex';
        document.getElementById('error-text').style.display = 'none';
        var date = document.getElementById('datePicker').value;

        try {
            updateStatus("Connecting to Database...");
            // Initial check
            var sb = getSupabase();

            await fetchMasterData(); // Ensure users/schools loaded

            updateStatus(`Fetching Schedule for ${date}...`);
            const { data: sessions, error: sErr } = await sb
                .from('fact_daily_session')
                .select('*')
                .eq('date', date);
            
            if (sErr) throw new Error("Supabase Query Error: " + sErr.message);

            updateStatus("Processing Data...");
            processSupabaseData(sessions, date);

        } catch (e) {
            showError("Error: " + e.message);
            console.error(e);
            // Keep overlay visible to show error
        }
    }

    function processSupabaseData(rows, targetDate) {
        let items = [];
        let groups = [];
        let visibleTeachers = new Set();
        let logs = { cancelled: [], covered: [], stats: { total: 0, cancel: 0, cover: 0 }, generatedAt: new Date().toLocaleTimeString() };
        
        // --- TIME CHECK for "LIVE" status (Bangkok) ---
        const now = new Date();
        const bkkTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Bangkok"}));
        const currentH = bkkTime.getHours();
        const currentM = bkkTime.getMinutes();
        const currentTotalMins = currentH * 60 + currentM;

        // Check if selected date is Today
        // targetDate is 'YYYY-MM-DD'
        const bkkDateStr = bkkTime.toLocaleDateString('en-CA', { timeZone: "Asia/Bangkok" });
        const isToday = (targetDate === bkkDateStr);

        if (rows && rows.length > 0) {
            debugLog(`First Row: Actual=${rows[0].actual_teacher_id}, Original=${rows[0].original_teacher_id}`);
            
            rows.forEach(r => {
                let actualId = String(r.actual_teacher_id).trim();
                let originalId = String(r.original_teacher_id).trim();
                
                if (cachedUsers[actualId]) visibleTeachers.add(actualId);
                else if (actualId && !visibleTeachers.has(actualId)) {
                     debugLog(`MISSING TEACHER: ${actualId}`);
                     visibleTeachers.add(actualId); // Add anyway so we can see it as a group
                }
                
                if (cachedUsers[originalId]) visibleTeachers.add(originalId);

                if (!r.start_time || !r.end_time) return;

                let startTime = r.start_time.substring(0, 5);
                let endTime = r.end_time.substring(0, 5);
                let status = String(r.status || "");
                let isCancelled = status.startsWith("Cancelled");

                // --- Live Check ---
                let isLive = false;
                if(isToday && !isCancelled) {
                    const [h1, m1] = startTime.split(':').map(Number);
                    const [h2, m2] = endTime.split(':').map(Number);
                    const startMins = h1 * 60 + m1;
                    const endMins = h2 * 60 + m2;
                    if(currentTotalMins >= startMins && currentTotalMins < endMins) {
                        isLive = true;
                    }
                }
                
                logs.stats.total++;

                let schoolId = String(r.school_id);
                let schoolInfo = cachedSchools[schoolId] || { code: schoolId, group: 'Other' };
                let grp = (schoolInfo.group || "").toLowerCase();
                let colorClass = 'group-other';
                if (grp.includes('thesaban')) colorClass = 'group-thesaban';
                else if (grp.includes('obec 3')) colorClass = 'group-obec3';
                else if (grp.includes('private')) colorClass = 'group-private';
                else if (grp.includes('obec south')) colorClass = 'group-obec-south';

                let innerContent = r.class_name || r.class || ""; 
                let finalClass = colorClass;
                let tooltip = `School: ${schoolInfo.code}\nTime: ${startTime}-${endTime}`;

                let isCover = (status === "Substituted") || 
                              (status === "Normal" && originalId && actualId && actualId !== originalId);

                if (isCancelled) {
                    finalClass = 'status-cancelled';
                    let cancelBy = status.includes("School") ? "School" : "BC";
                    innerContent = `‚ùå ${innerContent} <div style="font-size:9px; margin-top:2px;">(by ${cancelBy})</div>`;
                    let tName = cachedUsers[originalId] ? cachedUsers[originalId].name : originalId;
                    logs.cancelled.push({
                        start: startTime, end: endTime, school: schoolInfo.code,
                        class: r.class_name, teacher: tName, by: cancelBy
                    });
                    logs.stats.cancel++;
                } else if (isCover) {
                    finalClass += ' status-covered';
                    let orgName = cachedUsers[originalId] ? cachedUsers[originalId].name : originalId;
                    let actName = cachedUsers[actualId] ? cachedUsers[actualId].name : actualId;
                    innerContent = `üîÑ ${innerContent} <div style="font-size:9px; margin-top:2px; opacity:0.9;">(Cover: ${orgName})</div>`;
                    tooltip += `\nCovering for: ${orgName}`;
                    logs.covered.push({
                        start: startTime, end: endTime, school: schoolInfo.code,
                        class: r.class_name, actual: actName, original: orgName
                    });
                    logs.stats.cover++;
                }

                if (isLive) {
                    finalClass += ' status-live';
                    innerContent = `<div style="display:inline-block; width:6px; height:6px; background:#4CAF50; border-radius:50%; margin-right:2px;"></div>` + innerContent;
                }

                items.push({
                    id: r.session_id,
                    group: actualId,
                    start: `${targetDate}T${startTime}:00`,
                    end: `${targetDate}T${endTime}:00`,
                    content: `<div class="content-wrapper">${innerContent}</div>`,
                    title: tooltip,
                    className: finalClass,
                    type: 'range',
                    schoolId: schoolId // store for simulation logic
                });
            });
        }

        visibleTeachers.forEach(tid => {
            let u = cachedUsers[tid] || { name: `(${tid})`, isFullTime: false };
            let nameHtml = u.isFullTime 
                ? `<span style="color:#0D47A1; font-weight:bold;">üëî ${u.name}</span>`
                : `<span style="color:#E65100; font-weight:bold;">‚è≥ ${u.name}</span>`;
            
            groups.push({
                id: tid,
                content: nameHtml,
                style: "font-size: 13px; padding: 5px;",
                _isFT: u.isFullTime 
            });
        });

        // Add ALL teachers to the groups even if they have no class, for Simulation purposes?
        // Actually for visualization we usually only show active ones. 
        // But for simulation "Available Teachers" logic, we use cachedUsers anyway.

        groups.sort((a, b) => {
            if (a._isFT !== b._isFT) return a._isFT ? -1 : 1; 
            let na = a.content.replace(/<[^>]*>/g, '').trim();
            let nb = b.content.replace(/<[^>]*>/g, '').trim();
            return na.localeCompare(nb);
        });

        currentLogData = logs; 
        visibleTeachersCache = visibleTeachers; 

        drawTimeline({ groups: groups, items: items, logs: logs }, targetDate);
    }

    function drawTimeline(data, selectedDate, silent) {
      document.getElementById('loading-overlay').style.display = 'none';
      
      currentLogData = data.logs;
      document.getElementById('logCount').innerText = (data.logs.stats.cancel + data.logs.stats.cover);
      document.getElementById('reportDate').innerText = selectedDate;
      document.getElementById('lastUpdated').innerText = data.logs.generatedAt;

      var container = document.getElementById('visualization');
      visItemsDataSet = new vis.DataSet(data.items);
      var groups = new vis.DataSet(data.groups);
      groupsDataSet = groups;

      if (silent && timeline) {
          if (isSimMode) {
              console.log("Simulating... skipping auto-refresh update.");
              return;
          }
          timeline.setData({ items: visItemsDataSet, groups: groups });
          return;
      }

      var minTime = selectedDate + 'T07:50:00'; 
      var maxTime = selectedDate + 'T17:10:00'; 

      // [MOBILE FIX] Detect screen width
      var isMobile = window.innerWidth <= 768;

      var options = {
        start: selectedDate + 'T07:50:00',
        end: selectedDate + 'T17:10:00',
        min: minTime, max: maxTime,
        height: '100%', margin: { item: 0, axis: 10 }, stack: true,
        zoomable: false, moveable: true, orientation: 'top', verticalScroll: true,
        // Adapt step for mobile to prevent cramping
        timeAxis: { scale: 'minute', step: isMobile ? 30 : 10 },
        showMajorLabels: false,
        format: { minorLabels: { minute: 'HH:mm', hour: 'HH:mm' } }
      };

      if (timeline) timeline.destroy();
      timeline = new vis.Timeline(container, visItemsDataSet, groups, options);
      
      timeline.on('select', function (properties) {
          var selectedIds = properties.items;
          if (selectedIds.length > 0) {
              var id = String(selectedIds[0]);
              
              var item = visItemsDataSet.get(id);
              if (id.startsWith('sim-')) {
                  if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ñ‡∏≤‡∏ö‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                      removeSingleSimulation(id);
                  }
                  timeline.setSelection([]);
                  return;
              }
              
              if (item && item.className && item.className.includes('sim-moved-original')) {
                  timeline.setSelection([]);
                  return;
              }
              
              if (document.getElementById('simModal').style.display === "block") return;

              if (!isSimMode) {
                  var confirmMsg = "Do you want to enter Simulation Mode?\n\n‚ö†Ô∏è Changes here are temporary and will not affect the database.";
                  if (confirm(confirmMsg)) {
                      startSimulationMode();
                      openSimulation(id, selectedDate);
                  } else {
                      timeline.setSelection([]);
                  }
              } else {
                  openSimulation(id, selectedDate);
              }
              timeline.setSelection([]);
          }
      });

      timeline.addCustomTime(new Date(), 'mouse-ruler');
      var todayStr = new Date().toISOString().split('T')[0];
      if (selectedDate === todayStr) {
          timeline.addCustomTime(new Date(), 'current-ruler');
          updateCurrentTimeRuler(); 
          if (currentTimer) clearInterval(currentTimer);
          currentTimer = setInterval(updateCurrentTimeRuler, 1000);
      } else {
          if (currentTimer) clearInterval(currentTimer);
      }

      container.addEventListener('mousemove', function (event) {
          var props = timeline.getEventProperties(event);
          timeline.setCustomTime(props.time, 'mouse-ruler');
          var tooltip = document.getElementById('mouse-tooltip');
          var timeStr = props.time.toTimeString().substring(0, 5); 
          tooltip.innerText = timeStr;
          tooltip.style.display = 'block';
          tooltip.style.left = (event.pageX + 15) + 'px';
          tooltip.style.top = (event.pageY + 15) + 'px';
      });
      container.addEventListener('mouseleave', function() {
          document.getElementById('mouse-tooltip').style.display = 'none';
      });
      
      if (data.items.length === 0 && !silent) alert("No data found for " + selectedDate);
    }

    function startSimulationMode() {
        isSimMode = true;
        document.getElementById('sim-controls').style.display = 'flex';
        if (timeline) timeline.redraw();
        if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    }

    // [MODIFIED] Client-Side Simulation Logic
    function openSimulation(sessionId, date) {
        var modal = document.getElementById('simModal');
        var body = document.getElementById('simBody');
        modal.style.display = "block";
        body.innerHTML = '<div class="loading-sim">üîç Finding substitutes...</div>';

        setTimeout(() => {
            // 1. Get Target
            var targetItem = visItemsDataSet.get(sessionId);
            if (!targetItem) {
                 renderSimulation(JSON.stringify({ error: "Session not found" }));
                 return;
            }

            // Parse text content strip tags
            var div = document.createElement('div');
            div.innerHTML = targetItem.content;
            var className = div.textContent; 

            // Parse Timings
            var tStartStr = targetItem.start.split('T')[1].substring(0, 5); 
            var tEndStr = targetItem.end.split('T')[1].substring(0, 5);
            var tStartVal = parseInt(tStartStr.replace(':',''));
            var tEndVal = parseInt(tEndStr.replace(':',''));

            var teacherId = targetItem.group;
            
            // Logic extensions
            var originalTeacher = cachedUsers[teacherId] || {};
            var originalPosition = String(originalTeacher.position || "");
            var schoolInfo = cachedSchools[targetItem.schoolId] || {};
            var isThesaban = (schoolInfo.group || "").toLowerCase().includes("thesaban");

            
            // 2. Logic
            var suggestions = [];
            var allItems = visItemsDataSet.get(); 

            // If we have cachedUsers, use it
            if(cachedUsers) {
                Object.keys(cachedUsers).forEach(uid => {
                    var user = cachedUsers[uid];
                    
                    // Filter: Only BC affiliation AND Active status
                    if (user.affiliation !== 'BC') return;
                    if (String(user.status).toLowerCase() !== 'active') return;

                    // Filter: Exclude IDs bcp-00464 to bcp-00474 (Specific exclusion)
                    if (uid.startsWith('bcp-')) {
                         var numPart = parseInt(uid.split('-')[1], 10);
                         if (numPart >= 464 && numPart <= 474) return;
                    }
                    
                    // Filter: Position Type Matching (110 vs 100)
                    // Ensure strict string comparison to handle potential number types from DB
                    var candidatePosition = String(user.position || "");
                    
                    if (originalPosition === '110' && candidatePosition !== '110') return;
                    if (originalPosition === '100' && candidatePosition !== '100') return;

                    var isBusy = false;
                    var workload = 0;

                    // Check schedule
                    allItems.forEach(item => {
                        if (String(item.group) === uid) {
                            // SKIP: "Simulated Canceled" (Transient) OR "Actual Canceled" (Not teaching)
                            if (item.className && (item.className.includes('status-sim-cancelled') || item.className.includes('status-cancelled'))) return; 

                            workload++;
                            
                            // Check Overlap
                            var iStart = item.start.split('T')[1].substring(0, 5);
                            var iEnd = item.end.split('T')[1].substring(0, 5);
                            var iStartVal = parseInt(iStart.replace(':',''));
                            var iEndVal = parseInt(iEnd.replace(':',''));

                            // (StartA < EndB) and (EndA > StartB)
                            if (tStartVal < iEndVal && tEndVal > iStartVal) {
                                isBusy = true;
                            }
                        }
                    });

                    if (!isBusy) {
                        suggestions.push({
                            id: uid,
                            name: user.name,
                            type: user.isFullTime ? 'Full-time' : 'Part-time',
                            workload: workload,
                            qualification: user.qualification || '', 
                            isAbsent: (workload === 0) 
                        });
                    }
                });
            }

            // Sort logic: 
            // 1. Zero Workload (Absent/Leave) -> Move to Bottom
            // 2. Thesaban: Qualification First
            // 3. Teacher Type (Full-time First)
            // 4. Workload (Low First)
            // 5. Name (Alphabetical)
            suggestions.sort((a, b) => {
                 if (a.isAbsent !== b.isAbsent) return a.isAbsent ? 1 : -1; 
                 
                 // Thesaban Rule
                 if (isThesaban) {
                     if (a.qualification && !b.qualification) return -1;
                     if (!a.qualification && b.qualification) return 1;
                 }
                 
                 if (a.type !== b.type) return a.type === 'Full-time' ? -1 : 1;
                 if (a.workload !== b.workload) return a.workload - b.workload;
                 return a.name.localeCompare(b.name);
            });

            var response = {
                target: {
                    id: sessionId,
                    teacherId: teacherId,
                    class: className,
                    start: tStartStr,
                    end: tEndStr,
                    school: "" // Ideally find school info from id, but not critical
                },
                isThesaban: false,
                suggestions: suggestions
            };
            
            renderSimulation(JSON.stringify(response));

        }, 100);
    }

    function renderSimulation(jsonString) {
        var data = JSON.parse(jsonString);
        var body = document.getElementById('simBody');
        
        if (data.error) {
            body.innerHTML = `<p style="color:red; text-align:center;">${data.error}</p>`;
            return;
        }

        currentSimTarget = data.target;

        var html = `
            <div class="sim-header">
                <strong>Current Selection:</strong>
                <div>${data.target.class}</div>
                <div style="font-size:12px; color:#555;">${data.target.start} - ${data.target.end}</div>
                <div style="font-size:12px; color:#555;">Original: ${getTeacherName(data.target.teacherId)}</div>
            </div>
            
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="font-size:14px; margin:0;">Available Teachers:</h3>
                <button class="btn-sim-cancel" onclick="applyCancelSimulation()">üóëÔ∏è Simulate Cancel</button>
            </div>
        `;

        // Only show top 50 to avoid lag if list is huge
        var limit = 50;
        
        if (data.suggestions.length === 0) {
            html += "<p style='text-align:center; color:#d32f2f;'>No teachers available.</p>";
        } else {
            html += '<div style="max-height:60vh; overflow-y:auto;">';
            data.suggestions.slice(0, limit).forEach((t, index) => {
                var rankColor = (index < 3 && !t.isAbsent) ? '#e8f5e9' : 'white';
                var icon = t.type === 'Full-time' ? 'üëî' : '‚è≥';
                var typeColor = t.type === 'Full-time' ? '#0D47A1' : '#E65100';
                var cardClass = t.isAbsent ? 'teacher-card absent' : 'teacher-card';
                var warningHtml = t.isAbsent ? '<div class="warning-text">‚ö†Ô∏è No active classes today (Possible Leave).</div>' : '';
                var wl = t.workload;
                var wlClass = 'load-low';
                var wlText = `${wl} classes`;
                if (wl > 4) { wlClass = 'load-med'; }
                if (wl > 6) { wlClass = 'load-high'; wlText += ' (High)'; }
                var qualHtml = t.qualification ? `<span class="t-qual">üéì ${t.qualification}</span>` : '';

                var safeName = t.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                var safeId = t.id.replace(/'/g, "\\'");

                html += `
                <div class="${cardClass}" style="background:${rankColor}">
                    <div class="teacher-info">
                        <span class="t-name">${index + 1}. ${t.name}</span>
                        <div style="display:flex; gap:5px; align-items:center; flex-wrap:wrap;">
                            <span class="t-type" style="color:${typeColor}">${icon} ${t.type}</span>
                            ${qualHtml}
                        </div>
                        ${warningHtml}
                    </div>
                    <div style="text-align:right;">
                        <div class="t-workload ${wlClass}">Today: ${wlText}</div>
                        <button class="btn-select" style="margin-top:5px;" onclick="applySimulation('${safeId}', '${safeName}')">Select</button>
                    </div>
                </div>`;
            });
            html += '</div>';
        }
        body.innerHTML = html;
    }

    function getTeacherName(id) {
        if (!groupsDataSet) return id;
        var g = groupsDataSet.get(id);
        if (g && g.content) {
            var tempDiv = document.createElement("div");
            tempDiv.innerHTML = g.content;
            var text = tempDiv.textContent || tempDiv.innerText || "";
            return text.replace('üëî', '').replace('‚è≥', '').trim();
        }
        return id;
    }

    function formatTime(t) {
        if(!t) return "";
        return t.substring(0, 5);
    }

    function applySimulation(teacherId, teacherName) {
        try {
            if (!currentSimTarget || !visItemsDataSet) return;

            var simId = 'sim-' + new Date().getTime();
            var date = document.getElementById('datePicker').value;
            
            visItemsDataSet.add({
                id: simId,
                group: teacherId,
                start: date + 'T' + currentSimTarget.start,
                end: date + 'T' + currentSimTarget.end,
                content: `üîÆ ${currentSimTarget.class} <div style='font-size:9px'>(Simulated)</div>`,
                className: 'status-simulated', 
                type: 'range'
            });

            var originalItem = visItemsDataSet.get(currentSimTarget.id);
            if (originalItem) {
                visItemsDataSet.update({
                    id: currentSimTarget.id,
                    className: originalItem.className + ' sim-moved-original'
                });
            }

            simState.removed.push(currentSimTarget.id);
            simState.added.push({ teacherId: teacherId, start: currentSimTarget.start, end: currentSimTarget.end });
            simulatedItemIds.push({ simId: simId, originalId: currentSimTarget.id });
            
            var originalTeacherName = getTeacherName(currentSimTarget.teacherId);
            var timeRange = formatTime(currentSimTarget.start) + '-' + formatTime(currentSimTarget.end);
            var logText = `Assign **${teacherName}** to cover **${currentSimTarget.class}** (${timeRange}) instead of **${originalTeacherName}**`;
            
            simLog.push({ id: simId, text: logText });

        } catch (e) {
            console.error(e);
            alert("Error: " + e.message);
        } finally {
            closeModal('simModal');
        }
    }

    function applyCancelSimulation() {
        try {
            if (!currentSimTarget || !visItemsDataSet) return;

            var originalItem = visItemsDataSet.get(currentSimTarget.id);
            if (originalItem) {
                visItemsDataSet.update({
                    id: currentSimTarget.id,
                    className: originalItem.className + ' status-sim-cancelled'
                });
            }

            simState.removed.push(currentSimTarget.id);
            var cancelSimId = 'cancel-' + new Date().getTime();
            simulatedItemIds.push({ simId: cancelSimId, originalId: currentSimTarget.id });
            
            var originalTeacherName = getTeacherName(currentSimTarget.teacherId);
            var timeRange = formatTime(currentSimTarget.start) + '-' + formatTime(currentSimTarget.end);
            var logText = `Cancel class **${currentSimTarget.class}** (${timeRange}) of **${originalTeacherName}**`;
            
            simLog.push({ id: cancelSimId, text: logText });

        } catch (e) {
            console.error(e);
        } finally {
            closeModal('simModal');
        }
    }

    function removeSingleSimulation(simId) {
        var simEntryIndex = simulatedItemIds.findIndex(s => s.simId === simId);
        if (simEntryIndex === -1) return;
        var simEntry = simulatedItemIds[simEntryIndex];

        if (!simId.startsWith('cancel-')) {
            visItemsDataSet.remove(simId);
        }

        var item = visItemsDataSet.get(simEntry.originalId);
        if (item && item.className) {
            var originalClass = item.className.replace(' sim-moved-original', '').replace(' status-sim-cancelled', '');
            visItemsDataSet.update({ id: simEntry.originalId, className: originalClass });
        }

        var removedIdx = simState.removed.indexOf(simEntry.originalId);
        if (removedIdx > -1) simState.removed.splice(removedIdx, 1);
        
        var logIdx = simLog.findIndex(l => l.id === simId);
        if (logIdx > -1) simLog.splice(logIdx, 1);

        simulatedItemIds.splice(simEntryIndex, 1);

        if (simulatedItemIds.length === 0) {
            clearSimulation();
        }
    }

    function finishSimulation() {
        var modal = document.getElementById('logModal');
        var body = document.getElementById('logBody');
        var title = document.getElementById('modalTitle');
        
        title.innerText = "üìù Simulation To-Do List";
        document.getElementById('reportDate').innerText = document.getElementById('datePicker').value;
        document.getElementById('lastUpdated').innerText = "Simulation Draft";
        
        var html = `<div class="log-section"><h3 style="color:#2E7D32;">Actions Required:</h3>`;
        
        if (simLog.length === 0) {
            html += "<p style='text-align:center; padding:10px;'>No changes simulated.</p>";
        } else {
            simLog.forEach((item, i) => {
                var cleanStep = item.text.replace(/\*\*(.*?)\*\*/g, '<b style="color:#000;">$1</b>');
                var icon = cleanStep.includes("Cancel") ? "‚ùå" : "üîÑ";
                html += `<div class="log-item" style="font-size:14px; padding:8px;">
                    <span style="margin-right:10px;">${icon}</span><span>${cleanStep}</span>
                </div>`;
            });
        }
        html += "</div>";
        body.innerHTML = html;
        modal.style.display = "block";
    }

    function clearSimulation() {
        try {
            if (!visItemsDataSet) return;
            var idsToRemove = simulatedItemIds.map(s => s.simId).filter(id => id && !id.startsWith('cancel-'));
            if (idsToRemove.length > 0) visItemsDataSet.remove(idsToRemove);
            
            simulatedItemIds.forEach(s => {
                var item = visItemsDataSet.get(s.originalId);
                if (item && item.className) {
                    var originalClass = item.className.replace(' sim-moved-original', '').replace(' status-sim-cancelled', '');
                    visItemsDataSet.update({ id: s.originalId, className: originalClass });
                }
            });
            
            simulatedItemIds = [];
            simState = { removed: [], added: [] };
            simLog = []; 
            isSimMode = false;
            
            document.getElementById('sim-controls').style.display = 'none';
            if (document.getElementById('autoRefresh').checked) toggleAutoRefresh();
            
        } catch(e) {
            console.error("Error clearing simulation:", e);
        }
    }

    function updateCustomTimeTitle(id, dateObj) {
        var timeStr = dateObj.toTimeString().substring(0, 5); 
        try {
            var marker = document.querySelector('.vis-custom-time.' + id + ' .vis-custom-time-marker');
            if (marker) marker.innerText = timeStr;
        } catch(e) {}
    }

    function updateCurrentTimeRuler() {
        var now = new Date();
        timeline.setCustomTime(now, 'current-ruler');
        updateCustomTimeTitle('current-ruler', now);
    }

    function zoom(percentage) {
        if (timeline) {
            timeline.zoomOut(percentage);
        }
    }

    function resetZoom() {
       if (timeline) {
           var date = document.getElementById('datePicker').value;
           timeline.setWindow(date + 'T07:50:00', date + 'T17:10:00');
       }
    }

    function showLogs() {
        document.getElementById('modalTitle').innerText = "Daily Report";
        var modal = document.getElementById('logModal');
        var body = document.getElementById('logBody');
        modal.style.display = "block";
        
        if (!currentLogData || (currentLogData.cancelled.length === 0 && currentLogData.covered.length === 0)) {
            body.innerHTML = "<p style='text-align:center; color:#666;'>‚úÖ No issues found.</p>";
            return;
        }

        var html = "";
        if (currentLogData.cancelled.length > 0) {
            html += `<div class="log-section"><h3>‚ùå Cancellations (${currentLogData.cancelled.length})</h3>`;
            currentLogData.cancelled.forEach(item => {
                html += `<div class="log-item"><span style="flex:1"><b>${item.start}-${item.end}</b> : ${item.class} (${item.teacher})</span><span class="badge-cancel">By ${item.by}</span></div>`;
            });
            html += "</div>";
        }
        if (currentLogData.covered.length > 0) {
            html += `<div class="log-section"><h3>üîÑ Covered (${currentLogData.covered.length})</h3>`;
            currentLogData.covered.forEach(item => {
                html += `<div class="log-item"><span style="flex:0.8"><b>${item.start}-${item.end}</b> : ${item.school} <span style="color:#555; font-size:11px;">(${item.class})</span></span><span style="flex:2; text-align:right; font-size:12px;"><span style="color:#00695c; font-weight:bold;">${item.actual}</span> <span style="color:#666;">(Covering for: ${item.original})</span></span></div>`;
            });
            html += "</div>";
        }
        body.innerHTML = html;
    }

    function closeModal(id) {
        document.getElementById(id).style.display = "none";
    }
    
    function exportLogImage() {
        var element = document.getElementById("modalCaptureTarget");
        var clone = element.cloneNode(true);
        clone.style.position = "absolute"; clone.style.top = "-9999px"; clone.style.left = "0"; clone.style.width = "500px"; clone.style.height = "auto"; clone.style.overflow = "visible"; clone.style.maxHeight = "none"; 
        var closeBtn = clone.querySelector('.close'); if(closeBtn) closeBtn.style.display = "none";
        document.body.appendChild(clone);
        html2canvas(clone, { useCORS: true, allowTaint: true, scrollY: 0, scale: 2 }).then(canvas => {
            var link = document.createElement('a');
            link.download = 'Summary_' + document.getElementById('datePicker').value + '.png';
            link.href = canvas.toDataURL();
            link.click();
            document.body.removeChild(clone);
        });
    }

    function copyLogText() {
        var isSimSummary = document.getElementById('modalTitle').innerText.includes("Simulation");
        var text = "";
        
        if (isSimSummary) {
            text = "üìù Simulation Steps:\n";
            simLog.forEach((item, i) => { text += `${i+1}. ${item.text.replace(/\*\*/g, '')}\n`; });
        } else {
            if (!currentLogData) return;
            var date = document.getElementById('datePicker').value;
            text = `üìÖ Report: ${date}\n\n`;
            if (currentLogData.cancelled.length > 0) {
                text += `‚ùå Cancellations (${currentLogData.cancelled.length}):\n`;
                currentLogData.cancelled.forEach(item => text += `- ${item.start}-${item.end} ${item.class} (${item.teacher}) [By ${item.by}]\n`);
                text += "\n";
            }
            if (currentLogData.covered.length > 0) {
                text += `üîÑ Covered (${currentLogData.covered.length}):\n`;
                currentLogData.covered.forEach(item => text += `- ${item.start}-${item.end} ${item.school} (${item.class}): ${item.actual} (Covering for: ${item.original})\n`);
            }
        }
        navigator.clipboard.writeText(text).then(() => { alert("üìã Copied!"); });
    }
    
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) event.target.style.display = "none";
    }
  </script>
</body>
</html>< ! - -   F o r c e   U p d a t e   - - > 
 
 
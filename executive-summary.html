<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Executive Summary - Braincloud</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
        
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; }
        .score-card { transition: transform 0.2s; }
        .score-card:hover { transform: translateY(-2px); }
        
        /* Table Styling */
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { background-color: #f1f5f9; color: #475569; font-weight: 600; text-align: left; padding: 12px; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
        td { padding: 10px 12px; border-bottom: 1px solid #e2e8f0; color: #334155; }
        tr:hover { background-color: #f8fafc; }
        
        .dropdown-check-list { display: inline-block; position: relative; }
        .dropdown-check-list .anchor { position: relative; cursor: pointer; display: flex; justify-content: defined; align-items: center; padding: 8px; border: 1px solid #e2e8f0; border-radius: 0.25rem; font-size: 0.75rem; background: white; min-width: 150px; }
        .dropdown-check-list .items { display: none; position: absolute; top: 100%; left: 0; right: 0; border: 1px solid #e2e8f0; background: #fff; z-index: 50; max-height: 200px; overflow-y: auto; padding: 8px; border-radius: 0.25rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .dropdown-check-list.visible .items { display: block; }
        .item-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; font-size: 0.75rem; cursor: pointer; }
        .item-row:hover { background-color: #f1f5f9; }

        /* Accordion Style */
        .accordion-item { border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px; background: white; overflow: hidden; }
        .accordion-header { padding: 12px 16px; cursor: move; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
        .accordion-header:hover { background: #f1f5f9; }
        .accordion-content { display: none; padding: 16px; border-top: 1px solid #e2e8f0; }
        .accordion-content.open { display: block; }
        .ghost { opacity: 0.5; background: #c8ebfb; }
    </style>
</head>
<body class="text-slate-800" onclick="closeDropdowns(event)">

    <!-- Header & Filters -->
    <header class="bg-white border-b sticky top-0 z-30 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-slate-800"><i class="fas fa-chart-line text-blue-600 mr-2"></i>Executive Summary</h1>
                    <p class="text-xs text-slate-500 mt-1">Operational Performance & Statistics</p>
                </div>
                
                <div class="flex flex-wrap items-center gap-2 bg-slate-50 p-2 rounded-lg border border-slate-200">
                    <!-- Date Range -->
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold text-slate-500 uppercase">Range:</span>
                        <input type="date" id="startDate" class="text-xs p-2 border rounded shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        <span class="text-slate-400">-</span>
                        <input type="date" id="endDate" class="text-xs p-2 border rounded shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>

                    <div class="h-4 w-px bg-slate-300 mx-1"></div>
                    
                    <!-- Filters -->
                    <div id="groupFilterWrapper" class="dropdown-check-list">
                        <span class="anchor" id="groupFilterAnchor" onclick="toggleDropdown(event)">Select Groups</span>
                        <ul class="items" id="groupFilterItems">
                            <!-- Items populated by JS -->
                        </ul>
                    </div>

                    <select id="schoolFilter" class="text-xs p-2 border rounded shadow-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none max-w-[150px]">
                        <option value="all">All Schools</option>
                    </select>

                    <select id="teacherFilter" class="text-xs p-2 border rounded shadow-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none max-w-[150px]">
                        <option value="all">All Teachers</option>
                    </select>

                    <button onclick="loadDashboard()" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 px-4 rounded shadow transition flex items-center gap-2">
                        <i class="fas fa-sync-alt"></i> Update
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
        
        <!-- Section 1: Score Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="card score-card flex flex-col justify-between border-l-4 border-l-blue-500">
                <div class="text-slate-500 text-xs font-bold uppercase tracking-wider">Total Classes</div>
                <div class="text-3xl font-bold mt-2 text-slate-800" id="sc-total">0</div>
                <div class="text-[10px] text-slate-400 mt-1">Selected Period</div>
            </div>
            <div class="card score-card flex flex-col justify-between border-l-4 border-l-green-500">
                <div class="text-slate-500 text-xs font-bold uppercase tracking-wider">Covered Classes</div>
                <div class="text-3xl font-bold mt-2 text-green-600" id="sc-covered">0</div>
                <div class="text-[10px] text-slate-400 mt-1">Successfully substituted</div>
            </div>
            <div class="card score-card flex flex-col justify-between border-l-4 border-l-red-500">
                <div class="text-slate-500 text-xs font-bold uppercase tracking-wider">Cancelled (BC)</div>
                <div class="text-3xl font-bold mt-2 text-red-600" id="sc-cancel-bc">0</div>
                <div class="text-[10px] text-slate-400 mt-1">Internal issues</div>
            </div>
            <div class="card score-card flex flex-col justify-between border-l-4 border-l-orange-500">
                <div class="text-slate-500 text-xs font-bold uppercase tracking-wider">Cancelled (School)</div>
                <div class="text-3xl font-bold mt-2 text-orange-600" id="sc-cancel-sch">0</div>
                <div class="text-[10px] text-slate-400 mt-1">Client requested</div>
            </div>
        </div>

        <!-- Section 2: Proportions Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Donut -->
            <div class="card lg:col-span-1 min-h-[300px]">
                <h3 class="font-bold text-slate-700 mb-4 text-sm">Overall Status Distribution</h3>
                <div class="h-[250px] flex justify-center">
                    <canvas id="chartDonut"></canvas>
                </div>
            </div>

            <!-- Stacked Bar (Group) -->
            <div class="card lg:col-span-2 min-h-[300px]">
                <h3 class="font-bold text-slate-700 mb-4 text-sm">Status by School Group</h3>
                <div class="h-[250px]">
                    <canvas id="chartStackedGroup"></canvas>
                </div>
            </div>
        </div>

        <!-- Section 3: Detailed Bar Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card min-h-[350px]">
                <h3 class="font-bold text-slate-700 mb-4 text-sm">Classes by School Group (Total Volume)</h3>
                <div class="h-[300px]">
                    <canvas id="chartBarGroup"></canvas>
                </div>
            </div>
            <div class="card min-h-[350px]">
                <h3 class="font-bold text-slate-700 mb-4 text-sm">Top 15 Schools by Volume</h3>
                <div class="h-[300px]">
                    <canvas id="chartBarSchool"></canvas>
                </div>
            </div>
        </div>

        <!-- Section 4: Time Series -->
        <div class="card">
            <h3 class="font-bold text-slate-700 mb-4 text-sm">Daily Class Volume (Time Series)</h3>
            <div class="h-[300px]">
                <canvas id="chartTimeSeries"></canvas>
            </div>
        </div>

        <!-- Section 5: Teacher Rankings -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Teaching Resp -->
            <div class="card">
                <div class="flex justify-between items-start mb-3">
                   <div>
                       <h3 class="font-bold text-slate-700 text-sm">üëë Most Active Teachers</h3>
                       <div class="text-[10px] text-slate-500 mt-1" id="teachStats">Range: 0 - 0 classes</div>
                   </div>
                   <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-500">Top 15</span>
                </div>
                <div class="overflow-y-auto max-h-[300px]">
                    <table class="w-full">
                        <tbody id="rankTeaching"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Covering -->
            <div class="card">
                <h3 class="font-bold text-slate-700 mb-3 text-sm flex items-center justify-between">
                    <span>üõ°Ô∏è Top Covering Teachers</span>
                    <span class="text-[10px] bg-green-50 px-2 py-0.5 rounded text-green-700">Top 10</span>
                </h3>
                <div class="overflow-y-auto max-h-[300px]">
                    <table class="w-full">
                        <tbody id="rankCovering"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Covered -->
            <div class="card">
                <h3 class="font-bold text-slate-700 mb-3 text-sm flex items-center justify-between">
                    <span>üìâ Most Covered Teachers</span>
                    <span class="text-[10px] bg-red-50 px-2 py-0.5 rounded text-red-700">Top 10</span>
                </h3>
                <div class="overflow-y-auto max-h-[300px]">
                    <table class="w-full">
                        <tbody id="rankCovered"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Section 7: Overall Stats Summary (Accordion) -->
         <div class="card border-blue-200 ring-4 ring-blue-50/50">
            <div class="flex flex-col mb-4">
                <div class="flex justify-between items-start">
                    <h3 class="font-bold text-blue-800 text-lg flex items-center gap-2">
                        <i class="fas fa-file-contract text-blue-600"></i> Overall Stats Summary
                    </h3>
                    <button onclick="copyReport()" class="text-[10px] bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1 rounded transition">
                        <i class="fas fa-copy mr-1"></i> Copy Text
                    </button>
                </div>
                <div class="text-sm text-slate-500 mt-1" id="reportMeta">Analyzing selected criteria...</div>
            </div>

            <!-- Global Summary Stats -->
            <div class="bg-blue-50 rounded-lg p-4 mb-6 border border-blue-100">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div class="p-2">
                        <div class="text-2xl font-bold text-blue-700" id="repTotalSessions">0</div>
                        <div class="text-xs uppercase font-bold text-blue-400 mt-1">Total Classes</div>
                    </div>
                    <div class="p-2 border-l border-blue-200">
                        <div class="text-2xl font-bold text-green-700" id="repTotalTeachers">0</div>
                        <div class="text-xs uppercase font-bold text-green-500 mt-1">Active Teachers</div>
                    </div>
                    <div class="p-2 border-l border-blue-200">
                        <div class="text-2xl font-bold text-indigo-700" id="repTotalLocal">0</div>
                        <div class="text-xs uppercase font-bold text-indigo-500 mt-1">Local Teachers</div>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-center mb-2">
                <h4 class="text-sm font-bold text-slate-700">Detailed Breakdown by School</h4>
                <div class="flex items-center gap-3">
                    <button onclick="copyReport()" class="flex items-center gap-1 text-xs bg-white px-2 py-1 rounded border border-slate-200 text-slate-600 hover:bg-slate-50 hover:text-slate-800 transition-colors shadow-sm">
                        <i class="fas fa-copy"></i>
                        <span>Copy Report</span>
                    </button>
                    <div class="text-[10px] text-slate-400 italic">Drag to reorder items</div>
                </div>
            </div>

            <!-- Sortable List Container -->
            <div id="sortableReportList" class="space-y-2">
                <!-- Items populated by JS -->
            </div>
        </div>

        <!-- Section 8: Detailed Record Table (Paginated) -->
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-slate-700 text-sm">Detailed Class Records</h3>
                <div class="flex gap-2">
                    <button onclick="changePage(-1)" id="btnPrev" class="px-3 py-1 text-xs border rounded hover:bg-slate-50 disabled:opacity-50">Prev</button>
                    <span id="pageInfo" class="text-xs self-center px-2 font-mono text-slate-500">Page 1</span>
                    <button onclick="changePage(1)" id="btnNext" class="px-3 py-1 text-xs border rounded hover:bg-slate-50 disabled:opacity-50">Next</button>
                </div>
            </div>
            
            <div class="table-container">
                <table class="w-full">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>School</th>
                            <th>Group</th>
                            <th>Class</th>
                            <th>Original Teacher</th>
                            <th>Actual Teacher</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="detailTableBody">
                        <tr><td colspan="8" class="text-center py-8 text-slate-400">Please select a date range and click Update</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- JS Logic -->
    <script>
        // --- CONFIG ---
        const SUPABASE_URL = "https://cgznmxcecljfybcgujjb.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnem5teGNlY2xqZnliY2d1ampiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2Nzc2NTI1MywiZXhwIjoyMDgzMzQxMjUzfQ.kTov9RFS-FVDNZokkslR0jFH2zaKTUYSBH9NQ8aItlQ";
        
        let sbClient = null;
        let chartInstances = {}; // Store chart objs for destruction
        let metaData = { schools: {}, users: {} }; // Cache
        
        // Pagination State
        let currentPage = 0;
        const pageSize = 50;
        let totalRecords = 0;

        // --- INIT ---
        window.onload = async () => {
             // Init Supabase
             sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
             
             // Register DataLabels
             if(window.ChartDataLabels) Chart.register(ChartDataLabels);

             // Set default dates (This Month)
             // Use local time construction to avoid UTC shift issues
             const now = new Date();
             const y = now.getFullYear();
             const m = now.getMonth();
             
             // Helper component to format YYYY-MM-DD in local time
             const toLocalISO = (d) => {
                 const offset = d.getTimezoneOffset() * 60000;
                 return new Date(d.getTime() - offset).toISOString().split('T')[0];
             };

             const firstDay = new Date(y, m, 1);
             const lastDay = new Date(y, m + 1, 0);
             
             document.getElementById('startDate').value = toLocalISO(firstDay);
             document.getElementById('endDate').value = toLocalISO(lastDay);

             // Load Metadata first
             await loadMetadata();
             
             // Initial Load
             loadDashboard();
        };

        async function loadMetadata() {
            try {
                // Fetch Schools
                const { data: schools } = await sbClient.from('dim_school').select('school_id, school_code, school_name_en, school_group');
                const groupContainer = document.getElementById('groupFilterItems');
                const groups = new Set();
                
                schools.forEach(s => {
                    const id = String(s.school_id).trim();
                    // IGNORE TRIAL SCHOOL globally as requested
                    if (s.school_group === 'Trial School') return;
                    
                    // Improved School Name Display: [CODE] Name
                    const code = s.school_code ? `[${s.school_code}] ` : '';
                    const name = s.school_name_en || 'Unknown';
                    
                    metaData.schools[id] = {
                        name: code + name,
                        code: s.school_code,
                        group: s.school_group || "Other"
                    };
                    
                    if(s.school_group) groups.add(s.school_group);
                });

                // Populate Group Filter (Checkbox)
                // Add "Select All"
                groupContainer.innerHTML = `
                    <li class="item-row font-bold border-b pb-2 mb-2">
                         <input type="checkbox" id="grp-all" checked onchange="toggleAllGroups(this)"> <label for="grp-all">Select All</label>
                    </li>
                `;
                
                Array.from(groups).sort().forEach(g => {
                    groupContainer.innerHTML += `
                        <li class="item-row">
                             <input type="checkbox" class="grp-chk" value="${g}" checked onchange="updateGroupAnchor()"> <label>${g}</label>
                        </li>
                    `;
                });
                updateGroupAnchor(); // Init Text


                // Populate School Filter
                const schoolFilter = document.getElementById('schoolFilter');
                schoolFilter.innerHTML = '<option value="all">All Schools</option>';
                 
                Object.entries(metaData.schools)
                    .sort(([,a], [,b]) => a.name.localeCompare(b.name))
                    .forEach(([id, s]) => {
                        const opt = document.createElement('option');
                        opt.value = id;
                        opt.text = s.name;
                        schoolFilter.appendChild(opt);
                    });

                // Fetch Users
                const { data: users } = await sbClient.from('dim_user').select('user_id, firstname_en, lastname_en, nickname_en, affiliation, braincloud_id').order('firstname_en');
                const teacherFilter = document.getElementById('teacherFilter');
                
                users.forEach(u => {
                    const id = String(u.user_id).trim();
                    // New Format: Firstname + Lastname (No Nickname)
                    let n = (u.firstname_en || '').trim();
                    if(u.lastname_en) n += " " + u.lastname_en.trim();
                    if(!n) n = `User ${id}`; // Fallback

                    metaData.users[id] = n;
                    metaData.userDetails = metaData.userDetails || {};
                    // Full Name Format (No Nickname, Full Lastname)
                    const fullName = n;

                    metaData.userDetails[id] = { 
                        name: fullName, 
                        affiliation: (u.affiliation || '').trim(), 
                        bcId: u.braincloud_id 
                    };

                    // Pre-index affiliation for fast lookup
                    if(u.affiliation) {
                        const aff = String(u.affiliation).trim();
                        metaData.affiliations = metaData.affiliations || {};
                        if(!metaData.affiliations[aff]) metaData.affiliations[aff] = [];
                        metaData.affiliations[aff].push(id);
                    }
                    
                    // Add to filter
                    const opt = document.createElement('option');
                    opt.value = id;
                    opt.text = n;
                    teacherFilter.appendChild(opt);
                });

            } catch(e) { console.error("Meta Error", e); }
        }

        // --- FILTER UI LOGIC ---
        function toggleDropdown(e) {
            e.stopPropagation();
            document.getElementById('groupFilterWrapper').classList.toggle('visible');
        }
        
        function closeDropdowns(e) {
            if(!e.target.closest('.dropdown-check-list')) {
                document.querySelectorAll('.dropdown-check-list').forEach(el => el.classList.remove('visible'));
            }
        }

        function toggleAllGroups(source) {
            document.querySelectorAll('.grp-chk').forEach(c => c.checked = source.checked);
            updateGroupAnchor();
        }

        function updateGroupAnchor() {
            const all = document.querySelectorAll('.grp-chk');
            const checked = document.querySelectorAll('.grp-chk:checked');
            const anchor = document.getElementById('groupFilterAnchor');
            
            if (checked.length === 0) anchor.innerText = "Select Groups";
            else if (checked.length === all.length) anchor.innerText = "All Groups";
            else anchor.innerText = `${checked.length} Groups Selected`;
        }

        function getSelectedGroups() {
            const all = document.querySelectorAll('.grp-chk');
            const checked = document.querySelectorAll('.grp-chk:checked');
            if (checked.length === all.length) return 'all';
            return Array.from(checked).map(c => c.value);
        }

        // --- MAIN LOAD ---
        async function loadDashboard() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            // Get selected groups array or 'all'
            const selectedGroups = getSelectedGroups(); 
            const teacherVal = document.getElementById('teacherFilter').value;
            const schoolVal = document.getElementById('schoolFilter').value;
            
            if(!start || !end) return alert("Please select a valid date range.");

            // FAST MODE for Dashboard: Fetch ALL data via CSV to minimize overhead
            // CSV is much smaller than JSON object array
            const btn = document.querySelector('button[onclick="loadDashboard()"]');
            if(btn) {
                var originalBtnText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-bolt fa-spin"></i> Fetching Data...`;
            }

            let rawData = [];
            
            try {
                // If the range is > 2 months, use RPC if available or CSV download
                // Here we stick to batched JSON but increase page size since we select few columns
                // supabase default limit is usually 1000, so we must be careful.
                // We'll use 1000 as chunk size to be safe and match default limits to avoid early termination
                const CHUNK_SIZE = 1000;
                let fetchMore = true;
                let page = 0;
                
                while(fetchMore) {
                    btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Loading... (${rawData.length})`;
                    
                    const { data, error } = await sbClient.from('fact_daily_session')
                        .select('date,school_id,status,actual_teacher_id,original_teacher_id') // Minimal columns
                        .gte('date', start)
                        .lte('date', end)
                        .range(page * CHUNK_SIZE, (page + 1) * CHUNK_SIZE - 1);

                    if(error) throw error;
                    
                    if(data && data.length > 0) {
                        rawData = rawData.concat(data);
                        page++;
                        // If we got fewer than requested, we are at the end
                        // If we got exactly CHUNK_SIZE, we might have more, or exactly that many.
                        // Safe to continue until 0 or < CHUNK_SIZE
                        if(data.length < CHUNK_SIZE) fetchMore = false;
                    } else {
                        fetchMore = false;
                    }
                }
            } catch(error) {
                 alert("Error loading data: " + error.message);
                 if(btn) {
                    btn.innerHTML = originalBtnText;
                    btn.disabled = false;
                 }
                 return;
            }

            // Restore Button
            if(btn) {
                btn.innerHTML = originalBtnText;
                btn.disabled = false;
            }
            
            // Client Side Filtering (allows complex logic without complex DB queries)
            let filteredData = [];

            // 1. Initial Pass: Apply School Group Filter & Metadata Existence
            rawData.forEach(r => {
                const sId = String(r.school_id).trim();
                const school = metaData.schools[sId];
                
                // Exclude if school not in metadata (e.g. Trial School filtered out or invalid ID)
                if (!school) return; 
                
                // Group Filter Logic
                if (Array.isArray(selectedGroups)) {
                    // Check if group is in selected array
                    if (!selectedGroups.includes(school.group)) return;
                }
                // If selectedGroups === 'all', pass

                // School Filter (New)
                if (schoolVal !== 'all' && sId !== schoolVal) return;

                // Teacher Filter
                if (teacherVal !== 'all') {
                    const org = String(r.original_teacher_id).trim();
                    const act = String(r.actual_teacher_id).trim();
                    if (org !== teacherVal && act !== teacherVal) return;
                }

                filteredData.push(r);
            });

            // Fetch Student Numbers (Parallel to processing to avoid UI block, but needed for render)
            let studentData = [];
            try {
                const { data: sData, error: sErr } = await sbClient
                    .from('ref_student_number_by_school')
                    .select('school, year, no_students');
                
                if(!sErr && sData) studentData = sData;
            } catch(e) { console.error("Student Data Error", e); }

            // 2. Process & Render Charts
            processAndRender(filteredData, start, end, studentData);

            // 3. Reset Pagination & Load Table (Server Side)
            currentPage = 0;
            loadTablePage(selectedGroups); // Pass group filter
        }

        function processAndRender(data, startDate, endDate, studentData) {
            // -- METRICS --
            const stats = {
                total: data.length,
                covered: 0,
                cancelBC: 0,
                cancelSch: 0,
                byGroup: {},
                bySchool: {},
                byStatusOverall: { Normal: 0, Covered: 0, CancelBC: 0, CancelSch: 0 },
                byStatusGroup: {}, // { GroupName: { Normal: 0... } }
                timeSeries: {}, // { Date: Count }
                yearly: {}, // { Year: Count }
                teachers: { teach: {}, cover: {}, covered: {} }, // Counts
                schoolDetails: {}, // { schoolId: { teacherCounts: { tid: count } } }
                totalTeachers: 0,
                totalLocalStaff: 0
            };

            // Calculate Distinct Counts Sets
            const distinctActiveTeachers = new Set();
            const distinctLocalStaff = new Set();

            // Init Time Series (Fill Zeros)
            if(startDate && endDate) {
                let curr = new Date(startDate);
                const last = new Date(endDate);
                while(curr <= last) {
                    const yyyy = curr.getFullYear();
                    const mm = String(curr.getMonth() + 1).padStart(2, '0');
                    const dd = String(curr.getDate()).padStart(2, '0');
                    stats.timeSeries[`${yyyy}-${mm}-${dd}`] = 0;
                    curr.setDate(curr.getDate() + 1);
                }
            }

            data.forEach(r => {
                const sId = String(r.school_id).trim();
                const schoolInfo = metaData.schools[sId] || { name: 'Unknown', group: 'Other' };
                const grp = schoolInfo.group;
                
                // Status Logic
                let st = "Normal";
                const rowStatus = String(r.status || "");
                if (rowStatus.startsWith("Cancelled")) {
                    if (rowStatus.includes("School")) st = "CancelSch";
                    else st = "CancelBC"; // Default to BC if unspecified or explicit BC
                } else if (rowStatus === "Substituted" || (r.original_teacher_id && r.actual_teacher_id && r.original_teacher_id !== r.actual_teacher_id)) {
                    st = "Covered";
                }

                // Global Counts
                if (st === "Covered") stats.covered++;
                if (st === "CancelBC") stats.cancelBC++;
                if (st === "CancelSch") stats.cancelSch++;
                stats.byStatusOverall[st]++;

                // Group Counts
                stats.byGroup[grp] = (stats.byGroup[grp] || 0) + 1;
                
                // School Counts
                stats.bySchool[schoolInfo.name] = (stats.bySchool[schoolInfo.name] || 0) + 1;
                
                // Track School Details (Sessions)
                // Initialize weekly breakdown if not exists
                if(!stats.schoolDetails[sId]) stats.schoolDetails[sId] = { act: {}, sess: 0, weekly: {} };
                stats.schoolDetails[sId].sess++;

                // Determine Week Key (YYYY-Www)
                // Simple ISO week logic or roughly by start date
                const dObj = new Date(r.date);
                // Get Monday of current week to group
                const day = dObj.getDay() || 7; 
                if(day !== 1) dObj.setHours(-24 * (day - 1));
                const weekKey = dObj.toISOString().split('T')[0];
                
                if(!stats.schoolDetails[sId].weekly[weekKey]) {
                    stats.schoolDetails[sId].weekly[weekKey] = { classes: 0, teachers: new Set() };
                }
                stats.schoolDetails[sId].weekly[weekKey].classes++;

                // Stacked Group Data
                if (!stats.byStatusGroup[grp]) stats.byStatusGroup[grp] = { Normal:0, Covered:0, CancelBC:0, CancelSch:0 };
                stats.byStatusGroup[grp][st]++;

                // Time Series
                if (stats.timeSeries[r.date] !== undefined) {
                    stats.timeSeries[r.date]++;
                } else if (!startDate) { 
                    // Fallback if no range passed (shouldn't happen with new logic)
                    stats.timeSeries[r.date] = (stats.timeSeries[r.date] || 0) + 1;
                }
                
                // Yearly Chart (Aggregate from fetched data)
                const yyyy = r.date.substring(0, 4);
                stats.yearly[yyyy] = (stats.yearly[yyyy] || 0) + 1;

                // Teacher Stats
                const actId = String(r.actual_teacher_id).trim();
                const orgId = String(r.original_teacher_id).trim();
                
                if (st !== "CancelBC" && st !== "CancelSch") {
                    // Teaching Count (Actual) - Only if class happened
                    if(actId) {
                        stats.teachers.teach[actId] = (stats.teachers.teach[actId] || 0) + 1;
                        
                        // School Breakdown
                        if(!stats.schoolDetails[sId]) stats.schoolDetails[sId] = { act: {}, weekly: {} };
                        stats.schoolDetails[sId].act[actId] = (stats.schoolDetails[sId].act[actId] || 0) + 1;
                        
                        // Add to weekly set for distinct AVG calc - use weekKey from parent scope
                        if(stats.schoolDetails[sId].weekly[weekKey]) {
                           stats.schoolDetails[sId].weekly[weekKey].teachers.add(actId);
                        } else {
                           // Logic above handles session increment. This block is inside 'if(actId)'
                           if(!stats.schoolDetails[sId].weekly) stats.schoolDetails[sId].weekly = {};
                           stats.schoolDetails[sId].weekly[weekKey] = { classes: 0, teachers: new Set([actId]) };
                        }

                        // Add to set
                        distinctActiveTeachers.add(actId);
                    }
                    
                    if (st === "Covered") {
                         // Covering (Actual did the cover)
                         if(actId) stats.teachers.cover[actId] = (stats.teachers.cover[actId] || 0) + 1;
                         // Covered (Original was covered)
                         if(orgId) stats.teachers.covered[orgId] = (stats.teachers.covered[orgId] || 0) + 1;
                    }
                }
            });

            // Count local staff for each school present in data
            Object.keys(stats.bySchool).forEach(schoolName => {
                // Find ID by Name (inefficient, need reverse lookup or pass filtering better)
                // Filter metaData.schools where name matches
                const sEntry = Object.entries(metaData.schools).find(([id, val]) => val.name === schoolName);
                if(sEntry) {
                    const code = sEntry[1].code;
                    if(code) {
                        const locals = metaData.affiliations[code] || [];
                        locals.forEach(lid => distinctLocalStaff.add(lid));
                    }
                }
            });

            stats.totalTeachers = distinctActiveTeachers.size;
            stats.totalLocalStaff = distinctLocalStaff.size;

            // -- SCORECARDS --
            document.getElementById('sc-total').innerText = stats.total.toLocaleString();
            document.getElementById('sc-covered').innerText = stats.covered.toLocaleString();
            // document.getElementById('sc-covered').parentElement.title = `Rate: ${((stats.covered/stats.total)*100).toFixed(1)}%`;
            document.getElementById('sc-cancel-bc').innerText = stats.cancelBC.toLocaleString();
            document.getElementById('sc-cancel-sch').innerText = stats.cancelSch.toLocaleString();
            
            // -- STATS MIN/MAX --
            const teachingCounts = Object.values(stats.teachers.teach);
            if(teachingCounts.length > 0) {
                const max = Math.max(...teachingCounts);
                const min = Math.min(...teachingCounts);
                document.getElementById('teachStats').innerText = `Range: ${min} - ${max} classes per teacher (Avg: ${(stats.total / teachingCounts.length).toFixed(1)})`;
            } else {
                document.getElementById('teachStats').innerText = `Range: 0 - 0 classes`;
            }

            // -- CHARTS --
            renderDonut(stats.byStatusOverall);
            renderStackedBar(stats.byStatusGroup);
            renderBarGroup(stats.byGroup);
            renderBarSchool(stats.bySchool);
            renderTimeSeries(stats.timeSeries);
            
            // -- RANKINGS --
            renderRanking('rankTeaching', stats.teachers.teach, 15);
            renderRanking('rankCovering', stats.teachers.cover, 10);
            renderRanking('rankCovered', stats.teachers.covered, 10);

            // -- SCHOOL ANALYSIS --
            // renderSchoolAnalysis(stats.schoolDetails, stats.totalTeachers, stats.totalLocalStaff); // Removed as redundant
            renderManagerReport(stats.schoolDetails, stats.total, stats.totalTeachers, stats.totalLocalStaff, startDate, endDate, stats.yearly, studentData);
        }

        function renderSchoolAnalyticsCharts(data, yearlyData, studentData) {
            // Find or create container (inserted before the detailed list card)
            let wrapper = document.getElementById('schoolAnalyticsWrapper');
            const listCard = document.getElementById('sortableReportList').closest('.card');
            
            if(!wrapper) {
                wrapper = document.createElement('div');
                wrapper.id = 'schoolAnalyticsWrapper';
                wrapper.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8';
                
                // Card 1
                const c1 = document.createElement('div');
                c1.className = 'card';
                c1.innerHTML = `
                   <h3 class="font-bold text-slate-700 mb-4 text-sm flex justify-between">
                       <span>Average Classes / Week</span>
                       <span class="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-1 rounded">Active Weeks Only</span>
                   </h3>
                   <div class="h-[300px]"><canvas id="chartAvgClass"></canvas></div>
                `;
                
                // Card 2
                const c2 = document.createElement('div');
                c2.className = 'card';
                c2.innerHTML = `
                   <h3 class="font-bold text-slate-700 mb-4 text-sm flex justify-between">
                       <span>Average Teachers / Week</span>
                       <span class="text-[10px] bg-amber-50 text-amber-600 px-2 py-1 rounded">Active Weeks Only</span>
                   </h3>
                   <div class="h-[300px]"><canvas id="chartAvgTeach"></canvas></div>
                `;

                // Card 3
                const c3 = document.createElement('div');
                c3.className = 'card';
                c3.innerHTML = `
                   <h3 class="font-bold text-slate-700 mb-4 text-sm flex justify-between">
                       <span>Projected Yearly Volume</span>
                       <span class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded">Based on ~40 Week Academic Year</span>
                   </h3>
                   <div class="h-[300px]"><canvas id="chartProjYear"></canvas></div>
                `;
                
                // Card 4: Historical Yearly
                const c4 = document.createElement('div');
                c4.className = 'card';
                c4.innerHTML = `
                   <h3 class="font-bold text-slate-700 mb-4 text-sm flex justify-between">
                       <span>Historical Yearly Volume</span>
                       <span class="text-[10px] bg-purple-50 text-purple-600 px-2 py-1 rounded">Based on Selected Date Range</span>
                   </h3>
                   <div class="h-[300px]"><canvas id="chartYearlyVol"></canvas></div>
                `;

                // Card 5: Student Numbers
                const c5 = document.createElement('div');
                c5.className = 'card lg:col-span-2';
                c5.innerHTML = `
                   <h3 class="font-bold text-slate-700 mb-4 text-sm flex justify-between">
                        <span>Student Enrollment by School</span>
                        <span class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-1 rounded">From Registry</span>
                   </h3>
                   <div class="h-[300px]"><canvas id="chartStudentNum"></canvas></div>
                `;

                wrapper.appendChild(c1);
                wrapper.appendChild(c2);
                wrapper.appendChild(c3);
                wrapper.appendChild(c4);
                wrapper.appendChild(c5);
                
                listCard.parentNode.insertBefore(wrapper, listCard);
            }

            // Prepare Data (Sort Descending by Avg Class)
            const sorted = [...data].sort((a,b) => b.avgClass - a.avgClass);
            const labels = sorted.map(d => d.name);
            const vClass = sorted.map(d => d.avgClass);
            const vTeach = sorted.map(d => d.avgTeach);
            const vProj = sorted.map(d => d.projYear);
            
            // Prepare Yearly
            const years = Object.keys(yearlyData || {}).sort();
            const yearVals = years.map(y => yearlyData[y]);

            // Prepare Student Data
            const activeSchoolCodes = new Set();
            sorted.forEach(item => {
                const sId = Object.keys(metaData.schools).find(k => metaData.schools[k].name === item.name);
                if(sId && metaData.schools[sId].code) {
                    activeSchoolCodes.add(metaData.schools[sId].code);
                }
            });

            // Flatten Student Data to match charts order
            const studentGrouping = {};
            const allStudentYears = new Set();
            
            (studentData || []).forEach(sd => {
                // Determine School Name from Code
                // We need to reverse lookup the code to get the Name that matches 'labels'
                // This is slightly inefficient but safe
                const sId = Object.keys(metaData.schools).find(k => metaData.schools[k].code === sd.school);
                if(!sId) return; // School code not found in metadata
                
                const sName = metaData.schools[sId].name;
                
                // Only include if this school is in the current report (sorted list)
                if(!labels.includes(sName)) return;

                if(!studentGrouping[sName]) studentGrouping[sName] = {};
                const year = String(sd.year || 'Unknown').substring(0,4);
                studentGrouping[sName][year] = sd.no_students;
                allStudentYears.add(year);
            });

            const studentYearsSorted = Array.from(allStudentYears).sort();
            
            const studentDatasets = studentYearsSorted.map((yr, idx) => {
                const colorPalette = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'];
                return {
                    label: yr,
                    data: labels.map(l => studentGrouping[l] ? (studentGrouping[l][yr] || 0) : 0),
                    backgroundColor: colorPalette[idx % colorPalette.length],
                    borderRadius: 4
                };
            });
            
            // Destroy Old
            if(chartInstances.avgClass) chartInstances.avgClass.destroy();
            if(chartInstances.avgTeach) chartInstances.avgTeach.destroy();
            if(chartInstances.projYear) chartInstances.projYear.destroy();
            if(chartInstances.yearlyVol) chartInstances.yearlyVol.destroy();
            if(chartInstances.studentNum) chartInstances.studentNum.destroy();

            const commonOpts = {
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { 
                    legend: { display: false },
                    datalabels: {
                        color: '#0f172a', // Slate-900 (High Contrast)
                        anchor: 'end',
                        align: 'end',
                        offset: 4,
                        font: { weight: 'bold', size: 10 },
                        formatter: (val) => val === 0 ? '' : val.toLocaleString()
                    }
                }, 
                scales: { x: { beginAtZero: true } },
                layout: { padding: { right: 50 } } // Added more space for labels
            };

            // Chart 1
            chartInstances.avgClass = new Chart(document.getElementById('chartAvgClass'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Avg Classes', data: vClass, backgroundColor: '#10b981', borderRadius: 4 }]
                },
                options: commonOpts
            });

            // Chart 2
            chartInstances.avgTeach = new Chart(document.getElementById('chartAvgTeach'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Avg Teachers', data: vTeach, backgroundColor: '#f59e0b', borderRadius: 4 }]
                },
                options: commonOpts
            });

            // Chart 3
            chartInstances.projYear = new Chart(document.getElementById('chartProjYear'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Projected Year', data: vProj, backgroundColor: '#3b82f6', borderRadius: 4 }]
                },
                options: commonOpts
            });
            
            // Chart 4 (Yearly Volume)
            const yearlyOpts = {
                maintainAspectRatio: false,
                indexAxis: 'x', // Vertical Bars for Time Series
                plugins: { 
                    legend: { display: false },
                    datalabels: {
                        color: '#0f172a', // High Contrast
                        anchor: 'end',
                        align: 'top',
                        offset: -20, // Inside the bar if possible, or top
                        align: 'end', // Actually stick to 'end' for above
                        offset: 0,
                        font: { weight: 'bold', size: 10 },
                        formatter: (val) => val === 0 ? '' : val.toLocaleString()
                    }
                }, 
                scales: { 
                    y: { beginAtZero: true, grid: { borderDash: [2, 2] } },
                    x: { grid: { display: false } }
                },
                layout: { padding: { top: 20 } }
            };

            chartInstances.yearlyVol = new Chart(document.getElementById('chartYearlyVol'), {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [{ label: 'Total Classes', data: yearVals, backgroundColor: '#8b5cf6', borderRadius: 4 }]
                },
                options: yearlyOpts
            });

             // Chart 5 (Students)
             chartInstances.studentNum = new Chart(document.getElementById('chartStudentNum'), {
                type: 'bar',
                data: {
                    labels: labels, // Use same school order
                    datasets: studentDatasets
                },
                options: {
                    maintainAspectRatio: false,
                    indexAxis: 'x', // Vertical bars (School on X axis)
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 10, font: {size: 10} } },
                        datalabels: {
                            rotation: -90, align: 'top', anchor: 'end',
                            offset: -4, color: '#0f172a',
                            font: {size: 10, weight:'bold'},
                            formatter: (val) => val > 0 ? val.toLocaleString() : ''
                        }
                    },
                    scales: { 
                        y: { beginAtZero: true },
                        x: { grid: { display: false }, ticks: { maxRotation: 90, minRotation: 45, font: {size: 10} } }
                    },
                    layout: { padding: { top: 20 } }
                }
            });
        }

        function renderManagerReport(data, totalSess, totalTeach, totalLoc, start, end, yearlyData, studentData) {
            // Update Report Meta
            const groups = getSelectedGroups();
            const groupText = groups === 'all' ? 'All School Groups' : groups.join(', ');
            const dateText = `${new Date(start).toLocaleDateString('en-GB')} - ${new Date(end).toLocaleDateString('en-GB')}`;
            document.getElementById('reportMeta').innerHTML = `
                <span class="font-bold text-slate-700">${groupText}</span> ‚Ä¢ <span class="text-slate-500">${dateText}</span>
            `;

            document.getElementById('repTotalSessions').innerText = totalSess.toLocaleString();
            document.getElementById('repTotalTeachers').innerText = totalTeach.toLocaleString();
            document.getElementById('repTotalLocal').innerText = totalLoc.toLocaleString();

            const container = document.getElementById('sortableReportList');
            container.innerHTML = '';

            const schoolIds = Object.keys(data).sort((a,b) => (metaData.schools[a]?.name || '').localeCompare(metaData.schools[b]?.name || ''));

            if(schoolIds.length === 0) {
                 container.innerHTML = '<div class="text-center text-slate-400 py-4 italic">No data available to report</div>';
                 return;
            }

            let analyticsData = [];
            schoolIds.forEach(sId => {
                const school = metaData.schools[sId] || { name: 'Unknown', code: '' };
                const activeTeachers = data[sId].act || {};
                
                // Active Card Set
                const activeCards = Object.entries(activeTeachers)
                    .sort((a,b) => b[1] - a[1])
                    .map(([tid, count]) => {
                        const name = metaData.userDetails[tid]?.name || `ID:${tid}`;
                        return `<div class="bg-green-50 text-green-800 text-xs px-2 py-1 rounded border border-green-100 flex justify-between">
                            <span>${name}</span>
                            <span class="font-bold bg-white text-green-600 px-1 rounded ml-2">${count}</span>
                        </div>`;
                    }).join('');

                // Local List
                const code = school.code;
                const localIds = metaData.affiliations[code] || [];
                const localList = localIds.length > 0 ? localIds
                    .sort((a,b) => (metaData.userDetails[a]?.bcId || 0) - (metaData.userDetails[b]?.bcId || 0))
                    .map(tid => {
                        const u = metaData.userDetails[tid];
                        return `<li class="ml-4 list-disc marker:text-slate-400">${u.name} <span class="text-slate-400 text-[10px] ml-1">#${u.bcId}</span></li>`;
                    }).join('') : '<li class="text-slate-400 italic list-none">No local staff registered</li>';

                const distinctActive = Object.keys(activeTeachers).length;
                const distinctLocal = localIds.length;
                const totalSessions = data[sId].sess || 0;

                // --- NEW STATS CALC ---
                const weeks = Object.values(data[sId].weekly || {});
                
                // Dynamic Threshold: If max weekly classes < 20, use 0 as threshold (count all weeks with data)
                // If max > 20, filtering low-activity weeks (holidays/exams) helps accuracy.
                // Let's use a simpler heuristic: Filter out weeks with < 10% of the max weekly volume seen for that school.
                // This removes holidays without excluding small schools.
                const maxWeekVol = Math.max(...weeks.map(w => w.classes), 0);
                const threshold = Math.max(5, maxWeekVol * 0.2); // At least 5 classes, or 20% of peak

                const activeWeeks = weeks.filter(w => w.classes >= threshold);

                const avgClassesPerWeek = activeWeeks.length > 0 
                     ? (activeWeeks.reduce((acc, curr) => acc + curr.classes, 0) / activeWeeks.length) 
                     : 0;
                
                // For teachers, average over active weeks or all? User said "we need for each school"
                // Assuming capacity planning based on active weeks is safer.
                const avgTeachersPerWeek = activeWeeks.length > 0
                     ? (activeWeeks.reduce((acc, curr) => acc + curr.teachers.size, 0) / activeWeeks.length)
                     : 0;
                
                // If avgClasses > 0, calculate yearly projection (Avg * ~36 weeks or just Avg?)
                // User asked "classes per week/year". Let's show both if feasible or Avg/Week and Projected Year.
                // Standard academic year is often ~36-40 weeks. Let's stick to Avg/Week as base truth.
                const estYearly = avgClassesPerWeek * 40; // Approx academic year
                
                // Track for Charts
                analyticsData.push({
                    name: school.name,
                    avgClass: Math.round(avgClassesPerWeek),
                    avgTeach: parseFloat(avgTeachersPerWeek.toFixed(1)),
                    projYear: Math.round(estYearly)
                });
                
                // Display text for active weeks context
                const activeWeekText = `${activeWeeks.length} active wks (>${Math.round(threshold)} cls)`;

                // Create Accordion Item
                const item = document.createElement('div');
                item.className = 'accordion-item group';
                item.innerHTML = `
                    <div class="accordion-header" onclick="this.nextElementSibling.classList.toggle('open'); this.querySelector('.fa-chevron-down').classList.toggle('rotate-180')">
                        <div class="flex items-center gap-3 w-full">
                            <i class="fas fa-grip-vertical text-slate-300 cursor-move group-hover:text-slate-500"></i>
                            <div class="flex-grow">
                                <div class="font-bold text-sm text-slate-700 flex justify-between items-center pr-4">
                                    <span>${school.name}</span>
                                    <span class="text-[10px] text-slate-400 font-normal" title="Count of weeks with classes > 20% of peak">${activeWeekText}</span>
                                </div>
                                <div class="text-[10px] text-slate-500 mt-1 flex flex-wrap gap-2">
                                    <span class="bg-blue-50 px-1.5 py-0.5 rounded text-blue-600 font-bold" title="Total in selection">${totalSessions.toLocaleString()} Total</span>
                                    <span class="bg-emerald-50 px-1.5 py-0.5 rounded text-emerald-600 font-bold" title="Avg classes in active weeks">~${Math.round(avgClassesPerWeek)} Cls/Wk</span>
                                    <span class="bg-amber-50 px-1.5 py-0.5 rounded text-amber-600 font-bold" title="Avg unique teachers in active weeks">~${avgTeachersPerWeek.toFixed(1)} Avg Tch/Wk</span>
                                    <span class="bg-slate-100 px-1.5 py-0.5 rounded text-slate-600 font-bold ml-1">${distinctActive} T.Total</span>
                                    <span class="bg-indigo-50 px-1.5 py-0.5 rounded text-indigo-600 font-bold ml-1">${distinctLocal} L.Total</span>
                                </div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-down text-slate-400 transition-transform duration-200 ml-2"></i>
                    </div>
                    <div class="accordion-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-4">
                            <div>
                                <h5 class="text-xs font-bold text-green-700 uppercase mb-2 border-b border-green-100 pb-1">
                                    <i class="fas fa-chalkboard-teacher mr-1"></i> Responsible Teachers (${distinctActive})
                                </h5>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-[200px] overflow-y-auto pr-1 custom-scrollbar">
                                    ${activeCards}
                                </div>
                            </div>
                            <div>
                                <h5 class="text-xs font-bold text-indigo-700 uppercase mb-2 border-b border-indigo-100 pb-1">
                                    <i class="fas fa-users mr-1"></i> Local Teachers (${distinctLocal})
                                </h5>
                                <ul class="text-xs text-slate-600 space-y-1 max-h-[200px] overflow-y-auto pr-1 custom-scrollbar">
                                    ${localList}
                                </ul>
                            </div>
                        </div>
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
            
            // -- RENDER NEW ANALYTICS CHARTS --
            renderSchoolAnalyticsCharts(analyticsData, yearlyData, studentData);
            
             // Sortable Init
            if(!window.sortableInstance) {
                window.sortableInstance = new Sortable(container, {
                    animation: 150,
                    handle: '.accordion-header', // drag handle
                    ghostClass: 'bg-blue-50'
                });
            }
        }

        function copyReport() {
            const container = document.getElementById('sortableReportList');
            const items = container.querySelectorAll('.accordion-item');
            let text = `Executive Summary Report\n${document.getElementById('reportMeta').innerText}\n\n`;
            
            items.forEach(item => {
                const header = item.querySelector('.accordion-header');
                const title = header.querySelector('.font-bold').innerText;
                const stats = header.querySelector('.text-\\[10px\\]').innerText; // Teachers / Locals
                
                text += `## ${title}\n   ${stats.replace(/\n/g, ' ')}\n`;
                
                // Get details
                const content = item.querySelector('.accordion-content');
                // Simplifying for clipboard - maybe just list names?
                // Let's grab the names from the rendered HTML if possible or simpler just the counts
                // For a manager report, usually summaries are better.
                // Let's include the teacher names.
                
                const teachers = [];
                item.querySelectorAll('.accordion-content div.bg-green-50 span:first-child').forEach(s => teachers.push(s.innerText));
                if(teachers.length > 0) text += `   Teachers: ${teachers.join(', ')}\n`;
                
                text += '\n';
            });
            
            navigator.clipboard.writeText(text).then(() => {
                alert('Report copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Failed to copy report.');
            });
        }

        // --- CHART RENDERING HELPERS ---
        function renderDonut(data) {
            const ctx = document.getElementById('chartDonut').getContext('2d');
            if(chartInstances.donut) chartInstances.donut.destroy();
            
            chartInstances.donut = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Normal', 'Covered', 'Cancel (BC)', 'Cancel (Sch)'],
                    datasets: [{
                        data: [data.Normal, data.Covered, data.CancelBC, data.CancelSch],
                        backgroundColor: ['#e2e8f0', '#22c55e', '#ef4444', '#f97316'],
                        borderWidth: 0
                    }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: {size: 10} } } } }
            });
        }

        function renderStackedBar(groupData) {
            const ctx = document.getElementById('chartStackedGroup').getContext('2d');
            if(chartInstances.stacked) chartInstances.stacked.destroy();
            
            const labels = Object.keys(groupData).sort();
            const datasetNormal = labels.map(l => groupData[l].Normal);
            const datasetCover = labels.map(l => groupData[l].Covered);
            const datasetCBC = labels.map(l => groupData[l].CancelBC);
            const datasetCSch = labels.map(l => groupData[l].CancelSch);

            chartInstances.stacked = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Normal', data: datasetNormal, backgroundColor: '#e2e8f0', stack: 'Stack 0' },
                        { label: 'Covered', data: datasetCover, backgroundColor: '#22c55e', stack: 'Stack 0' },
                        { label: 'Cancel (BC)', data: datasetCBC, backgroundColor: '#ef4444', stack: 'Stack 0' },
                        { label: 'Cancel (Sch)', data: datasetCSch, backgroundColor: '#f97316', stack: 'Stack 0' },
                    ]
                },
                options: { 
                    maintainAspectRatio: false, 
                    scales: { x: { stacked: true }, y: { stacked: true } },
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 10 } } }
                }
            });
        }

        function renderBarGroup(data) {
            const ctx = document.getElementById('chartBarGroup').getContext('2d');
            if(chartInstances.barGroup) chartInstances.barGroup.destroy();
            
            // Sort by Value
            const sorted = Object.entries(data).sort((a,b) => b[1] - a[1]);
            
            chartInstances.barGroup = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(x => x[0]),
                    datasets: [{
                        label: 'Classes',
                        data: sorted.map(x => x[1]),
                        backgroundColor: '#3b82f6',
                        borderRadius: 4
                    }]
                },
                options: { maintainAspectRatio: false, indexAxis: 'y' }
            });
        }
        
        function renderBarSchool(data) {
            const ctx = document.getElementById('chartBarSchool').getContext('2d');
            if(chartInstances.barSchool) chartInstances.barSchool.destroy();
            
            // Top 15
            const sorted = Object.entries(data).sort((a,b) => b[1] - a[1]).slice(0, 15);
            
            chartInstances.barSchool = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(x => x[0]),
                    datasets: [{
                        label: 'Classes',
                        data: sorted.map(x => x[1]),
                        backgroundColor: '#6366f1',
                        borderRadius: 4
                    }]
                },
                options: { maintainAspectRatio: false, indexAxis: 'y' }
            });
        }

        function renderTimeSeries(dailyData) {
            const ctx = document.getElementById('chartTimeSeries').getContext('2d');
            if(chartInstances.timeSeries) chartInstances.timeSeries.destroy();
            
            // Determine Aggregation Level
            const days = Object.keys(dailyData).length;
            let aggType = 'Day';
            let aggData = {};
            
            if (days > 730) aggType = 'Month'; // > 2 Years
            else if (days > 90) aggType = 'Week'; // > 3 Months

            // Aggregation Logic
            const sortedDates = Object.keys(dailyData).sort();
            
            sortedDates.forEach(dateStr => {
                const val = dailyData[dateStr];
                const d = new Date(dateStr);
                let key = dateStr;
                
                if(aggType === 'Month') {
                    // key = "YYYY-MM"
                    key = dateStr.substring(0, 7); 
                } else if (aggType === 'Week') {
                    // key = "Min-Date-Of-Week"
                    // Get Monday
                    const day = d.getDay() || 7; 
                    if(day !== 1) d.setHours(-24 * (day - 1));
                    key = d.toISOString().split('T')[0];
                }
                
                aggData[key] = (aggData[key] || 0) + val;
            });

            const aggLabels = Object.keys(aggData).sort();
            const aggValues = aggLabels.map(k => aggData[k]);
            
            // Nice Formatting for Display
            const displayLabels = aggLabels.map(k => {
                if(aggType === 'Month') {
                    const [y, m] = k.split('-');
                    return new Date(y, m-1).toLocaleDateString('en-GB', { month: 'short', year: 'numeric' });
                } else if (aggType === 'Week') {
                    const parts = k.split('-');
                    const d = new Date(parts[0], parts[1]-1, parts[2]);
                    return `Week of ${d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}`;
                } else {
                    const parts = k.split('-');
                    const d = new Date(parts[0], parts[1]-1, parts[2]);
                    return d.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
                }
            });

            chartInstances.timeSeries = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: displayLabels,
                    datasets: [{
                        label: aggType === 'Day' ? 'Daily Sessions' : `${aggType}ly Sessions`,
                        data: aggValues,
                        borderColor: '#0ea5e9',
                        backgroundColor: 'rgba(14, 165, 233, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: aggType === 'Day' ? 3 : 4,
                        pointHoverRadius: 6
                    }]
                },
                options: { 
                    maintainAspectRatio: false, 
                    scales: { y: { beginAtZero: true } },
                    interaction: {
                        mode: 'index',
                        intersect: false, 
                    },
                    plugins: {
                        datalabels: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return context[0].label; 
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderRanking(elId, data, topN) {
            const tbody = document.getElementById(elId);
            tbody.innerHTML = '';
            
            // Sort
            const sorted = Object.entries(data).sort((a,b) => b[1] - a[1]).slice(0, topN);
            
            if(sorted.length === 0) {
                 tbody.innerHTML = '<tr><td class="text-xs text-slate-400 text-center">No data</td></tr>';
                 return;
            }

            sorted.forEach(([id, count], idx) => {
                const name = metaData.users[id] || `Unknown (${id})`;
                const rank = idx + 1;
                let medal = rank;
                if(rank === 1) medal = 'ü•á';
                if(rank === 2) medal = 'ü•à';
                if(rank === 3) medal = 'ü•â';
                
                tbody.innerHTML += `
                    <tr class="text-xs">
                        <td class="w-8 font-bold text-center">${medal}</td>
                        <td>${name}</td>
                        <td class="text-right font-bold text-slate-600">${count}</td>
                    </tr>
                `;
            });
        }

        // --- TABLE PAGINATION ---
        async function loadTablePage(selectedGroups) {
            const tbody = document.getElementById('detailTableBody');
            const pageInfo = document.getElementById('pageInfo');
            const btnPrev = document.getElementById('btnPrev');
            const btnNext = document.getElementById('btnNext');
            
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4"><div class="loader mx-auto"></div></td></tr>';
            
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const teacherVal = document.getElementById('teacherFilter').value;
            const schoolVal = document.getElementById('schoolFilter').value;
            
            // Re-fetch logic for group (using default 'all' if not passed from param to avoid breaking initial call)
            if(!selectedGroups) selectedGroups = getSelectedGroups();

            const rangeStart = currentPage * pageSize;
            const rangeEnd = rangeStart + pageSize - 1;

            // Start building Query
            let query = sbClient.from('fact_daily_session')
                .select('*, dim_school!inner(school_group)', { count: 'exact' })
                .gte('date', start)
                .lte('date', end)
                .order('date', { ascending: false })
                .order('start_time', { ascending: true })
                .range(rangeStart, rangeEnd);
            
            // Apply Group Filter (Multi-select)
            // Supabase 'in' query
            if (Array.isArray(selectedGroups) && selectedGroups.length > 0) {
                 query = query.in('dim_school.school_group', selectedGroups);
            }
            // If selectedGroups === 'all', no filter needed
            // NOTE: If we ignore 'Trial School' globally, we must explicitly exclude it here too if 'all' is selected
            if (selectedGroups === 'all') {
                query = query.neq('dim_school.school_group', 'Trial School');
            }

            // Apply School Filter
            if (schoolVal !== 'all') {
                query = query.eq('school_id', schoolVal);
            }

            // Apply Teacher Filter
            if (teacherVal !== 'all') {
                // Must explicitly prevent SQL injection-like syntax errors in OR string, though SDK handles escaping usually.
                // Syntax: .or('col1.eq.val,col2.eq.val')
                query = query.or(`original_teacher_id.eq.${teacherVal},actual_teacher_id.eq.${teacherVal}`);
            }

            const { data, count, error } = await query;
            
            if(error) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-red-500">Error: ${error.message}</td></tr>`;
                return;
            }

            totalRecords = count;
            tbody.innerHTML = '';
            
            if(data.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-slate-400">No records found</td></tr>';
                 return;
            }

            data.forEach(r => {
                const sId = String(r.school_id).trim();
                const school = metaData.schools[sId] || { name: 'Unknown', group: '' };
                const orgT = metaData.users[String(r.original_teacher_id).trim()] || '-';
                const actT = metaData.users[String(r.actual_teacher_id).trim()] || '-';
                
                // Status Color
                let stBadge = `<span class="px-2 py-0.5 rounded-full text-[10px] bg-slate-100 text-slate-600">${r.status || 'Normal'}</span>`;
                if((r.status||'').includes('Cancel')) stBadge = `<span class="px-2 py-0.5 rounded-full text-[10px] bg-red-100 text-red-600">${r.status}</span>`;
                else if(r.status === 'Substituted' || (r.original_teacher_id !== r.actual_teacher_id && r.actual_teacher_id)) stBadge = `<span class="px-2 py-0.5 rounded-full text-[10px] bg-green-100 text-green-600">Covered</span>`;

                tbody.innerHTML += `
                    <tr>
                        <td class="whitespace-nowrap">${r.date}</td>
                        <td class="whitespace-nowrap">${(r.start_time||'').substring(0,5)} - ${(r.end_time||'').substring(0,5)}</td>
                        <td>${school.name}</td>
                        <td>${school.group}</td>
                        <td>${r.class_name}</td>
                        <td>${orgT}</td>
                        <td>${actT}</td>
                        <td>${stBadge}</td>
                    </tr>
                `;
            });

            // Update Controls
            const totalPages = Math.ceil(totalRecords / pageSize);
            pageInfo.innerText = `Page ${currentPage + 1} of ${totalPages || 1} (${totalRecords} items)`;
            
            btnPrev.disabled = currentPage === 0;
            btnNext.disabled = currentPage >= totalPages - 1;
        }

        function changePage(delta) {
            currentPage += delta;
            if(currentPage < 0) currentPage = 0;
            loadTablePage();
        }

    </script>
</body>
</html>